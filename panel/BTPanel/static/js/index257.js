import{u as a,l as e,H as t,G as s,o as l,M as i,ah as n,J as r,k as o,e as u}from"./utils-lib.js?v=1734676359";import{s as c,g as d,r as m,h as p,e as _,a_ as g,c as y,k as v,l as h,q as f,p as b,v as w,y as P,x as T,I as S,aX as k,F as I,A as F}from"./base-lib.js?v=1734676359";import{t as x,k as O,v as j,w as L,x as q,y as D,z as N,A,B as E,C as B,D as C,E as J}from"./useStore5.js?v=1734676359";import{u as R}from"./column.js?v=1734676359";import{p as V}from"./validator.js?v=1734676359";const z=d("FTP_LOGS_ANALYSIS",(()=>{const a=m(),e=m({scanStatus:!1,autoScanText:"定时自动扫描",btn:"立即扫描",data:[]}),t=m({login_error:!0,time:!0,area:!0,anonymous:!0,upload_shell:!0,day:7,otherDay:1,user:"all",userList:[],cycle:1,channel:[],option:{},config:{login_error:5,time:{start_time:0,end_time:24},area:{country:[],city:[]},upload_shell:[],login_error_des:"超过5次",time_des:"0点至24点范围外",area_des:"非地区",upload_shell_des:"未配置"},search:"",status:!0}),s=m([]),l=m(null),i=m([]),n=m(),r=m(!1),o=m(),u=m([]);return{ftpAnalysisList:e,ftpScanTable:a,ruleForm:t,whiteTableData:i,ip:n,setScanInfo:l,addFtpInfo:m(),isAutoScan:o,userOptions:u,isLoading:r,areaOptions:s}})),G=()=>c(z()),{payment:M}=a(),{ftpAnalysisList:W,ruleForm:H,whiteTableData:X,ip:Y,setScanInfo:$,addFtpInfo:K,isAutoScan:Q,userOptions:U,isLoading:Z,areaOptions:aa}=G(),ea=async(a={search:H.value.search,day:"other"===H.value.day?Number(H.value.otherDay):Number(H.value.day),user:"all"===H.value.user?"[]":JSON.stringify(H.value.userList)})=>{try{const e=await N(a);if(e.status){W.value.data=[];for(const a in e.data){const t=e.data[a];W.value.data.push({time:t.exec_time,type:t.type,user:t.user,ip:a,id:t.id})}}}catch(e){n(e)}},ta=()=>{W.value={scanStatus:!1,autoScanText:"定时自动扫描",btn:"立即扫描",data:[]},H.value={login_error:!0,time:!0,area:!0,anonymous:!0,upload_shell:!0,day:7,otherDay:1,user:"all",userList:[],cycle:1,channel:[],option:{},config:{login_error:5,time:{start_time:0,end_time:24},area:{country:[],city:[]},upload_shell:[],login_error_des:"超过5次",time_des:"0点至24点范围外",area_des:"非地区",upload_shell_des:"未配置"},search:"",status:!0}},sa=p({login_error:[{validator:(a,e,t)=>{e>0?t():t("请输入大于0的整数")},trigger:["change"]}],se_time:[{validator:(a,e,t)=>{H.value.config.start_time&&H.value.config.end_time?t():t("开始时间和结束时间不能为空")},trigger:["blur"]}]}),la=a=>{H.value.config.start_time=a},ia=a=>{H.value.config.end_time=a},na=async a=>{await $.value.validate();const e=((a=H.value.config)=>({time:JSON.stringify({start_time:Number(a.start_time.split(":")[0]),end_time:Number(a.end_time.split(":")[0])}),area:JSON.stringify({country:a.area.country,city:[]}),upload_shell:JSON.stringify(a.upload_shell_br.split("\n")),login_error:a.login_error}))();(await s({loading:"正在提交中数据，请稍候...",request:B(e),message:!0})).status&&(ma(),a&&a())},ra=[{label:"IP",render:a=>_("span",null,[a])},R([{onClick:async a=>{(await s({loading:"正在删除白名单IP，请稍后...",request:D({ip:a,type:"del"}),data:{status:Boolean},message:!0})).status&&(ua(),ea())},title:"删除"}])],oa=async(a={ip:Y.value,type:"add"})=>{a.ip?/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/.test(a.ip)?await s({loading:"正在添加白名单IP，请稍后...",request:D(a),data:{status:Boolean},message:!0,success:a=>{a.status&&(Y.value="",ua(),ea())}}):i.error("请输入正确的ip地址"):i.error("请输入ip地址")},ua=async()=>{await s({loading:"正在获取白名单列表，请稍后...",request:A(),data:{ip:[Array,X]}})},ca=g({otherDay:[{validator:(a,e,t)=>{"other"===H.value.day&&(e<1||!Number.isInteger(parseFloat(e)))?t(new Error("天数必须大于0的整数")):t()},trigger:["change"]}],userList:[{validator:(a,e,t)=>{"other"===H.value.user&&0===e.length?t("请选择指定用户"):t()},trigger:["change"]}],risk:[{validator:(a,e,t)=>{H.value.login_error||H.value.time||H.value.area||H.value.anonymous||H.value.upload_shell?t():t("请至少选择一个安全风险")},trigger:["change"]}],cycle:[{required:!0,message:"请输入周期",trigger:"blur"},{validator:(a,e,t)=>{let s=Number(e);""===e?t(new Error("周期不能为空")):s<1?t(new Error("周期必须大于0")):t()},trigger:["input"]}],channel:[{type:"array",required:!0,message:"请至少选择一个告警方式",trigger:"change"}]}),da=a=>{const{country:e,city:t}=a,s=r(e)?e.join(","):"",l=r(t)?t.join(","):"";return"非".concat(s).concat(s&&l?",":"").concat(l,"地区")},ma=async()=>{Z.value=!0;try{const{data:a}=await C(),{area:e,cron_task_status:t,time:s,login_error:l,upload_shell:i,cron_task:n}=a;if(H.value.config={...a,login_error_des:"超过".concat(l,"次"),time_des:"".concat(s.start_time,"点至").concat(s.end_time,"点范围外"),area_des:da(e),upload_shell_des:r(i)?i.join(","):""},Q.value&&t){const{task_type:a,cycle:e,channel:s}=n;Object.assign(H.value,{anonymous:a.anonymous,area:a.area,login_error:a.login_error,time:a.time,upload_shell:a.upload_shell,cycle:e,channel:s?s.split(","):[],status:!!t})}else Object.assign(H.value,{anonymous:!0,area:!0,login_error:!0,time:!0,upload_shell:!0})}catch(a){n(a)}finally{Z.value=!1}},pa=()=>{e({title:"扫描触发条件",area:[50,34],btn:["保存","取消"],component:()=>t((()=>import("./scan.js?v=1734676359")),__vite__mapDeps([]),import.meta.url)})},_a=a=>{H.value.user=a,"other"===a&&(H.value.anonymous=!1)},ga=async a=>{let e;await K.value.validate();try{e=i.load("扫描中...");const t=((a=H.value,e=Q.value)=>{let t={};const s=JSON.stringify({anonymous:a.anonymous,area:a.area,login_error:a.login_error,time:a.time,upload_shell:a.upload_shell});return t=e?{task_type:s,cycle:a.cycle,channel:a.channel.join(","),status:a.status?1:0}:{search:s,day:"other"===a.day?Number(a.otherDay):a.day,username:"all"===a.user?"[]":JSON.stringify(a.userList)},t})();if(H.value.search=(null==t?void 0:t.search)||(null==t?void 0:t.task_type),Q.value){const e=await E(t);i.request(e),e.status&&ma(),a()}else{const e=await N(t);if(i.request({status:e.status,msg:e.status?"扫描成功":"扫描失败",time:500}),e.status){W.value.data=[];for(const a in e.data){const t=e.data[a];W.value.data.push({time:t.exec_time,type:t.type,user:t.user,ip:a,id:t.id}),W.value.data.sort(((a,e)=>{var t,s;return new Date(null==(t=e.time)?void 0:t.replace(/-/g,"/")).getTime()-new Date(null==(s=a.time)?void 0:s.replace(/-/g,"/")).getTime()}))}W.value.btn="重新扫描",W.value.scanStatus=!0,a()}}}catch(t){n(t)}finally{null==e||e.close()}},ya=()=>{H.value.config={login_error:5,time:{start_time:0,end_time:24},area:{country:[],city:[]},upload_shell:[],login_error_des:"超过5次",time_des:"0点至24点范围外",area_des:"非地区",upload_shell_des:"未配置"},(async()=>{try{const{data:a}=await J();r(a)&&(U.value=[],a.forEach((a=>{U.value.push({label:a,value:a})})),H.value.userList=a.length>0?[a[0]]:[])}catch(a){}})(),ma()},va=()=>{const a=H.value.config;Object.assign(H.value.config,{...a,start_time:a.time.start_time<10?"0".concat(a.time.start_time,":00"):"".concat(a.time.start_time,":00"),end_time:a.time.end_time<10?"0".concat(a.time.end_time,":00"):"".concat(a.time.end_time,":00"),upload_shell_br:a.upload_shell.join("\n")}),aa.value=["美国","中国","印度","日本","德国","英国","法国","俄罗斯","巴西","加拿大","意大利","澳大利亚","韩国","墨西哥","印度尼西亚","沙特阿拉伯","南非","阿根廷","土耳其","西班牙"].map((a=>({label:a,value:a})))},ha=[{label:"类型",prop:"type",minWidth:100},{label:"用户名",prop:"user",minWidth:60},{label:"IP",prop:"ip"},{label:"操作时间",prop:"time"},R([{onClick:async({ip:a})=>{await l({icon:"warning-filled",title:"IP封禁",content:"封禁【"+a+"】后，将不再允许此IP访问服务器，是否继续操作？"});const e=JSON.stringify({choose:"address",address:a,domain:"",types:"drop",brief:"FTP日志分析点击IP拉黑"});(await s({loading:"正在封禁IP，请稍后...",request:j({data:e}),data:{status:Boolean},message:!0})).status&&ea()},title:"IP拉黑",width:50},{onClick:async({user:a,id:e})=>{if(0===e)return i.error("匿名用户不可删除"),!1;await l({icon:"warning-filled",title:"删除FTP用户",content:"删除选中的FTP用户后，该FTP用户将彻底失去访问和操作权限，是否继续操作？"});(await s({loading:"正在删除FTP用户，请稍后...",request:L({id:e,username:a}),data:{status:Boolean},message:!0})).status&&(ea(),refreshTableData())},title:"删除账号",width:60},{onClick:async({user:a,id:e})=>{if(0===e)return i.error("匿名用户不可停用");await l({icon:"warning-filled",title:"停用FTP用户",content:"停用【"+a+"】后，该FTP用户将失去访问权限，是否继续操作？"});const t=await s({loading:"正在停用FTP用户，请稍后...",request:q({id:e,username:a,status:0}),data:{status:Boolean},message:!0});(null==t?void 0:t.status)&&(ea(),refreshTableData())},title:"停用账号",width:60},{onClick:async({ip:a})=>{await l({icon:"warning-filled",title:"忽略IP",content:"忽略【"+a+"】后，该IP将加入白名单中，FTP日志分析将不在记录该IP的数据，是否继续操作？"});(await s({loading:"正在忽略IP，请稍后...",request:D({ip:a,type:"add"}),data:{status:Boolean},message:!0})).status&&ea()},title:"忽略"}])],fa=()=>e({title:"FTP日志白名单",area:[70,45],component:()=>t((()=>import("./whitelist.js?v=1734676359")),__vite__mapDeps([]),import.meta.url)}),ba=a=>{e({title:"FTP日志".concat(a?"分析条件":"自动分析推送"),area:a?[66,30]:[70],btn:a?"立即扫描":"保存配置",component:()=>t((()=>import("./timed-scan.js?v=1734676359")),__vite__mapDeps([]),import.meta.url)})},wa=async a=>{if(Q.value=!Boolean(a),"ltd"===M.value.authType){const{status:e,msg:t}=await s({loading:"正在获取日志服务状态，请稍后...",request:x({exec_name:"getlog"}),data:{status:Boolean,msg:String}});if(!e||"stop"===t){await l({icon:"warning-filled",title:"开启FTP日志服务",content:"FTP日志服务未启动，无法记录访问日志，是否启动日志服务?"});const e=await s({loading:"正在开启FTP日志服务，请稍后...",request:x({exec_name:"start"}),data:{status:Boolean},message:!0});(null==e?void 0:e.status)&&ba(a)}ba(a)}else i.error("企业版专享功能！"),await V({sourceId:O.value?260:220})},Pa=[{icon:"user",title:"多次登录失败"},{icon:"login-address",title:"登录地区异常"},{icon:"shell-file",title:"上传脚本文件"},{icon:"anonymous",title:"匿名用户登录"},{icon:"login-time",title:"登录时间异常"}],Ta=[{label:"7天",value:7},{label:"30天",value:30},{label:"自定义",value:"other"}],Sa=[{label:"全部",value:"all"},{label:"指定用户",value:"other"}],ka={class:"ftp-log-scan"},Ia={class:"scan-header"},Fa={class:"scan-header-left"},xa={class:"scan-header-title"},Oa={key:0},ja={key:1},La={class:"scan-content"},qa={key:0,class:"scan-content-preview"},Da={class:"scan-content-preview-list"},Na={class:"text-[1.2rem]"},Aa={key:1},Ea=u(y({__name:"index",setup(a,{expose:e}){const{ftpAnalysisList:t,ftpScanTable:s}=G();return e(ta),(a,e)=>{const l=F,i=o;return v(),h("div",ka,[f("div",Ia,[f("div",Fa,[e[4]||(e[4]=f("i",{class:"svgtofont-icon-ftp-log !text-[5.4rem] text-[#888] mr-16px"},null,-1)),f("div",xa,[b(t).scanStatus?(v(),h("div",ja," 扫描完成，"+w(b(t).data.length?"共扫描出"+b(t).data.length+"条风险记录":"未扫描出风险记录"),1)):(v(),h("div",Oa," FTP日志扫描，快速扫描当前FTP的安全详情 ")),f("p",null,[e[2]||(e[2]=P(" 推荐定期自动扫描功能，定期扫描生成分析结果并发送通知【 ")),f("span",{class:"bt-link",onClick:e[0]||(e[0]=a=>b(wa)(0))},w(b(t).autoScanText),1),e[3]||(e[3]=P(" 】 "))])])]),_(l,{class:"scan-header-btn",type:"primary",title:b(t).btn,onClick:e[1]||(e[1]=a=>b(wa)(1))},{default:T((()=>[P(w(b(t).btn),1)])),_:1},8,["title"])]),f("div",La,[b(t).scanStatus?(v(),h("div",Aa,[_(l,{class:"!mb-[1rem]",onClick:b(fa)},{default:T((()=>e[6]||(e[6]=[P(" 白名单 ")]))),_:1},8,["onClick"]),_(i,{ref_key:"ftpScanTable",ref:s,"max-height":"310",column:b(ha),data:b(t).data,description:"扫描列表为空"},null,8,["column","data"])])):(v(),h("div",qa,[e[5]||(e[5]=f("div",null,"支持以下FTP日志安全风险扫描：",-1)),f("div",Da,[(v(!0),h(S,null,k(b(Pa),((a,e)=>(v(),h("div",{class:"preview-list-item",key:e},[f("i",{class:I("svgtofont-icon-".concat(a.icon," text-2rem mr-4px text-[#888]"))},null,2),f("span",Na,w(a.title),1)])))),128))])]))])])}}}),[["__scopeId","data-v-8e79f7ef"]]),Ba=Object.freeze(Object.defineProperty({__proto__:null,default:Ea},Symbol.toStringTag,{value:"Module"}));export{oa as a,ya as b,ga as c,pa as d,ia as e,Ta as f,ua as g,Sa as h,va as i,_a as j,Ba as k,na as o,sa as r,la as s,ca as t,G as u,ra as w};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
