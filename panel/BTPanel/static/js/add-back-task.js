import{c as e,r as a,h as t,w as l,a1 as s,o as c,B as n,C as o,p as i,k as u,J as d,x as p,e as m,y as r,z as _,F as b,q as f,v,l as g,I as y,aX as k,A as x,a7 as h,b0 as D,a4 as w,n as C}from"./base-lib.js?v=1734676359";import{J as T,o as V,G as j,M as q,U as J,j as M,e as P}from"./utils-lib.js?v=1734676359";import{a9 as U,aa as H,ab as N}from"./config.js?v=1734676359";import{C as B}from"./checkbox-group.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";const E={class:"h-[49.8rem]"},F={class:"backup-config"},I=["onClick"],S=["onClick"],z={key:2,class:"flex mb-1rem"},A={class:"children-title"},G={class:"config-item-content"},L=P(e({__name:"add-back-task",props:{compData:{default:{refresh:()=>{}}}},setup(e,{expose:P}){const L=e;let O=!1;const{isEdit:R,id:X,active:K,type:Q}=L.compData,W=a(K),Y=a({}),Z=a(),$=a(!1),ee=a(""),ae=a(!1),te=a(!1),le=a([{label:"整机备份",value:"all",disabled:!!R},{label:"环境备份",value:"env_list",disabled:!!R},{label:"数据备份",value:"data_list",disabled:!!R}]);a([new Date(2e3,1,1,0,0,0),new Date(2e3,2,1,23,59,59)]);const se=t({bp_type:"all",backup_type:"整机备份",name:"整机备份",backup_config:{},type:R?2:1,next_exec_time:""}),ce={php:"PHP项目",node:"Node项目",proxy:"反向代理",python:"Python项目",other:"其他项目",net:".Net项目",java:"Java项目",html:"HTML项目"};a({env_list:!0,safety:!0,ftp_list:!0,site_list:!0,sql_list:!0});const ne={name:[{required:!0,message:"请输入备份名称",trigger:["blur"]}]},oe=e=>e.getTime()<Date.now()-864e5,ie=e=>{var a;se.backup_type=null==(a=le.value.find((a=>a.value===e)))?void 0:a.label,se.name=se.backup_type;for(const t in se.backup_config){ue(se.backup_config[t],t===e||"all"===e)}};function ue(e,a){if(T(e))e.forEach((e=>{a&&3!==e.status&&!1!==(null==e?void 0:e.setup)?e.status=1:3!==e.status&&(e.status=0)}));else for(const t in e){ue(e[t],a)}}const de=e=>{Y.value={...Y.value,[e]:!Y.value[e]}},pe=e=>{var a;return null==(a=le.value.find((a=>a.value===e)))?void 0:a.label},me=e=>({site_list:"网站",sql_list:"数据库",ftp_list:"FTP",terminal_list:"终端",crontab_list:"计划任务",safety:"安全"}[e]),re=(e,a,t)=>{var l,s;let c="";if("logs"===(null==(l=L.compData)?void 0:l.type)){const a="backup"===W.value?"备份":"还原",t=e[W.value+"_status"];-1!==t&&0!==t&&3!==t||(ae.value=!0),c=4===e.status?"[ 未恢复 ]":((e,a,t)=>{const l={"-1":'<b class="text-orange cursor-default" title="'.concat(t,'">').concat(a,"中</b>"),0:"等待".concat(a),1:'<b class="text-primary cursor-default" title="'.concat(t,'">').concat(a,"完成</b>"),2:'<b class="text-danger cursor-default" title="'.concat(t,'">').concat(a,"失败</b>")};return l[e]?" [ ".concat(l[e]," ]"):""})(t,a,null==e?void 0:e.msg)}const n="env_list"===t?a+("php"===a?"-":""):"",o=3===e.status?" [ 待开发 ]":!1===(null==e?void 0:e.setup)?" [ 未安装 ]":"logs"===(null==(s=L.compData)?void 0:s.type)?c:"";return"".concat(n).concat(e.name).concat((null==e?void 0:e.ps)?"（".concat(e.ps,"）"):"").concat(o)},_e=e=>{var a;return 3===e.status||!1===(null==e?void 0:e.setup)||2===se.type&&(!(null==e?void 0:e.backup_status)||4===(null==e?void 0:e.backup_status))||"logs"===(null==(a=L.compData)?void 0:a.type)},be=e=>{C((()=>{}))},fe=e=>{const a=new Date;a.setSeconds(0,0);const t=new Date(6e4*Math.round(e.getTime()/6e4)),l=new Date(6e4*Math.round(a.getTime()/6e4));te.value=+t==+l},ve=async(e=!1)=>{var a;const t=await j({loading:$,request:R?H({id:X},W.value):N()});if(t.status){ee.value="",se.backup_config=t.data,(null==(a=L.compData)?void 0:a.rowData)&&delete se.backup_config.status;for(const e in se.backup_config){const a=se.backup_config[e];if(Y.value[e]=!0,"data_list"===e)for(const e in a)Y.value[e]=!0}}else ee.value=t.msg;e&&q.success("刷新成功")},ge=async()=>{if(O)return;const e=(new Date).getTime()/1e3;ae.value&&await ve(!1);const a=(new Date).getTime()/1e3;setTimeout((()=>ge()),a-e<1?4e3:3e3)};return l((()=>{var e;return null==(e=L.compData)?void 0:e.active}),(e=>{ae.value=!1,W.value=e,ve()})),P({onConfirm:async e=>{await Z.value.validate();let a={...se,backup_config:JSON.stringify(se.backup_config),next_exec_time:new Date(se.next_exec_time).getTime()/1e3};(te.value&&se.next_exec_time<new Date||!se.next_exec_time)&&(a.next_exec_time=0),delete a.bp_type,2===a.type?(a.id=L.compData.id,a.reduction_config=a.backup_config,delete a.backup_config,delete a.next_exec_time):await V({title:"提示",content:"在备份数据库备份时，对应网站将不可访问，是否继续操作？",type:"calc"}),await j({loading:"正在提交，请稍后...",request:U(a),message:!0,success:a=>{a.status&&(L.compData.refresh(),e())}})}}),s((()=>{O=!0})),c((async()=>{var e,a;R&&(se.next_exec_time=L.compData.exec_time,se.name=L.compData.name,se.bp_type=null==(e=le.value.find((e=>e.label===L.compData.backup_type)))?void 0:e.value),await ve(),"logs"===(null==(a=L.compData)?void 0:a.type)&&ge()})),(e,a)=>{const t=x,l=h,s=J,c=M,C=D,V=w,j=n("bt-loading");return o((u(),d(V,{ref_key:"addBackupRef",ref:Z,rules:ne,model:i(se),class:b(["bt-custom-form",{"-ml-2rem":"logs"===e.compData.type}]),"label-width":"4rem"},{default:p((()=>["logs"===e.compData.type?(u(),d(l,{key:0,label:"",class:"ml-2rem"},{default:p((()=>[m(t,{type:"default",onClick:a[0]||(a[0]=e=>ve(!0))},{default:p((()=>a[4]||(a[4]=[r("刷新日志")]))),_:1})])),_:1})):_("",!0),i(ee)?(u(),d(l,{key:1,label:"",class:b({"ml-2rem":"logs"===e.compData.type})},{default:p((()=>[f("div",E,v(i(ee)),1)])),_:1},8,["class"])):(u(),g(y,{key:2},[m(l,{label:"备份类型",prop:"bp_type"},{default:p((()=>[m(s,{type:"button",modelValue:i(se).bp_type,"onUpdate:modelValue":a[1]||(a[1]=e=>i(se).bp_type=e),options:i(le),class:"w-[38rem]",onChange:ie},null,8,["modelValue","options"])])),_:1}),m(l,{label:"备份名称",prop:"name",class:"!mt-[1.6rem]"},{default:p((()=>[m(c,{modelValue:i(se).name,"onUpdate:modelValue":a[2]||(a[2]=e=>i(se).name=e),name:"name",width:"32rem",disabled:!!i(R)},null,8,["modelValue","disabled"])])),_:1}),i(R)?_("",!0):(u(),d(l,{key:0,label:"执行时间"},{default:p((()=>[m(C,{modelValue:i(se).next_exec_time,"onUpdate:modelValue":a[3]||(a[3]=e=>i(se).next_exec_time=e),type:"datetime",style:{width:"32rem"},placeholder:"选择执行时间，为空默认添加后立即执行","disabled-date":oe,onChange:fe},null,8,["modelValue"])])),_:1})),m(l,{label:"备份详情",prop:"backup_config"},{default:p((()=>[f("div",F,[(u(!0),g(y,null,k(i(se).backup_config,((e,a)=>(u(),g("div",{class:"backup-config-item",key:a},[f("div",{class:"config-item-title",onClick:e=>de(a)},[f("span",null,v(pe(a)),1),f("i",{class:b("svgtofont-el-arrow-".concat(i(Y)[a]?"down":"up"))},null,2)],8,I),f("div",{class:b(["config-item-content",{hidden:!i(Y)[a],grid:"data_list"!==a}])},[(u(!0),g(y,null,k(e,((t,l)=>(u(),g(y,null,[i(T)(e)?(u(),d(B,{key:"".concat(a+l),"comp-data":{item:t,getDisabled:_e,changeCheckbox:be,title:re(t)}},null,8,["comp-data"])):(u(),g(y,{key:1},["data_list"!==a?(u(!0),g(y,{key:0},k(t,((e,t)=>(u(),g(y,null,[!1!==e.setup?(u(),d(B,{key:"".concat(l+t),"comp-data":{item:e,title:re(e,l,a),getDisabled:_e,changeCheckbox:be}},null,8,["comp-data"])):_("",!0)],64)))),256)):(u(),g(y,{key:1},[f("div",{class:b(["flex",i(Y)[l]?"":"my-1rem"])},[f("div",{class:"config-item-title",onClick:e=>de(l)},[f("span",null,v(me(l)),1),f("i",{class:b("svgtofont-el-arrow-".concat(i(Y)[l]?"down":"up"))},null,2)],8,S)],2),f("div",{class:b(["config-item-content",{hidden:!i(Y)[l],grid:"site_list"!==l&&"sql_list"!==l}])},[(u(!0),g(y,null,k(t,((e,a)=>{var s;return u(),g(y,null,[i(T)(t)?(u(),d(B,{key:"".concat(l+a),"comp-data":{item:e,getDisabled:_e,changeCheckbox:be,title:re(e)}},null,8,["comp-data"])):"safety"==l?(u(!0),g(y,{key:1},k(e,((e,t)=>(u(),d(B,{key:"".concat(a+t),"comp-data":{item:e,getDisabled:_e,changeCheckbox:be,title:re(e)}},null,8,["comp-data"])))),128)):i(T)(e)&&"safaty"!==l?(u(),g("div",z,[f("span",A,v(null!=(s=ce[a])?s:a)+"：",1),f("div",G,[(u(!0),g(y,null,k(e,((e,a)=>(u(),d(B,{key:a,"comp-data":{item:e,title:re(e),getDisabled:_e,changeCheckbox:be}},null,8,["comp-data"])))),128))])])):_("",!0)],64)})),256))],2)],64))],64))],64)))),256))],2)])))),128))])])),_:1})],64))])),_:1},8,["model","class"])),[[j,i($)]])}}}),[["__scopeId","data-v-d4943c9e"]]);export{L as default};
