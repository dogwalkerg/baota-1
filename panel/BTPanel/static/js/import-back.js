import{_ as a}from"./index101.js?v=1734676359";import{o as e,G as t,M as l,dh as s,S as n,F as o,k as i,O as r,j as m,h as d}from"./utils-lib.js?v=1734676359";import{c,r as p,h as u,az as f,bC as g,o as v,B as w,k as h,l as x,e as y,x as _,q as b,y as k,p as q,z as j,C as z,N as C,M as V,A as S,aY as D,a7 as M,a4 as H}from"./base-lib.js?v=1734676359";import{_ as U}from"./index90.js?v=1734676359";import{_ as O}from"./index97.js?v=1734676359";import{restoreModuleBack as Y,restoreBack as F,getImportLog as A,getBackup as N,getModulesBackup as T}from"./database.js?v=1734676359";import{g as J,x as B,y as G}from"./useMethod3.js?v=1734676359";import{i as P,u as R}from"./column.js?v=1734676359";import{f as E}from"./validator.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";const I={class:"p-[20px]"},K={class:"flex items-center"},L={key:0,class:"ml-[1.2rem]"},Q={class:"p-2rem flex flex-col"},W=c({__name:"import-back",props:{compData:{default:{}}},setup(c){const{refs:{tabActive:W}}=J(),X=c,Z=p(0),$=p([]),aa=p(!1),ea=p({}),ta=p(!1),la=p(),sa=u({password:""}),na=p(!1),oa=p(!1),ia=p(""),ra=[{content:"仅支持sql、zip、sql.gz、(tar.gz|gz|tgz)"},{content:"zip、tar.gz压缩包结构：test.zip或test.tar.gz压缩包内，必需包含test.sql"},{content:"若文件过大，您还可以使用SFTP工具，将数据库文件上传到您设置的默认备份目录"},{content:"若未设置默认备份目录，默认路径为/www/backup/database"}],ma=u({password:[{required:!0,message:"请输入压缩密码",trigger:"blur"}]}),da=u({p:1,limit:10,search:""}),ca=()=>{E({type:"file",path:"/www/backup",change:async a=>{pa({path:a})},confirmText:"导入"})},pa=async(a,l=!1)=>{ea.value=a,await e({title:"导入数据库",content:'<div class="text-[1.4rem] leading-2rem">【'.concat(X.compData.name,"】数据库将被覆盖，是否继续操作？</div>"),isHtml:!0,icon:"warning-filled",type:"calc"});let s={file:a.path,name:X.compData.name};"mysql"===W.value?(l&&(s.disk_check=!0),ua(s,(()=>pa(a,!0)))):await t({request:Y({data:JSON.stringify(s)},W.value),loading:"正在导入数据库,请稍后...",message:!0})},ua=async(a,e)=>{var l;const s=B({type:"import",config:{name:X.compData.name}}),n=await s,o=await t({request:F(a),message:!0});return"请您输入密码"===o.msg?(null==n||n.unmount(),void(ta.value=!0)):-1!==(null==(l=o.msg)?void 0:l.indexOf("警告"))?(await fa(o.msg),void e()):void(null==n||n.unmount())},fa=a=>e({title:"提示",isHtml:!0,width:"50rem",iconColor:"error",confirmText:"继续导入",content:'<div class="flex"><div><div>'.concat(a,"</div><div>\n\t\t\t<p>如继续导入可能会有以下影响：</p>\n\t\t\t<p>1.导入数据不完整</p>\n\t\t\t<p>2.系统运行缓慢</p>\n\t\t\t<p>3.面板无法正常工作</p>\n\t\t\t<p>4.mysql无法正常运行</p></div></div></div>")}),ga=async(a=!1)=>{await la.value.validate();let e={file:ea.value.path,name:X.compData.name,password:sa.password};a&&(e.disk_check=!0),ua(e,(()=>ga(!0)))},va=()=>{na.value=!0,wa()},wa=async a=>{var e;-1!==(null==(e=(await t({loading:oa,request:A(),data:{msg:[String,ia]}})).msg)?void 0:e.indexOf("Database recovery successful"))&&l.success("导入已完成"),a&&l.success("刷新成功")},ha=()=>{G((()=>xa()))},xa=async()=>{await t({loading:aa,request:"mysql"===W.value?N({...da}):T({data:JSON.stringify({...da})},W.value),data:{data:[Array,$],page:n(Z)}})},ya=[{label:"文件名",prop:"name"},{label:"修改时间",width:200,render:a=>{const e=new Date(Math.floor(1e3*a.mtime));return f("span",g(e,"YYYY-MM-DD HH:mm:ss"))}},P({prop:"size",width:100}),R([{onClick:a=>pa(a),title:"导入"},{onClick:a=>(async a=>{await e({title:"删除文件",content:"删除文件【".concat(a.name,"】后，该数据库文件将迁至回收站，是否继续操作？"),icon:"warning-filled"}),await t({request:s({path:a.path}),loading:"正在删除文件，请稍后...",message:!0}),xa()})(a),title:"删除"}])];return v((()=>{xa(),(async()=>{const a=await t({request:A(),data:{db_name:String}});(null==a?void 0:a.db_name)&&B({type:"import",config:{name:null==a?void 0:a.db_name}})})()})),(e,t)=>{const l=S,s=D,n=o,c=i,p=O,u=U,f=r,g=m,v=M,Y=H,F=d,A=a,N=w("bt-loading"),T=w("focus");return h(),x("div",I,[y(u,null,{"header-left":_((()=>[b("div",K,[y(l,{onClick:ha},{default:_((()=>t[8]||(t[8]=[k("从本地上传")]))),_:1}),"mysql"===q(W)?(h(),x("div",L,[y(l,{onClick:ca},{default:_((()=>t[9]||(t[9]=[k("从本机导入")]))),_:1}),y(s,{direction:"vertical",class:"!h-2rem !mx-1.2rem"}),y(l,{onClick:va},{default:_((()=>t[10]||(t[10]=[k("显示日志")]))),_:1})])):j("",!0)])])),"header-right":_((()=>[y(n,{modelValue:q(da).search,"onUpdate:modelValue":t[0]||(t[0]=a=>q(da).search=a),onClear:xa,placeholder:"请输入搜索关键字",onSearch:xa},null,8,["modelValue"])])),content:_((()=>[z(y(c,{column:ya,data:q($),"max-height":"360"},null,8,["data"]),[[N,q(aa)]])])),"footer-right":_((()=>[y(p,{total:q(Z),page:q(da).p,"onUpdate:page":t[1]||(t[1]=a=>q(da).p=a),row:q(da).limit,"onUpdate:row":t[2]||(t[2]=a=>q(da).limit=a),onChange:xa},null,8,["total","page","row"])])),_:1}),y(f,{options:ra,class:"ml-[20px] mt-[20px]"}),y(F,{title:"导入数据库",modelValue:q(ta),"onUpdate:modelValue":t[5]||(t[5]=a=>V(ta)?ta.value=a:null),area:40,showFooter:"",onConfirm:ga},{default:_((()=>[y(Y,{model:q(sa),ref_key:"inputMysqlForm",ref:la,class:"p-[20px]",rules:q(ma),onSubmit:t[4]||(t[4]=C((()=>{}),["prevent"]))},{default:_((()=>[t[11]||(t[11]=b("div",{class:"flex items-center mt-[1rem] mb-[2rem]"},[b("i",{class:"el-icon-warning text-[4rem] text-warning"}),b("div",{class:"ml-[1rem] text-[1.6rem] leading-[2.2rem] text-[#666]"},"当前文件存在压缩密码，请输入压缩密码进行导入")],-1)),y(v,{label:"压缩密码",prop:"password"},{default:_((()=>[z(y(g,{placeholder:"如未设置压缩密码，可为空",modelValue:q(sa).password,"onUpdate:modelValue":t[3]||(t[3]=a=>q(sa).password=a)},null,8,["modelValue"]),[[T]])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue"]),y(F,{title:"显示日志",modelValue:q(na),"onUpdate:modelValue":t[7]||(t[7]=a=>V(na)?na.value=a:null),area:70},{default:_((()=>[z((h(),x("div",Q,[b("div",null,[y(l,{onClick:t[6]||(t[6]=a=>wa(!0)),type:"default",class:"!mb-1rem"},{default:_((()=>t[12]||(t[12]=[k("刷新日志")]))),_:1})]),y(A,{class:"h-41rem",content:q(ia),isHtml:!0,fullScreen:{title:"全屏查看【面板运行】日志",onRefresh:wa}},null,8,["content","fullScreen"])])),[[N,q(oa)]])])),_:1},8,["modelValue"])])}}});export{W as default};
