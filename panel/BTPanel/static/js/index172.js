import{c as e,r as s,h as a,o as l,k as t,l as i,e as r,x as o,p as n,I as p,aX as m,J as u,z as d,ag as c,ah as g,a7 as v,a4 as b}from"./base-lib.js?v=1734676359";import{o as f,j as y,G as _,M as j}from"./utils-lib.js?v=1734676359";import{getPermission as w,setPermission as h,setPgSqlAuth as P}from"./database.js?v=1734676359";import{g as q,o as x}from"./useMethod3.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./column.js?v=1734676359";import"./index91.js?v=1734676359";import"./validator.js?v=1734676359";const I={class:"p-20px"},V=e({__name:"index",props:{compData:{default:()=>({type:"single",rowData:{}})}},setup(e,{expose:V}){const{refs:{tabActive:k},refreshTableList:D}=q(),A=e,{rowData:O,type:S}=A.compData,B=s(),J=a({permission:"",ip:""}),M={ip:[{required:!0,trigger:["blur","change"],message:"请输入IP地址"}]},U=e=>{var s,a;const l=null==(s=e.success)?void 0:s.map((e=>({name:e,status:!0}))),t=null==(a=e.error)?void 0:a.map((e=>({name:e,status:!1})));x([...l,...t],{title:"修改权限"})},z={pgsql:{option:[{label:"所有人",value:"0.0.0.0/0"},{label:"本地服务器",value:"127.0.0.1/32"}],placeholder:"填写格式如：192.168.69.11/24",getPermission:()=>{const e="0.0.0.0/0"!==O.listen_ip&&"127.0.0.1/32"!==O.listen_ip;J.ip=e?O.listen_ip:"",J.permission=e?"ip":O.listen_ip},setPermission:async()=>{const{permission:e,ip:s}=J,a={data_name:O.name,username:O.username,listen_ip:"ip"===e?s:e};return await _({loading:"正在修改权限，请稍后...",request:P({data:JSON.stringify(a)}),success:({data:e})=>{j.request({msg:e.msg||e.data,status:e.status})}})}},mysql:{option:[{label:"所有人",value:"%"},{label:"本地服务器",value:"127.0.0.1"}],placeholder:"如果要允许IP段访问，可以使用%作为通配符，如127.17.%.%，如需要填写多个IP，请换行填写，每行一个IP",getPermission:async()=>{const{msg:e,status:s}=await _({request:w({name:O.username}),data:{msg:String,status:Boolean}});if(!s)return j.error(e);J.permission=e,"%"!==e&&"127.0.0.1"!==e&&(J.permission="ip",J.ip=e.replace(/,/g,"\n"))},setPermission:async()=>{const e=(()=>{const{permission:e,ip:s}=J;let a={name:O.username,dataAccess:e,access:"ip"===e?s:e,address:"ip"===e?s:""};return"multlples"==S&&(a.name=null==O?void 0:O.map((e=>e.username)).join(","),"ip"!==e&&delete a.ip),a})(),s=await _({loading:"正在修改权限，请稍后...",request:h(e),message:"single"===S,data:{error:[Object,e=>Object.keys(e)],success:Array,status:Boolean,msg:String}});return s.status?("multlples"===S&&U(s),s):j.error(s.msg)}}};return l((()=>{(async()=>{"multlples"!=S?z[k.value].getPermission():J.permission=z[k.value].option.filter((e=>e.label.includes("本地")))[0].value})()})),V({onConfirm:async e=>{await B.value.validate();const{permission:s,ip:a}=J;["%","0.0.0.0/0"].includes(s)&&await f({title:"提示",content:"设置权限为所有人后，将会导致数据库安全性降低，他人可以随意访问数据库，是否继续操作？",icon:"warning-filled"});(await z[k.value].setPermission()).status&&(e(),D())}}),(e,s)=>{const a=c,l=g,f=v,_=y,j=b;return t(),i("div",I,[r(j,{ref_key:"permissionFormRef",ref:B,model:n(J),rules:M,"label-width":"5rem"},{default:o((()=>[r(f,{label:"访问权限",prop:"permission"},{default:o((()=>[r(l,{class:"!w-[22rem]",modelValue:n(J).permission,"onUpdate:modelValue":s[0]||(s[0]=e=>n(J).permission=e)},{default:o((()=>[(t(!0),i(p,null,m(z[n(k)].option,(e=>(t(),u(a,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128)),r(a,{label:"指定ip",value:"ip"})])),_:1},8,["modelValue"])])),_:1}),"ip"===n(J).permission?(t(),u(f,{key:0,prop:"ip",label:"IP地址"},{default:o((()=>[r(_,{type:"mysql"===n(k)?"textarea":"text",rows:4,width:"22rem",modelValue:n(J).ip,"onUpdate:modelValue":s[1]||(s[1]=e=>n(J).ip=e),placeholder:z[n(k)].placeholder},null,8,["type","modelValue","placeholder"])])),_:1})):d("",!0)])),_:1},8,["model"])])}}});export{V as default};
