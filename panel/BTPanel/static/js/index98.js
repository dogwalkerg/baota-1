import{c as e,r as a,t as l,i as t,o as u,B as n,k as s,l as r,p as d,e as o,x as i,I as m,aX as v,J as c,M as p,z as _,C as y,q as f,y as b,ag as g,ah as V,bO as h,ax as k,v as w,G as x,F as M,P as U,ae as D,ad as j,a7 as H,h as T,W as L,D as E,n as C,bP as S,a4 as B}from"./base-lib.js?v=1734676359";import{_ as O}from"./validator.js?v=1734676359";import{aM as G,a1 as I,e as P,M as R,G as q,bn as z,N as F}from"./utils-lib.js?v=1734676359";import{g as N}from"./useMethod.js?v=1734676359";import{a5 as J}from"./config.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";import"./column.js?v=1734676359";import"./useStore.js?v=1734676359";const Q={key:0,class:"flex items-center"},Y=["innerHTML"],W={key:2,class:"flex items-center"},X=e({__name:"select",props:{tid:{},value:{},data:{},cycles:{}},emits:["update:value"],setup(e,{emit:k}){const w=a([]),x=e,M=k,{tid:U,data:D}=l(x),j=a(!1),H=a(!1),T=t({get:()=>x.value,set(e){"9"===x.tid&&"cycle"===x.data.attr?M("update:value",Number(e)):M("update:value",e)}}),L=async()=>{H.value=!0,await C(D),H.value=!1},E={lazy:!0,async lazyLoad(e,a){var l;const{level:t}=e;if(null==(l=null==D?void 0:D.value)?void 0:l.items[t].url){let l={};if(t>=1)for(let a=0;a<t;a++)l[D.value.items[t].data[a]]=a===t-1?e.value:e.parent.value;const{data:u}=await J(D.value.items[t].url,l);a(u.map((e=>({value:e.value,label:e.title,leaf:t===D.value.items.length-1?D.value.items.length:void 0}))))}}},C=async e=>{try{const{data:a}=await J(e.value.items.url);w.value=a}catch(a){}};return u((async()=>{if("select"===D.value.type&&G(D.value.items)&&"url"in D.value.items){j.value=!0;try{0===w.value.length?(H.value=!0,await C(D),H.value=!1,T.value=w.value[0].value):""===T.value&&(T.value=w.value[0].value)}catch(e){}}})),(e,a)=>{const l=g,t=V,u=h,k=n("bt-loading");return s(),r("div",null,[e.cycles.includes(d(U)||"")&&"cycle"===d(D).attr?(s(),r("div",Q,[o(t,{modelValue:d(T),"onUpdate:modelValue":a[0]||(a[0]=e=>p(T)?T.value=e:null),class:"!w-[16rem]",disabled:!0},{default:i((()=>[(s(!0),r(m,null,v(d(D).items,(e=>(s(),c(l,{key:e.value,label:e.title+"分钟",value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),d(D).suffix?(s(),r("div",{key:0,innerHTML:d(D).suffix,class:"ml-[1rem]"},null,8,Y)):_("",!0)])):"cascader"===d(D).type?(s(),c(u,{key:1,modelValue:d(T),"onUpdate:modelValue":a[1]||(a[1]=e=>p(T)?T.value=e:null),props:E},null,8,["modelValue"])):d(j)?(s(),r("div",W,[y((s(),c(t,{"element-loading-spinner":"svgtofont-el-loading",modelValue:d(T),"onUpdate:modelValue":a[2]||(a[2]=e=>p(T)?T.value=e:null),filterable:"",class:"!w-[24.8rem]"},{default:i((()=>[(s(!0),r(m,null,v(d(w),(e=>(s(),c(l,{key:e.value,label:e.title,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])),[[k,d(H)],[k,"正在加载，请稍后...","title"]]),f("span",{class:"bt-link ml-[1rem]",onClick:L},a[4]||(a[4]=[b("刷新"),f("i",{class:"svgtofont-el-refresh-right"},null,-1)]))])):(s(),c(t,{key:3,modelValue:d(T),"onUpdate:modelValue":a[3]||(a[3]=e=>p(T)?T.value=e:null),class:"!w-[24.8rem]"},{default:i((()=>[(s(!0),r(m,null,v(d(D).items,(e=>(s(),c(l,{key:e.value,label:e.title,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]))])}}}),$=["innerHTML"],A=["innerHTML"],K=P(e({__name:"common-item",props:{tid:{default:""},value:{default:""},data:{}},emits:["update:value"],setup(e,{emit:a}){const u=e,{tid:n,data:y}=l(u),f=a,g=t({get:()=>u.value,set(e){f("update:value",{val:e,attr:y.value.attr})}}),V={4:["cycle","count"],21:["cycle","count"],22:["cycle","count"],23:["cycle","count"]},h=["21","22","23"],T=t((()=>{const e=Object.entries(V);for(let a=0;a<e.length;a++){const[l,t]=e[a];if(l===n.value&&t.includes(y.value.attr))return"inline"}return""})),L={1:["interval"],2:["interval"],3:["interval"],4:["interval"]},E=e=>{(!/^[0-9]*$/.test(String(e))||e<=0)&&(g.value=1)},C=()=>{""===g.value&&(g.value=1)},S=()=>{""===g.value&&(g.value=y.value.default)},{fields:B}=k("alarm-list-form"),O=e=>{if("9"===n.value&&"cycle"===y.value.attr){if(I(e)){const a=B.value[1].all_items[e-1];B.value[1].items=a,B.value[1].value=""}G(e)}else G(e)},G=e=>{B.value.forEach((a=>{a.attr===y.value.attr&&(a.value=e)}))},P=e=>{if("20"===n.value)switch(e){case 1:B.value[2].unit="GB",B.value[2].name="占用超过";break;case 2:B.value[2].unit="%",B.value[2].name="占用率超过"}},R=t((()=>{const e=Object.entries(L);for(let a=0;a<e.length;a++){const[l,t]=e[a];if(l===n.value&&t.includes(y.value.attr))return!1}return!0}));return(e,a)=>{const l=U,t=D,u=j,f=H;return d(R)?(s(),c(f,{key:0,label:d(y).name,class:M(d(T))},{default:i((()=>["number"===d(y).type?(s(),r(m,{key:0},[o(l,{modelValue:d(g),"onUpdate:modelValue":a[0]||(a[0]=e=>p(g)?g.value=e:null),modelModifiers:{number:!0},type:"number",class:"!w-[15rem]","text-type":d(y).unit,onInput:E,onBlur:C},{append:i((()=>[b(w(d(y).unit),1)])),_:1},8,["modelValue","text-type"]),d(y).suffix?(s(),r("div",{key:0,innerHTML:d(y).suffix,class:"ml-[1rem]"},null,8,$)):_("",!0)],64)):_("",!0),"textarea"===d(y).type?(s(),r(m,{key:1},[o(l,{modelValue:d(g),"onUpdate:modelValue":a[1]||(a[1]=e=>p(g)?g.value=e:null),type:"textarea","text-type":d(y).unit,class:"!w-[15rem]",onBlur:S},{append:i((()=>[b(w(d(y).unit),1)])),_:1},8,["modelValue","text-type"]),d(y).suffix?(s(),r("div",{key:0,innerHTML:d(y).suffix,class:"ml-[1rem]"},null,8,A)):_("",!0)],64)):_("",!0),"select"===d(y).type||"cascader"===d(y).type?(s(),c(X,{key:2,data:d(y),tid:d(n),value:d(g),cycles:h,"onUpdate:value":O},null,8,["data","tid","value"])):_("",!0),"help"===d(y).type?(s(),r("ul",{key:3,class:"help-info-text c7",style:x(d(y).style)},[(s(!0),r(m,null,v(d(y).list,(e=>(s(),r("li",{key:e},w(e),1)))),128))],4)):_("",!0),"radio"===d(y).type?(s(),c(u,{key:4,modelValue:d(g),"onUpdate:modelValue":a[2]||(a[2]=e=>p(g)?g.value=e:null)},{default:i((()=>[(s(!0),r(m,null,v(d(y).items,((e,a)=>(s(),c(t,{value:e.value,key:a,onChange:P},{default:i((()=>[b(w(e.title),1)])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"])):_("",!0)])),_:1},8,["label","class"])):_("",!0)}}}),[["__scopeId","data-v-63ad8852"]]),Z={key:0,class:"ml-10px text-12px text-[#666]"},ee={class:"mb-[1.6rem]"},ae={class:"w-35rem"},le=P(e({__name:"index",props:{compData:{}},emits:["close"],setup(e,{expose:n,emit:h}){const k=e,w=h,{compData:x}=l(k),D=a(""),j=a([]),G=a([]),I=a(!1),P=["dingding","mail","sms","wx_account","feishu","weixin"],J=a([]),Q=T({method:[],send_interval:0,time_range:[(new Date).setHours(0,0,0,0),(new Date).setHours(23,59,59,0)],day_num:0,total:0});a();const Y=(e,a)=>(0===a&&(D.value=e.tid,te()),{label:e.title,value:e.tid}),W=e=>{G.value.map((a=>{a.attr===e.attr&&(a.value=e.val)}))},X=e=>{let a={};for(let l in e)if("object"==typeof e[l]&&null!==e[l]){let t=X(e[l]);a={...a,...t}}else a["".concat(l)]=e[l];return a},$=t((()=>{var e;const a={};return null==(e=j.value)||e.forEach((e=>{a[e.tid]=e})),a})),A=t((()=>$.value[D.value])),le=t((()=>{var e,a;const l=X((null==(e=A.value)?void 0:e.advancedShow)||{});return k.compData.isEdit||null==(a=Object.entries(l))||a.forEach((([e,a])=>{Q[e]=a})),l})),te=()=>{C((()=>{A.value&&(J.value=P.filter((e=>{if(!A.value.module.includes(e))return e})),G.value=A.value.field.map((e=>{var a;let l=e.default;return"select"!==e.type||e.default||(l=(null==(a=e.items[0])?void 0:a.value)||""),{...e,value:l}})))}))},ue=e=>{const a=new Date(e),l=a.getFullYear(),t=a.getMonth()+1,u=a.getDate(),n=new Date(l,t-1,u).getTime();return Math.floor((e-n)/1e3)},ne=e=>{const a=new Date,l=a.getFullYear(),t=a.getMonth(),u=a.getDate();return new Date(l,t,u).getTime()+1e3*e},se=t((()=>{var e,a;const{diyProcessTemplate:l,diyProcessTemplateTid:t}=k.compData;return l&&(null==t?void 0:t.length)?null==(e=j.value)?void 0:e.filter((e=>t.includes(e.tid))).map(Y):null==(a=j.value)?void 0:a.map(Y)})),re=()=>{const e={},a=A.value;return e.tid=a.tid,e.type=a.type,e.title=a.title,e.status=!0,e.count=0,e.interval=600,e.project="",G.value.forEach((a=>e[a.attr]=a.value)),e},de=async()=>{try{const e=oe();await q({loading:"正在添加告警任务，请稍候...",request:z(e),message:!0,success:e=>{var a,l;e.status&&(D.value=se.value[0].value,te(),Q.method=[],Q.send_interval=0,Q.time_range=[(new Date).setHours(0,0,0,0),(new Date).setHours(23,59,59,0)],Q.day_num=0,Q.total=0,(null==(a=x.value)?void 0:a.onRefresh)&&(null==(l=x.value)||l.onRefresh()),w("close"))}})}catch(e){}},oe=()=>{const e=A.value,{isEdit:a,row:l}=x.value,t={template_id:e.tid,task_data:{task_data:re(),sender:Q.method,number_rule:{day_num:Q.day_num,total:Q.total}}};return t.task_data.time_rule={send_interval:Q.send_interval,time_range:0!=Q.time_range[1]?[ue(Q.time_range[0]),ue(Q.time_range[1])]:[]},t.task_data=JSON.stringify(t.task_data),a&&(t.task_id=l.id),t},ie=async()=>{try{j.value=await N()||[];const{isEdit:e,row:a}=x.value;if(e){const e=a.sender.map((e=>e));Q.method=e,Q.day_num=a.number_rule.day_num||0,Q.total=a.number_rule.total||0,Q.send_interval=a.time_rule.send_interval||0,a.time_rule&&a.time_rule.time_range&&a.time_rule.time_range.length>0?Q.time_range=[ne(a.time_rule.time_range[0]),ne(a.time_rule.time_range[1])]:Q.time_range=[(new Date).setHours(0,0,0,0),(new Date).setHours(23,59,59,0)],C((()=>(e=>{D.value=e.template_id,te(),C((()=>{G.value.map((a=>{var l;if(F(e.task_data,a.attr)&&(a.value=e.task_data[a.attr]),"9"==D.value&&"cycle"===a.attr&&"number"==typeof a.value){const e=null==(l=G.value[1])?void 0:l.all_items[a.value-1];G.value[1].items=e}if("20"===D.value&&"count"===a.attr&&G.value[1]&&G.value[2]){const e=1===G.value[1].value;G.value[2].name=e?"占用超过":"占用率超过",G.value[2].unit=e?"GB":"%"}}))}))})(a)))}}catch(e){}};return L("alarm-list-form",{fields:G}),u((()=>ie())),n({onConfirm:async()=>{try{if(!Q.method.length)return void R.error("请选择告警类型");if(!x.value.isEdit)return void de();const e=oe();return(await q({loading:"正在编辑告警任务，请稍候...",request:z(e),message:!0,success:e=>{var a;e.status&&x.value.onRefresh&&(null==(a=x.value)||a.onRefresh())}})).status}catch(e){return!1}}}),(e,a)=>{const l=g,t=V,u=H,n=U,h=O,k=S,w=B;return s(),c(w,{class:"p-[20px]"},{default:i((()=>[o(u,{label:"任务类型"},{default:i((()=>[o(t,{modelValue:d(D),"onUpdate:modelValue":a[0]||(a[0]=e=>p(D)?D.value=e:null),class:"!w-[248px]",onChange:a[1]||(a[1]=e=>te())},{default:i((()=>[(s(!0),r(m,null,v(d(se),(e=>(s(),r(m,null,["MySQL数据库密码到期"!==e.label&&"MySQL主从复制异常告警"!==e.label?(s(),c(l,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])):_("",!0)],64)))),256))])),_:1},8,["modelValue"]),"site_push@8"===d(D)?(s(),r("span",Z," * 当检测到新的版本时发送一次通知 ")):_("",!0)])),_:1}),(s(!0),r(m,null,v(d(G),(e=>(s(),c(K,{key:d(D)+"_"+e.name+"_"+e.attr,value:e.value,tid:d(D),data:e,"onUpdate:value":W},null,8,["value","tid","data"])))),128)),f("div",ee,[d(le).day_num?(s(),c(u,{key:0,label:"每日发送上限"},{default:i((()=>[o(n,{modelValue:d(Q).day_num,"onUpdate:modelValue":a[2]||(a[2]=e=>d(Q).day_num=e),modelModifiers:{number:!0},type:"number","text-type":"次",class:"!w-[15rem]"},{append:i((()=>a[11]||(a[11]=[b(" 次 ")]))),_:1},8,["modelValue"])])),_:1})):_("",!0),d(le).total?(s(),c(u,{key:1,label:"总发送上限"},{default:i((()=>[o(n,{modelValue:d(Q).total,"onUpdate:modelValue":a[3]||(a[3]=e=>d(Q).total=e),modelModifiers:{number:!0},type:"number","text-type":"次",class:"!w-[15rem]"},{append:i((()=>a[12]||(a[12]=[b(" 次 ")]))),_:1},8,["modelValue"])])),_:1})):_("",!0),d(le).send_interval?(s(),c(u,{key:2,label:"最小发送间隔"},{default:i((()=>[o(n,{modelValue:d(Q).send_interval,"onUpdate:modelValue":a[4]||(a[4]=e=>d(Q).send_interval=e),modelModifiers:{number:!0},"text-type":"秒",type:"number",class:"!w-[15rem]"},{append:i((()=>a[13]||(a[13]=[b(" 秒 ")]))),_:1},8,["modelValue"])])),_:1})):_("",!0)]),o(u,{label:"告警方式"},{default:i((()=>[o(h,{class:"!w-[30rem]",modelValue:d(Q).method,"onUpdate:modelValue":a[5]||(a[5]=e=>d(Q).method=e),limit:d(J)},null,8,["modelValue","limit"])])),_:1}),o(u,{class:"!my-[1rem]",label:" "},{default:i((()=>[f("span",{class:"bt-link",onClick:a[6]||(a[6]=e=>I.value=!d(I))},[a[14]||(a[14]=b("高级设置")),f("span",{class:M(d(I)?"svgtofont-el-arrow-up":"svgtofont-el-arrow-down")},null,2)])])),_:1}),y(f("div",null,[d(le).day_num?_("",!0):(s(),c(u,{key:0,label:"每日发送上限"},{default:i((()=>[o(n,{modelValue:d(Q).day_num,"onUpdate:modelValue":a[7]||(a[7]=e=>d(Q).day_num=e),modelModifiers:{number:!0},"text-type":"次",type:"number",class:"!w-[15rem]"},{append:i((()=>a[15]||(a[15]=[b(" 次 ")]))),_:1},8,["modelValue"])])),_:1})),d(le).total?_("",!0):(s(),c(u,{key:1,label:"总发送上限"},{default:i((()=>[o(n,{modelValue:d(Q).total,"onUpdate:modelValue":a[8]||(a[8]=e=>d(Q).total=e),modelModifiers:{number:!0},"text-type":"次",type:"number",class:"!w-[15rem]"},{append:i((()=>a[16]||(a[16]=[b(" 次 ")]))),_:1},8,["modelValue"])])),_:1})),d(le).send_interval?_("",!0):(s(),c(u,{key:2,label:"最小发送间隔"},{default:i((()=>[o(n,{modelValue:d(Q).send_interval,"onUpdate:modelValue":a[9]||(a[9]=e=>d(Q).send_interval=e),modelModifiers:{number:!0},"text-type":"秒",type:"number",class:"!w-[15rem]"},{append:i((()=>a[17]||(a[17]=[b(" 秒 ")]))),_:1},8,["modelValue"])])),_:1})),o(u,{label:"可发送时间范围"},{default:i((()=>[f("div",ae,[o(k,{modelValue:d(Q).time_range,"onUpdate:modelValue":a[10]||(a[10]=e=>d(Q).time_range=e),"is-range":"","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",placeholder:"选择时间范围"},null,8,["modelValue"])])])),_:1})],512),[[E,d(I)]])])),_:1})}}}),[["__scopeId","data-v-a17c17a1"]]);export{le as default};
