import{c as e,j as a,b as t,e as l,u as s,_ as n,h as r,a4 as u,G as o,M as i,ah as c,o as m,a6 as p}from"./utils-lib.js?v=1734676359";import{c as d,o as v,B as g,C as y,p as f,k as h,l as x,I as b,v as w,z as _,q as k,e as j,y as V,x as C,r as I,h as E,w as S,J as L,D as z,b7 as F,A as T,aj as P,aw as U,t as B,M as N,G as q,aY as R,Q as H,a7 as G,a4 as M,g as O,i as A,n as D}from"./base-lib.js?v=1734676359";import{_ as J,f as Q,p as Y}from"./validator.js?v=1734676359";import{_ as K}from"./index.vue_vue_type_script_setup_true_lang20.js?v=1734676359";import{_ as W}from"./index101.js?v=1734676359";import{u as X,S as Z}from"./useStore7.js?v=1734676359";import{_ as $}from"./index88.js?v=1734676359";import{i as ee}from"./useController4.js?v=1734676359";import{A as ae}from"./index276.js?v=1734676359";import{getSiteErrorLogs as te,getSpringBootLogList as le,getSpringBootLog as se,changeSiteLogPath as ne,setPushTask as re,getSiteLogPushStatus as ue,getIpArea as oe,getSiteLogs as ie,getSiteLogFile as ce}from"./site.js?v=1734676359";const me={class:"h-full"},pe={key:0,class:"mb-[16px]"},de={class:"flex"},ve={key:1,class:"bg-[#7F7F7F] flex items-center justify-center h-full",style:{"min-height":"500px"}},ge={class:"bg-white px-[48px] py-[16px] text-[#333] flex items-center"},ye=d({__name:"error-log",setup(a,{expose:t}){const{isBindExtranet:l,siteType:s}=X(),{jumpTabEvent:n}=Z();return v(ya),t({init:ya}),(a,t)=>{const r=e,u=g("bt-loading");return y((h(),x("div",me,[f(l)?(h(),x(b,{key:0},["proxy"===f(s)?(h(),x("div",pe,"日志大小："+w(f(ua).size),1)):_("",!0),k("div",de,[j(W,{content:f(ua).logs,isHtml:!0,fullScreen:{title:"全屏查看[错误]日志",onRefresh:f(ya)},style:{height:"56rem",width:"99.5%"}},null,8,["content","fullScreen"])])],64)):(h(),x("div",ve,[k("div",ge,[t[2]||(t[2]=V(" 请开启 ")),j(r,{class:"mx-[.4rem]",onClick:t[0]||(t[0]=e=>f(n)("mapping"))},{default:C((()=>t[1]||(t[1]=[V(" 外网映射 ")]))),_:1}),t[3]||(t[3]=V(" 后查看 "))])]))])),[[u,f(ra)]])}}}),fe={class:"mr-[10px]"},he={class:"flex items-center"},xe={class:"flex items-center"},be={class:"text-primary"},we={class:"flex flex-col text-[#666] p-12px"},_e={class:"flex items-center"},ke={class:"flex items-center mt-[8px] w-full"},je=l(d({__name:"index",props:{refreshFn:{type:Function,default:()=>({})},sessionConfig:{default:()=>{}}},emits:["save"],setup(e,{emit:l}){const s=e,n=t(),r=l,u=I(!1),o=I(),i=I(!0),c=I(0),m=I(100),p=I(5),d=I(5),v=E({status:!1,time:5,timer:0}),g=async e=>{v.status=e,v.time=d.value,(!v.time||v.time<1)&&(v.time=5,d.value=5),e?(v.timer=setInterval((()=>{s.refreshFn()}),1e3*d.value),c.value=setInterval((()=>{p.value--,0===p.value&&(p.value=d.value),m.value=p.value/d.value*100}),1e3)):(clearInterval(v.timer),clearInterval(c.value),p.value=d.value,m.value=100,i.value||n.success("关闭成功")),r("save",v)},b=async()=>{v.time<1?n.error("时间间隔不能小于1秒"):(p.value=v.time,d.value=v.time,n.success("保存成功"),clearInterval(v.timer),clearInterval(c.value),g(!0),r("save",v))},B=async()=>{await s.refreshFn(),n.success("刷新成功")},N=()=>{u.value=!1,v.time=d.value};return S((()=>s.sessionConfig),(e=>{o.value=e,(null==e?void 0:e.time)&&i.value&&(d.value=e.time,p.value=e.time,g(e.status),i.value=!1)}),{deep:!0}),(e,t)=>{const l=F,s=T,n=P,r=a,o=U;return h(),x("div",fe,[k("div",he,[j(s,{class:"h-[3.2rem] refresh-btn",onClick:B},{default:C((()=>[k("div",xe,[f(v).status?(h(),L(l,{key:0,class:"mr-8px",width:22,"show-text":!0,"stroke-width":1,type:"circle",color:"#20a53a","text-color":"#20a53a",percentage:f(m)},{default:C((()=>[k("span",be,w(Number(f(p))),1)])),_:1},8,["percentage"])):_("",!0),t[3]||(t[3]=k("span",null,"刷新日志",-1))])])),_:1}),j(o,{placement:"bottom-start",width:"280",trigger:"click","popper-class":"el-tooltip-white",onHide:N},{reference:C((()=>[j(s,{class:"down-button !ml-0",onClick:t[2]||(t[2]=e=>u.value=!f(u))},{default:C((()=>t[7]||(t[7]=[k("i",{class:"svgtofont-el-arrow-down"},null,-1)]))),_:1})])),default:C((()=>[k("div",we,[k("div",_e,[t[4]||(t[4]=k("span",{class:"mr-4px"},"定时刷新",-1)),j(n,{modelValue:f(v).status,"onUpdate:modelValue":t[0]||(t[0]=e=>f(v).status=e),onChange:g},null,8,["modelValue"])]),y(k("div",ke,[t[6]||(t[6]=k("span",{class:"mr-4px flex-nowrap"},"时间间隔",-1)),j(r,{modelValue:f(v).time,"onUpdate:modelValue":t[1]||(t[1]=e=>f(v).time=e),"text-type":"秒",min:1,type:"number",class:"!w-[10rem]"},null,8,["modelValue"]),j(s,{class:"!ml-4px",type:"primary",onClick:b},{default:C((()=>t[5]||(t[5]=[V(" 保存 ")]))),_:1})],512),[[z,f(v).status]])])])),_:1})])])}}}),[["__scopeId","data-v-6f46a916"]]),Ve={class:"h-full"},Ce={key:0,class:"flex items-center justify-between pb-1.6rem"},Ie={class:"flex items-center"},Ee={class:"ml-[8px]"},Se={class:"flex items-center"},Le={class:"flex items-center p-[12px]"},ze={key:1,class:"mb-[16px]"},Fe={key:2,class:"mt-1rem"},Te={key:1,class:"bg-[#7F7F7F] flex items-center justify-center h-full",style:{"min-height":"500px"}},Pe={class:"bg-white px-[48px] py-[16px] text-[#333] flex items-center"},Ue={class:"p-[20px]"},Be=d({__name:"response-log",setup(t,{expose:l}){const{plugin:u}=s(),{webserver:o}=B(u.value),{isBindExtranet:i,siteType:c}=X(),{jumpTabEvent:m}=Z();return v(Ga),l({init:Ga}),(t,l)=>{const s=P,u=R,p=n,d=H,v=$,I=T,E=U,S=je,L=e,z=a,F=G,B=M,O=r,A=g("bt-loading");return h(),x("div",Ve,[f(i)?(h(),x(b,{key:0},["proxy"!==f(c)?(h(),x("div",Ce,[y((h(),x("div",Ie,["python"!==f(c)?(h(),x(b,{key:0},[j(s,{onChange:f(Pa),modelValue:f(Va).alert,"onUpdate:modelValue":l[0]||(l[0]=e=>f(Va).alert=e)},null,8,["onChange","modelValue"]),k("span",Ee,[l[13]||(l[13]=V(" 关键字告警 ")),k("span",{class:"!inline-block bt-link",onClick:l[1]||(l[1]=(...e)=>f(qa)&&f(qa)(...e))}," [配置] ")]),j(u,{direction:"vertical",class:"!h-2rem !mx-1.6rem"})],64)):_("",!0),j(d,{onChange:f(Ta),modelValue:f(Va).showIp,"onUpdate:modelValue":l[2]||(l[2]=e=>f(Va).showIp=e)},{default:C((()=>[k("div",Se,[l[14]||(l[14]=V(" 显示IP归属地信息 ")),j(p,{icon:"icon-ltd",size:16,color:"#9B7E48",class:"ml-[4px]"})])])),_:1},8,["onChange","modelValue"]),"php"===f(c)?(h(),x(b,{key:1},[j(u,{direction:"vertical",class:"!h-2rem !mx-1.6rem"}),j(E,{trigger:"click",placement:"bottom","popper-class":"white-tips-popover",width:"400",visible:f(ja),"onUpdate:visible":l[5]||(l[5]=e=>N(ja)?ja.value=e:null)},{reference:C((()=>[j(I,{type:"default"},{default:C((()=>l[16]||(l[16]=[V("更改日志路径")]))),_:1})])),default:C((()=>[k("div",Le,[j(v,{placeholder:"请输入日志路径",modelValue:f(ka),"onUpdate:modelValue":l[3]||(l[3]=e=>N(ka)?ka.value=e:null),onIconClick:f(za),icon:"el-folder-opened"},null,8,["modelValue","onIconClick"]),j(I,{type:"primary",class:"!ml-[8px]",onClick:l[4]||(l[4]=e=>f(Fa)())},{default:C((()=>l[15]||(l[15]=[V(" 保存 ")]))),_:1})])])),_:1},8,["visible"])],64)):_("",!0)])),[[A,f(ra)]]),j(S,{refreshFn:f(Ra)},null,8,["refreshFn"])])):_("",!0),"proxy"===f(c)?(h(),x("div",ze,"日志大小："+w(f(Va).size),1)):_("",!0),y(j(W,{content:f(Va).logs,isHtml:!0,fullScreen:{title:"全屏查看[响应]日志",onRefresh:f(Ra)},style:q({height:"php"===f(c)?"52rem":"56rem",width:"99.5%"})},null,8,["content","fullScreen","style"]),[[A,f(ra)]]),"nginx"===f(o)&&"php"===f(c)?(h(),x("div",Fe,[l[17]||(l[17]=V(" * 若网站开启cdn导致日志")),l[18]||(l[18]=k("span",{class:"text-danger"},"来源IP",-1)),l[19]||(l[19]=V("解析错误，可前往[ ")),k("span",{class:"cursor-pointer bt-link",onClick:l[6]||(l[6]=e=>f(ee)("globalSetting"))},"全局设置"),l[20]||(l[20]=V(" ]打开cdn来源IP解析 "))])):_("",!0)],64)):(h(),x("div",Te,[k("div",Pe,[l[22]||(l[22]=V(" 请开启 ")),j(L,{class:"mx-[.4rem]",onClick:l[7]||(l[7]=e=>f(m)("mapping"))},{default:C((()=>l[21]||(l[21]=[V(" 外网映射 ")]))),_:1}),l[23]||(l[23]=V(" 后查看 "))])])),j(O,{title:"关键字告警配置",onConfirm:l[11]||(l[11]=e=>f(Ba)(f(Sa),"confirm")),onCancel:f(Ua),modelValue:f(Ia),"onUpdate:modelValue":l[12]||(l[12]=e=>N(Ia)?Ia.value=e:null),area:46,showFooter:""},{default:C((()=>[k("div",Ue,[j(B,{"label-position":"right",model:f(Sa),rules:f(La),ref_key:"alertSetFormRef",ref:Ea},{default:C((()=>[j(F,{label:"周期",prop:"cycle"},{default:C((()=>[j(z,{modelValue:f(Sa).cycle,"onUpdate:modelValue":l[8]||(l[8]=e=>f(Sa).cycle=e),type:"number",min:1,width:"24rem","text-type":"分钟"},null,8,["modelValue"])])),_:1}),j(F,{label:"关键字",prop:"keys"},{default:C((()=>[j(z,{modelValue:f(Sa).keys,"onUpdate:modelValue":l[9]||(l[9]=e=>f(Sa).keys=e),type:"textarea",resize:"none",row:6,width:"24rem"},null,8,["modelValue"])])),_:1}),j(F,{label:"告警方式",prop:"channel"},{default:C((()=>[j(J,{modelValue:f(Sa).channel,"onUpdate:modelValue":l[10]||(l[10]=e=>f(Sa).channel=e),multiple:!0,class:"!w-[24rem]"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"]),l[24]||(l[24]=k("ul",{class:"mt-[8px] leading-8 text-[1.2rem] list-disc ml-[20px]"},[k("li",null,"检查时只检查间隔时间内的日志内容"),k("li",null,"周期时间请勿设置太小，建议10分钟以上以免导致服务器资源异常")],-1))])])),_:1},8,["onCancel","modelValue"])])}}}),Ne={key:1,class:"bg-[#7F7F7F] flex items-center justify-center h-full",style:{"min-height":"500px"}},qe={class:"bg-white px-[48px] py-[16px] text-[#333] flex items-center"},Re=d({__name:"safe-analysis",setup(a){const{isBindExtranet:t,siteInfo:l}=X(),{jumpTabEvent:s}=Z();return(a,n)=>{const r=e;return h(),x("div",null,[f(t)?(h(),L(ae,{key:0,type:"site",name:f(l).name},null,8,["name"])):(h(),x("div",Ne,[k("div",qe,[n[2]||(n[2]=V(" 请开启 ")),j(r,{class:"mx-[.4rem]",onClick:n[0]||(n[0]=e=>f(s)("mapping"))},{default:C((()=>n[1]||(n[1]=[V(" 外网映射 ")]))),_:1}),n[3]||(n[3]=V(" 后查看 "))])]))])}}}),He={class:"flex flex-col"},Ge={class:"flex items-center"},Me={class:"mt-[16px]"},Oe={class:"p-[12px] w-full flex items-start overflow-y-auto h-full"},Ae=["innerHTML"],De=d({__name:"spring-boot-logs",setup(e,{expose:a}){const{mainHeight:t}=s();return v(_a),a({init:_a}),(e,a)=>{const l=u,s=T,n=r,o=g("bt-loading");return y((h(),x("div",He,[k("div",Ge,[a[2]||(a[2]=k("span",null,"日志路径",-1)),j(l,{modelValue:f(pa).path,"onUpdate:modelValue":a[0]||(a[0]=e=>f(pa).path=e),options:f(oa),onChange:f(ha),placeholder:"请选择",class:"!w-[38rem] !mx-[.8rem]"},null,8,["modelValue","options","onChange"])]),k("div",Me,[k("div",null,[j(s,{type:"primary",onClick:f(fa)},{default:C((()=>a[3]||(a[3]=[V("刷新日志")]))),_:1},8,["onClick"]),j(s,{type:"default",onClick:f(ba)},{default:C((()=>a[4]||(a[4]=[V("实时日志")]))),_:1},8,["onClick"])]),j(W,{title:"全屏查看【项目】日志",content:f(pa).logs,isHtml:!0,fullScreen:{title:"全屏查看【项目】日志",onRefresh:f(fa)},class:"mt-[16px]",style:q({height:"java"===f(ia)?"48rem":"64rem",width:"99.5%"})},null,8,["content","fullScreen","style"])]),j(n,{title:"查看日志",onCancel:f(wa),modelValue:f(ca),"onUpdate:modelValue":a[1]||(a[1]=e=>N(ca)?ca.value=e:null),area:["100%","100%"],"close-btn":1},{default:C((()=>[k("div",{ref_key:"logPopupCon",ref:ma,class:"bg-[#333] text-white w-full h-full",style:q("height: ".concat(f(t),"px;"))},[k("pre",Oe,[a[5]||(a[5]=V("\t\t\t\t\t")),k("code",{class:"flex-1 w-full p-0 bg-none whitespace-pre-line text-i text-[#ececec]",innerHTML:f(pa).logs},null,8,Ae),a[6]||(a[6]=V("\n\t\t\t\t"))])],4)])),_:1},8,["onCancel","modelValue"])])),[[o,f(ra)]])}}}),Je=O("SITE-LOGS-STORE",(()=>{const{siteType:e,siteInfo:a}=X();return{getErrorLogsEvent:async a=>{try{const{data:t}=await te(a,e.value);return{data:t,status:!0}}catch(t){return{msg:"获取错误日志失败",status:!1}}},getSpringLogEvent:async e=>{try{const{data:a}=await le(e);return{data:a.data,status:a.status}}catch(a){return{msg:"获取日志失败",status:!1}}},setSpringPathEvent:async e=>{try{const{data:a}=await se(e);return{status:a.status,msg:a.data}}catch(a){return{msg:"保存路径失败",status:!1}}},saveResLogPathEvent:async e=>{try{const a=await o({loading:"正在保存日志路径，请稍后...",request:ne(e),message:!0});return{status:a.status,msg:a.msg}}catch(a){return{msg:"保存路径失败",status:!1}}},setPushTaskEvent:async e=>{try{const a=await o({loading:"正则处理中，请稍后...",request:re(e),message:!0});return{status:a.status,msg:a.msg}}catch(a){return{status:!1,msg:"推送失败"}}},getLogPushEvent:async()=>{try{return{data:await o({request:ue({sitename:a.value.name}),data:{status:Boolean,"config.cycle":[Number,"cycle"],"config.keys":[Array,"keys"],"config.channel":[String,"channel"]}}),status:!0}}catch(e){return{msg:"获取推送配置失败",status:!1}}},getIpStatusEvent:async()=>{try{return{data:(await o({request:oe(),data:{msg:[Number,"msg"]}})).msg,status:!0}}catch(e){return{msg:"获取IP归属地失败",status:!1}}},getResLogEvent:async a=>{try{const t=await ie(a,e.value);return{data:t.data,status:t.status}}catch(t){return{msg:"获取日志失败",status:!1}}}}})),{payment:Qe}=s(),{authType:Ye}=B(Qe.value),{getErrorLogsEvent:Ke,getSpringLogEvent:We,setSpringPathEvent:Xe,saveResLogPathEvent:Ze,setPushTaskEvent:$e,getLogPushEvent:ea,getIpStatusEvent:aa,getResLogEvent:ta}=Je(),{siteType:la,siteInfo:sa,isBindExtranet:na}=X(),ra=I(!1),ua=I({logs:"",size:"0 b"}),oa=I([]),ia=I(""),ca=I(!1),ma=I(null),pa=E({path:"",logs:"",type:"",size:"",isNew:!1,isGunicorn:!1}),da=A((()=>{var e;return(null==(e=sa.value)?void 0:e.tabName)||("java"===la.value?"projectLog":"response")})),va=I([{label:"响应日志",name:"response",lazy:!0,render:()=>j(Be,null,null)},{label:"错误日志",name:"error",lazy:!0,render:()=>j(ye,null,null)},{label:"日志安全分析",name:"safe",lazy:!0,render:()=>j(Re,null,null)}]),ga=()=>{var e,a,t,l;"java"===la.value?(va.value.some((e=>"projectLog"===e.name))||va.value.unshift({label:"项目日志",name:"projectLog",lazy:!0,render:()=>j(K,null,null)}),"springboot"===(null==(a=null==(e=sa.value)?void 0:e.project_config)?void 0:a.java_type)&&(va.value.some((e=>"springbootLog"===e.name))||va.value.push({label:"springBoot日志",name:"springbootLog",lazy:!0,render:()=>j(De,null,null)}))):va.value=va.value.filter((e=>"projectLog"!==e.name&&"springbootLog"!==e.name));["php","proxy","html"].includes(la.value)?na.value=!0:na.value=!!(null==(l=null==(t=sa.value)?void 0:t.project_config)?void 0:l.bind_extranet)},ya=async()=>{var e,a;if(!na.value)return;const t=sa.value.name,l=la.value,s={proxy:{site_name:t,type:"error"},default:{siteName:t}};try{ra.value=!0;const t=await Ke(s[l]||s.default);return"proxy"===l&&(ua.value.size=t.data.size||"0 b"),ua.value.logs=(null==(e=t.data)?void 0:e.logs)||(null==(a=t.data)?void 0:a.msg)||"暂无日志信息",t}catch(n){return c(n),{msg:"获取错误日志失败",status:!1}}finally{ra.value=!1}},fa=async()=>{ra.value=!0;try{const e={project_name:sa.value.name},{data:a,status:t}=await We(e);t&&(oa.value=a.map((e=>({label:e,value:e}))),pa.logs="正在获取日志",pa.path=(null==a?void 0:a[0])||"",ha())}catch(e){}finally{ra.value=!1}},ha=async e=>{try{if(!pa.path)return pa.logs="暂未在SpringBoot框架中查找到日志配置信息",!1;const e=await Xe({log_file:pa.path});return e.status||i.error(e.msg),pa.logs=e.msg||"获取日志失败",e}catch(a){return{msg:"保存路径失败",status:!1}}};let xa=null;const ba=()=>{ca.value=!0,D((()=>{ma.value&&(ma.value.scrollTop=ma.value.scrollHeight)})),xa&&clearInterval(xa),xa=setInterval((()=>{fa()}),2e3)},wa=()=>{ca.value=!1,clearInterval(xa),xa=null},_a=()=>{var e,a;ia.value="java",pa.type=(null==(e=sa.value.project_config)?void 0:e.loglevel)||"",pa.isGunicorn="gunicorn"===(null==(a=sa.value.project_config)?void 0:a.stype),fa()},ka=I(""),ja=I(!1),Va=E({alert:!1,showIp:!1,ipData:0,logs:"",size:"0 b"}),Ca=I(!1),Ia=I(!1),Ea=I(),Sa=E({cycle:0,keys:"",channel:[]}),La=E({cycle:[{required:!0,message:"请输入周期",trigger:"blur"}],keys:[{required:!0,message:"请输入关键字",trigger:"blur"}],channel:[{required:!0,message:"请选择告警方式",trigger:"blur"}]}),za=()=>{Q({type:"dir",path:ka.value,change:e=>{ka.value=e,setTimeout((()=>{ja.value=!0}),0)}})},Fa=async(e={site_name:sa.value.name,log_path:ka.value})=>{await m({title:"保存日志路径",content:"是否保存日志路径[".concat(ka.value,"]")});(await Ze({site_name:sa.value.name,log_path:ka.value})).status&&(Ra(),Ha(),ja.value=!1)},Ta=async()=>{"ltd"!==Ye.value?(Va.showIp=!1,Y({disablePro:!0,sourceId:184})):Ra()},Pa=async e=>{Ca.value=!0,e?Ia.value=!0:Ba({},"switch")},Ua=()=>{Ca.value&&(Va.alert=!Va.alert,Ca.value=!1)},Ba=async(e,a)=>{try{Ia.value&&await Ea.value.validate();let t={sitename:sa.value.name};"switch"!==a&&(Ca.value||delete t.sitename,t.channel=e.channel.filter((e=>""!==e)).join(","),t.cycle=e.cycle,t.keys=JSON.stringify(p(e.keys)?e.keys.split(","):e.keys));const l=await $e(t);return l.status&&Na(),l.status}catch(t){return!1}},Na=async()=>{try{const e=await ea();let a={};if(e.status){Va.alert=e.data.status;const{cycle:t,keys:l,channel:s}=e.data;a={cycle:t,keys:l,channel:s.split(","),status:e.status}}else Va.alert=!1;return Object.assign(Sa,a),{data:a,status:e.status}}catch(e){return{msg:"获取告警配置失败",status:!1}}},qa=()=>{Ia.value=!0,Na()},Ra=async(e=sa.value.name,a=la.value)=>{"ltd"!==Ye.value&&(Va.showIp=!1);const t={proxy:{site_name:e,type:"access"},default:{siteName:e,ip_area:Number(Va.showIp)}};try{ra.value=!0;const e=await ta(t[a]||t.default);return"proxy"===a?(Va.logs=e.data.msg||"暂无日志信息",Va.size=e.data.size||"0 b"):Va.logs=e.data.msg||"暂无日志信息",e}catch(l){return c(l),{msg:"获取日志失败",status:!1}}finally{ra.value=!1}},Ha=()=>{o({request:ce({siteName:sa.value.name}),data:{log_file:String,status:Boolean,msg:String},success:e=>{ka.value=e.log_file,e.status||i.error(e.msg)}})},Ga=async()=>{na.value&&(await(async()=>{try{const e=await aa();Va.showIp=1===e.data}catch(e){return{msg:"获取IP归属地失败",status:!1}}})(),"python"!==la.value&&await Na(),await Ra(),Ha())};export{Be as _,va as a,ye as b,ga as i,da as t};
