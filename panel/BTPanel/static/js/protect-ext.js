import{ah as e,o as a,G as t,a7 as l,aa as s,j as n,k as o,V as i,O as u,h as p,b as r,e as c}from"./utils-lib.js?v=1734676359";import{c as d,r as m,h,e as v,i as f,y as w,I as _,o as x,B as y,C as g,p as b,k as j,l as V,J as k,z as C,M as q,x as O,q as z,aX as D,R,aj as U,A as M,ag as E,ah as I,a7 as J,a4 as S,w as A}from"./base-lib.js?v=1734676359";import{_ as N}from"./index90.js?v=1734676359";import{_ as T}from"./index99.js?v=1734676359";import{a as B,u as F,c as G}from"./column.js?v=1734676359";import{c as H,v as P}from"./useController3.js?v=1734676359";import{u as X}from"./useStore7.js?v=1734676359";import{getTamperRuleByPath as K,addBlackExts as L,releaseFileExt as Q,syncBlackExts as W,removeBlackExts as Y,getActionLogsForExts as Z,getSiteInfo as $}from"./site.js?v=1734676359";import{_ as ee}from"./masker.vue_vue_type_script_setup_true_lang.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";import"./validator.js?v=1734676359";import"./index116.js?v=1734676359";import"./index.vue_vue_type_style_index_0_scoped_03ce946a_lang.js?v=1734676359";const ae={class:"flex gap-col-1rem"},te={class:"p-2rem"},le=c(d({__name:"protect-ext",props:{compData:{default:{}}},setup(c,{expose:d}){const le=r(),{siteInfo:se}=X(),ne=m("file"),oe=m(),ie=m(!1),ue=m(""),pe=m(!1),re=m({}),ce=m([]),de=m([]),me=m(!1),he=m(!1),ve=m(),fe=m(!1),we=h({sites:[],list:[]}),_e=h({sites:[{required:!0,message:"请选择同步配置",trigger:"blur"}]}),xe=m([{label:"受保护的文件类型",name:"file",lazy:!0,render:()=>v("span",null,null)},{label:"受保护的文件目录",name:"directory",lazy:!0,render:()=>v("span",null,null)}]),ye=f((()=>"file"===ne.value?[{content:"所谓文件类型是指文件名结尾的字符串，不一定是扩展名"},{content:v(_,null,[w("例如"),v("code",null,[w(".php")]),w(","),v("code",null,[w(".html")]),w(","),v("code",null,[w(".js?v=1734676359")]),w(","),v("code",null,[w("index.php")]),w("等")])},{content:v(_,null,[w("例1："),v("code",null,[w(".php")]),w("匹配："),v("code",null,[w("./1.php")]),v("code",null,[w("./test/2.php")]),w("不匹配："),v("code",null,[w("./1.php/1.txt")])])},{content:v(_,null,[w("例2："),v("code",null,[w("index.php")]),w("匹配："),v("code",null,[w("./index.php")]),v("code",null,[w("./test/index.php")]),v("code",null,[w("./abc_index.php")]),w("不匹配："),v("code",null,[w("./index.php.tar.gz")])])}]:[{content:"支持以下4种方式"},{content:v(_,null,[w("1、完整文件路径，如："),v("code",null,[w("/www/wwwroot/test/123.php")])])},{content:v(_,null,[w("2、相对于网站的相对路径，如：全路径是"),v("code",null,[w("/www/wwwroot/test/app/123.php")]),w("相对路径"),v("code",null,[w("./app/123.php")])])},{content:v(_,null,[w("3、指定目录下的所有文件，如："),v("code",null,[w("/www/wwwroot/test/app/*")]),w("相对路径"),v("code",null,[w("./app/*")])])},{content:v(_,null,[w("4、指定目录下的指定文件类型，如："),v("code",null,[w("/www/wwwroot/test/app/*.php")]),w("相对路径"),v("code",null,[w("./app/*.php")])])},{content:v("span",{class:"text-danger"},[w("注意，已经在【受保护的文件类型】中被包含的文件无需专门设置规则")])}])),ge=[{content:v(_,null,[w("【一键应用】将当前网站已配置的"),v("span",{class:"text-danger"},[w("排除目录")]),w("，"),v("span",{class:"text-danger"},[w("防护文件")]),w("，同步配置到其他网站")])}],be=async(e,a,t,l)=>{const{label:s,value:n}=l,o=new Map([["start","批量开启受保护文件类型"],["stop","批量关闭受保护文件类型"],["delete","批量删除受保护文件类型"]]),i=async(e,a)=>{const t=new Map([["start",Q],["stop",Q],["delete",Y]]),{exts:l}=e,{pid:s,path:o}=re.value,i=t.get(n);switch(n){case"start":case"stop":if(i){return i({path_id:s,exts:l,release:"start"===n?1:0})}case"delete":if(i){return i({path_id:s,exts:l,path:o})}}};await e({title:"批量".concat(s),content:"".concat(o.get(n),"，是否继续操作？"),column:[{label:"".concat("file"===ne.value?"文件类型":"文件全路径 或 相对路径"),prop:"exts"},G()],onConfirm:async()=>(await a(i),je(),!1)})},je=async(a=!1)=>{try{a&&(ie.value=!0);const{data:e}=await K({path:se.value.path});let t=[];if(e.hasOwnProperty("status")){re.value=e;let a=e.black_exts,l=e.white_exts;a.forEach((e=>{t.push({exts:e,limit_status:1})})),l.forEach((e=>{t.push({exts:e,limit_status:0})}))}ce.value=t.filter((e=>"file"===ne.value?-1===e.exts.indexOf("/"):-1!==e.exts.indexOf("/")))}catch(t){e(t)}finally{a&&(ie.value=!1)}},Ve=async()=>{if(""===ue.value)return le.error("文件类型不能为空");try{const e=await L({path_id:re.value.pid,path:re.value.path,exts:ue.value});le.request(e),e.status&&(ue.value="",je())}catch(e){}},ke=async(e,l)=>{try{e.limit_status=l?1:0,await a({title:"".concat(l?"开启":"关闭","【").concat(e.exts,"】"),content:"".concat(l?"开启该受保护文件类型后，该类型后缀文件将被保护，是否继续？":"关闭该受保护文件类型后，该类型后缀文件将不被保护，是否继续？"),icon:"warning"});(await t({loading:"正在设置保护文件状态，请稍后...",request:Q({path_id:re.value.pid,exts:e.exts,release:l?0:1}),message:!0})).status&&je()}catch(s){"cancel"===s&&(e.limit_status=l?0:1)}},Ce=async()=>{const e=await t({loading:he,request:$(),data:Array});we.list=e},qe=async()=>{var a;await ve.value.validate();try{let e={};de.value.forEach((a=>{e[a.exts]=a.limit_status}));let t={site_ids:JSON.stringify(we.sites),exts:JSON.stringify(e)};const l=await W(t);me.value=!1,H({title:"批量同步到其他站点",resultData:null==(a=l.data)?void 0:a.value.map((e=>({name:e.name,status:"同步成功"===e.msg,msg:e.msg}))),resultTitle:"批量同步到其他站点操作",showMult:!1})}catch(t){e(t)}},Oe=async e=>{await a({title:"删除受保护的文件类型【"+e.exts+"】",content:"删除受保护的文件类型后，文件名以该后缀结尾的文件将失去保护，是否继续操作？",icon:"warning"});(await t({loading:"正在删除受保护的文件类型，请稍后...",request:Y({path_id:re.value.pid,path:re.value.path,exts:e.exts}),message:!0})).status&&je()},ze=async a=>{var t;try{let e={path_id:re.value.pid,exts:a.exts,row:10,p:1,pid:re.value.pid};const{data:s}=await Z(e);(null==(t=s.data)?void 0:t.length)?P({title:"受保护的文件类型【".concat(a.exts,"】日志"),row:a,data:s,params:{...e,total:l(s.page)}}):le.error("暂无日志")}catch(s){e(s)}},De=e=>{ue.value="",ne.value=e,Re.value[1].label="file"===e?"文件类型":"文件全路径 或 相对路径",je()},Re=R([B(),{prop:"exts",label:"文件路径"},{prop:"limit_status",label:"状态",render:(e,a)=>{let t=1===e.limit_status;return v(U,{size:"small",modelValue:t,"onUpdate:modelValue":e=>t=e,onChange:a=>ke(e,a)},null)}},F([{title:"日志",onClick:ze},{title:"删除",onClick:Oe}])]),Ue=[{label:"开启受保护文件类型",value:"open",event:be},{label:"关闭受保护文件类型",value:"close",event:be},{label:"同步到其他站点",value:"sync",event:async(e,a,t,l,s)=>{de.value=t.value,we.sites=[],me.value=!0,Ce(),A((()=>me.value),(e=>{e||s()}))}},{label:"删除受保护文件类型",value:"delete",event:be}];return x((()=>{je(!0)})),d({init:()=>{je(!0)}}),(e,a)=>{var t;const l=s,r=n,c=M,d=T,m=o,h=i,f=N,x=u,R=E,U=I,A=J,B=S,F=p,G=y("bt-loading");return g((j(),V("div",null,[(null==(t=b(re))?void 0:t.path)?C("",!0):(j(),k(ee,{key:0,compData:{...e.compData,init:je}},null,8,["compData"])),v(l,{ref:"tamperRef",type:"",modelValue:b(ne),"onUpdate:modelValue":a[0]||(a[0]=e=>q(ne)?ne.value=e:null),options:b(xe),onChange:De},null,8,["modelValue","options"]),v(f,null,{"header-left":O((()=>[z("div",ae,[v(r,{modelValue:b(ue),"onUpdate:modelValue":a[1]||(a[1]=e=>q(ue)?ue.value=e:null),width:"30rem",placeholder:"文件类型"},null,8,["modelValue"]),v(c,{type:"primary",onClick:Ve},{default:O((()=>a[4]||(a[4]=[w("添加")]))),_:1})])])),"header-right":O((()=>[v(d,{onRefresh:je})])),content:O((()=>[g(v(m,{ref_key:"protectTableRef",ref:oe,column:b(Re),"max-height":360,data:b(ce)},null,8,["column","data"]),[[G,b(pe)]])])),"footer-left":O((()=>[v(h,{"table-ref":b(oe),options:b(Ue)},null,8,["table-ref","options"])])),"footer-right":O((()=>a[5]||(a[5]=[]))),_:1}),v(x,{class:"ml-2rem mt-2rem tamper-help-info","list-style":"disc",options:b(ye)},null,8,["options"]),v(F,{title:"批量同步到其他站点",modelValue:b(me),"onUpdate:modelValue":a[3]||(a[3]=e=>q(me)?me.value=e:null),area:50,"show-footer":"",onConfirm:qe},{default:O((()=>[z("div",te,[g((j(),k(B,{ref_key:"applyFormRef",ref:ve,model:b(we),rules:b(_e),disabled:b(fe)},{default:O((()=>[v(A,{label:"同步站点",prop:"sites"},{default:O((()=>[v(U,{modelValue:b(we).sites,"onUpdate:modelValue":a[2]||(a[2]=e=>b(we).sites=e),multiple:"","collapse-tags":"",class:"w-30rem",placeholder:"请选择站点"},{default:O((()=>[(j(!0),V(_,null,D(b(we).list,(e=>(j(),V(_,null,[e.id!==b(se).id?(j(),k(R,{key:e.id,label:e.rname,value:e.id},null,8,["label","value"])):C("",!0)],64)))),256))])),_:1},8,["modelValue"])])),_:1})])),_:1},8,["model","rules","disabled"])),[[G,b(he)]]),v(x,{"list-style":"disc",class:"mt-2rem ml-2rem",options:ge})])])),_:1},8,["modelValue"])])),[[G,b(ie)],[G,"正在获取站点防篡改信息，请稍侯","title"]])}}}),[["__scopeId","data-v-e80ff6b3"]]);export{le as default};
