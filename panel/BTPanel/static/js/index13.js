import{l as e,H as a,o as t,b as s,a5 as l,a6 as o,G as n,a7 as i,M as r,u as c,F as u,a8 as p,k as d,V as m,h as _}from"./utils-lib.js?v=1734676359";import{_ as f}from"./index101.js?v=1734676359";import{_ as v}from"./index90.js?v=1734676359";import{_ as h}from"./index97.js?v=1734676359";import{_ as b}from"./index99.js?v=1734676359";import{B as g}from"./index107.js?v=1734676359";import{c as y,r as w,h as k,k as C,l as x,e as T,x as j,C as O,p as q,az as E,A as V,aZ as S,D as R,g as D,s as A,i as B,y as I,o as L,B as M,J as P,q as U,z as W,M as F,aT as N}from"./base-lib.js?v=1734676359";import{g as z,a as J,m as H,r as G,c as Z,e as $,s as K,b as Q,d as X,f as Y,h as ee,i as ae,j as te,k as se,l as le,n as oe,o as ne,p as ie}from"./useMethod2.js?v=1734676359";import{a as re,d as ce,b as ue,o as pe,u as de,c as me}from"./column.js?v=1734676359";import{o as _e}from"./useMethod3.js?v=1734676359";import{c as fe}from"./validator.js?v=1734676359";const ve=y({__name:"index",emits:["upload-success"],setup(l,{expose:o,emit:n}){const i=s(),r=n,c=w(),u=window.location.protocol+"//"+window.location.host+"/crontab?action=import_crontab_from_json",p=k({overwrite:1}),d=w([]),m=[".json"].join(","),_=async(t,s,l)=>{var o,n,c;if(!1!==t.status){{let s=[];null==(o=t.successful_tasks)||o.forEach((e=>{s.push({name:e,status:1,msg:"导入成功"})})),null==(n=t.failed_tasks)||n.forEach((e=>{s.push({name:e,status:0,msg:"导入失败"})})),null==(c=t.skipped_tasks)||c.forEach((e=>{s.push({name:e,status:2,msg:"重复任务已跳过"})})),await e({title:"导入计划任务结果",area:42,component:()=>a((()=>import("./index102.js?v=1734676359")),__vite__mapDeps([]),import.meta.url),compData:{resultData:s,autoTitle:t.msg,resultColumn:[{label:"计划任务名称",prop:"name"},{label:"操作结果",align:"right",render:e=>E("span",{class:1===e.status?"text-primary":0===e.status?"text-danger":""},e.msg)}]}})}r("upload-success")}else i.error(t.msg)},f=()=>{i.error("导入失败")},v={"x-http-token":window.vite_public_request_token},h=async e=>{e.value=e;const a=await t({type:"check",title:"提示",content:"是否继续将文件中的数据导入到现有计划任务中？",check:{content:"跳过重复计划任务",value:!0,onConfirm:e=>{p.overwrite=e?1:0}}});return a&&!p.overwrite&&await t({icon:"warning",title:"提示",content:"导入重复的任务可能会导致系统服务异常，请谨慎操作！"}),a},b=async(e,a)=>{d.value=a},g=(e,a,t)=>{d.value=t.map((t=>(t.uid===a.uid&&(t.percentage=e.percent),t)))};return o({open:()=>{c.value.$el.click()},fileData:p}),(e,a)=>{const t=V,s=S;return C(),x("div",null,[T(s,{class:"upload-demo",ref:"upload",name:"file",data:()=>q(p),action:u,headers:v,accept:q(m),"on-error":f,multiple:!1,"show-file-list":!1,"auto-upload":!0,"on-success":_,"on-progress":g,"file-list":q(d),"on-change":b,"before-upload":h},{default:j((()=>[O(T(t,{ref_key:"openRef",ref:c,size:"small",type:"primary"},null,512),[[R,!1]])])),_:1},8,["data","accept","file-list"])])}}}),he=D("CRONTAB-VIEW-STORE",(()=>({rowData:w({})}))),be=he(),{rowData:ge}=A(be),ye=l({route:"/ws_panel"}),we=w(),ke=w(),Ce=w([]),xe=w(!1),Te=w(0),je=k({p:1,count:20,search:"",type_id:"all",order_param:""}),Oe=w([]),qe=w(!0),Ee=w(!1),Ve=w(""),Se=()=>we.value.open(),Re=B((()=>{const{save:e,sType:a}=ge.value;return!(["enterpriseBackup","logs","special_log","toShell"].includes(a)||!e&&o(e))})),De=async(e,a,t,s,l)=>{const{label:o,value:i}=s,r=o.replace("任务",""),c=async(e,a)=>{const t=new Map([["exec",X],["delete",ne]]),{id:s}=e;switch(i){case"exec":case"delete":const e=t.get(i);if(e)return await e({id:s})}};await e({title:"批量".concat(r,"计划任务"),content:"即将批量".concat(r,"选中的计划任务，是否继续操作?"),column:[{label:"计划任务",prop:"name"},me()],onConfirm:async e=>{switch(i){case"start":case"stop":await(async(e,a)=>{const t=JSON.stringify(a.map((e=>e.id)));e.unmount(),l(),await n({loading:"正在执行，请稍后...",request:oe({id_list:t,type:i,if_stop:"False"}),success:e=>{const a=e.data.map((e=>{const a=Object.entries(e)[0];return{msg:e.status?r+"成功":a[1],name:a[0],status:e.status}}));_e(a,{title:"".concat(r,"计划任务")})}})})(e,t.value);break;case"delete":case"exec":await a(c);break;case"out":await(async(e,a)=>{const t=JSON.stringify(a.map((e=>e.id)));e.unmount(),l(),await n({loading:"正在执行，请稍后...",request:$({ids:t}),success:e=>{window.open("/download?filename="+e.msg.replace("导出成功!,下载路径为",""))}})})(e,t.value)}return Le(),!1}})},Ae=[{label:"执行任务",value:"exec",event:De},{label:"启动任务",value:"start",event:De},{label:"停止任务",value:"stop",event:De},{label:"设置分类",value:"setClass",event:async(e,a,t,s,l)=>{await fe({name:"计划任务分类",options:Oe.value.filter((e=>"all"!==e.value&&e.value>0)),selectList:t.value,request:async(e,a)=>{const s=JSON.stringify(t.value.map((e=>e.id)));await n({loading:"正在批量设置分类，请稍后...",request:K({id:e.id,crontab_ids:s}),message:!0}),l(),a(),Le()}})}},{label:"导出任务",value:"out",event:De},{label:"删除任务",value:"delete",event:De}],Be=async e=>{try{const{data:a}=await te({id:ge.value.id});a.status?(pe({path:a.msg}),e&&e()):r.request(a)}catch(a){}},Ie=({column:e,prop:a,order:t})=>{je.order_param=t?a+("ascending"===t?" asc":" desc"):"",Le()},Le=async()=>{try{const e={...je};"all"===je.type_id&&(e.type_id=""),await n({loading:xe,request:z(e),data:{data:[Array,Ce],page:Object},success:e=>{Te.value=i(e.page)}})}catch(e){}finally{xe.value=!1}},Me=async()=>{try{const e=await Q();qe.value=Boolean(e.status)}catch(e){}},Pe=async(e,a=!1)=>{let t={};t=a?{id:ge.value.id}:{id:e.id};try{const s=await X(t);r.request(s),a||Ue(e)}catch(s){}},Ue=t=>{ge.value=t,e({title:"查看【"+(t.rname||t.name)+"】日志",area:80,component:()=>a((()=>import("./index103.js?v=1734676359")),__vite__mapDeps([]),import.meta.url)})},We=t=>{ge.value=t||!1,e({title:"".concat(t?(null==t?void 0:t.id)?"编辑":"复制":"添加","计划任务"),area:100,showFooter:!0,component:()=>a((()=>import("./index105.js?v=1734676359").then((e=>e.i))),__vite__mapDeps([]),import.meta.url)})},Fe=async()=>(await n({request:ee(),data:{msg:Array},success:e=>{Oe.value=[{label:"全部分类",value:"all"},{label:"系统任务",value:"-1"},{label:"默认分类",value:"0"},{label:"正在运行",value:"-2"},{label:"已停止",value:"-3"},...e.msg.map((e=>({label:e.name,value:e.id.toString()})))]}}),Promise.resolve(Oe.value||[])),Ne={getClassList:Fe,addClass:J,editClass:H,deleteClass:G},ze=w([re(),ce({event:(e,a)=>{(async(e,a)=>{try{let t;"top"==a?t=await se({task_id:e.id}):"untop"==a&&(t=await le({task_id:e.id})),r.request(t),Le()}catch(t){}})(e,a)},param:"sort"}),{label:"任务名称",minWidth:250,sortable:"custom",showOverflowTooltip:!0,render:e=>e.rname||e.name},{label:"分类",prop:"type_name",isCustom:!0},ue({event:async e=>{try{const a=!e.status;await t({title:"".concat(a?"启用":"停用","计划任务"),content:"该计划任务".concat(a?"已停止":"正在运行","，是否要").concat(a?"启用":"停用","这个计划任务？")}),await n({loading:"正在设置计划任务状态，请稍候...",request:Y({id:Number.parseInt(e.id),if_stop:a?"False":"True"}),message:!0}),Le()}catch(a){}},sortable:"custom",data:["停用","正常"]}),{label:"执行周期",prop:"cycle",minWidth:150,isCustom:!0,showOverflowTooltip:!0},{label:"保存数量",isCustom:!0,render:t=>["site","database","enterpriseBack","path","mysql_increment_backup"].includes(t.sType)&&t.save?T("span",null,[t.save,I("份"),T("span",{class:"bt-link",onClick:()=>(t=>{ge.value=t,e({title:"".concat(t.name,"-备份文件"),area:80,component:()=>a((()=>import("./index104.js?v=1734676359")),__vite__mapDeps([]),import.meta.url)})})(t)},[I("[查看]")])]):"logs"===t.sType||"special_log"===t.sType?"".concat(t.save?t.save+"份":"--"):"--"},{label:"备份到",minWidth:160,isCustom:!0,render:e=>{if("mysql_increment_backup"===e.sType||"enterpriseBackup"===e.sType){const a=e.backupTo.split("|");let t="";return a.forEach((e=>t+=Z[e]+",")),t.slice(0,-1)}const a=Z[e.backupTo];return"toShell"===e.sType?"--":a||"--"}},{label:"备份路径",prop:"db_backup_path",width:100,isCustom:!0,showOverflowTooltip:!0,render:e=>["site","database","path"].includes(e.sType)?T("span",{class:"bt-link",onClick:()=>pe({path:e.db_backup_path})},[e.db_backup_path]):"--"},{label:"上次执行时间",prop:"addtime",minWidth:150,sortable:"custom",isCustom:!0},{label:"上次定时任务执行结果",prop:"result",isCustom:!1,minWidth:140,sortable:"custom",render:e=>T("span",{class:e.result?"text-primary":"text-danger"},[e.result?"正常":"异常"])},de([{onClick:e=>Pe(e),title:"执行"},{onClick:We,title:"编辑"},{onClick:Ue,title:"日志"},{onClick:e=>We({...e,id:""}),title:"复制"},{onClick:async({id:e,name:a})=>{try{await t({title:"删除计划任务",content:"您确定要删除计划任务【".concat(a,"】，是否继续？")}),await n({loading:"正在删除计划任务，请稍候...",request:ae({id:e}),message:!0}),Le()}catch(s){}},title:"删除"}])]),Je=async()=>{await t({title:"一键修复",content:"此修复主要用于解决计划任务无法定时执行，请谨慎操作,是否继续?"}),Ee.value=!0;let e=[];Ve.value="开始修复计划任务...",ye.request("/crontab/repair_crontab_service",{customType:"model",onMessage:a=>{a.includes("修复完成")?(r.success("修复成功"),Me(),Ee.value=!1):(e.push(a),Ve.value=e.join("\n"))}})},He=async()=>{if(0!==Ce.value.length)try{const e=await $();window.open("/download?filename="+e.msg.replace("导出成功!,下载路径为",""))}catch(e){}else r.error("暂无数据可导出")},Ge=()=>{e({title:"日志切割设置",area:56,component:()=>a((()=>import("./index106.js?v=1734676359")),__vite__mapDeps([]),import.meta.url)})},Ze={class:"flex items-center"},$e={class:"flex items-center"},Ke={class:"flex-wrap"},Qe=y({__name:"index",setup(e){const{mainHeight:a}=c();return L((()=>(Le(),Fe(),void Me()))),(e,t)=>{const s=N,l=V,o=g,n=u,i=b,r=p,c=d,y=m,w=h,k=v,E=f,S=_,R=M("bt-loading");return C(),x("div",null,[q(qe)?W("",!0):(C(),P(s,{key:0,closable:!1,type:"error",class:"!mb-[1.6rem]"},{title:j((()=>[U("div",Ze,[t[9]||(t[9]=U("i",{class:"svgtofont-el-warning-filled text-[#F56C6C] !text-[1.4rem] mr-[4px]"},null,-1)),t[10]||(t[10]=I(" 检测到当前计划任务服务异常，请及时修复，温馨提示：修复前请先临时关闭系统加固，否则可能导致修复失败。 ")),U("span",{class:"bt-link",onClick:t[0]||(t[0]=(...e)=>q(Je)&&q(Je)(...e))},"[ 一键修复 ]")])])),_:1})),T(k,null,{"header-left":j((()=>[T(l,{type:"primary",onClick:t[1]||(t[1]=e=>q(We)())},{default:j((()=>t[11]||(t[11]=[I("添加任务")]))),_:1}),T(l,{onClick:q(Se)},{default:j((()=>t[12]||(t[12]=[I("导入")]))),_:1},8,["onClick"]),T(l,{onClick:q(He)},{default:j((()=>t[13]||(t[13]=[I("导出")]))),_:1},8,["onClick"]),T(l,{onClick:t[2]||(t[2]=e=>q(Ge)())},{default:j((()=>t[14]||(t[14]=[I("日志切割设置")]))),_:1}),T(ve,{ref_key:"fileRef",ref:we,onUploadSuccess:q(Le)},null,8,["onUploadSuccess"]),U("div",{class:"flex items-center ml-4px",onClick:t[3]||(t[3]=e=>q(ie)())},t[15]||(t[15]=[U("i",{class:"svgtofont-desired text-[1.6rem]"},null,-1),U("span",{class:"bt-link"},"需求反馈",-1)]))])),"header-right":j((()=>[U("div",$e,[T(o,{name:"CrontabTask",class:"mr-[10px] !w-[16rem]",modelValue:q(je).type_id,"onUpdate:modelValue":t[4]||(t[4]=e=>q(je).type_id=e),options:q(Oe),field:"name",config:q(Ne),onChange:q(Le),ignore:["-1","0","-2","-3"]},null,8,["modelValue","options","config","onChange"]),U("div",null,[T(n,{class:"!w-[26rem]",modelValue:q(je).search,"onUpdate:modelValue":t[5]||(t[5]=e=>q(je).search=e),onSearch:q(Le),onClear:q(Le),placeholder:"支持任务名称模糊搜索"},null,8,["modelValue","onSearch","onClear"])]),T(i,{onRefresh:q(Le),class:"!mx-[10px]"},null,8,["onRefresh"]),T(r,{name:"Crontab",column:q(ze)},null,8,["column"])])])),content:j((()=>[O(T(c,{ref_key:"crontabRef",ref:ke,column:q(ze),"max-height":q(a)-220,data:q(Ce),onSortChange:q(Ie)},null,8,["column","max-height","data","onSortChange"]),[[R,q(xe)],[R,"正在加载中，请稍候...","title"]])])),"footer-left":j((()=>[T(y,{"table-ref":q(ke),options:q(Ae)},null,8,["table-ref","options"])])),"footer-right":j((()=>[T(w,{page:q(je).p,"onUpdate:page":t[6]||(t[6]=e=>q(je).p=e),row:q(je).count,"onUpdate:row":t[7]||(t[7]=e=>q(je).count=e),total:q(Te),onChange:q(Le)},null,8,["page","row","total","onChange"])])),_:1}),T(S,{title:"正在修复服务，请耐心等候",modelValue:q(Ee),"onUpdate:modelValue":t[8]||(t[8]=e=>F(Ee)?Ee.value=e:null),area:[60]},{default:j((()=>[U("div",Ke,[T(E,{class:"h-[40rem] !rounded-none",content:q(Ve)},null,8,["content"])])])),_:1},8,["modelValue"])])}}}),Xe=Object.freeze(Object.defineProperty({__proto__:null,default:Qe},Symbol.toStringTag,{value:"Module"}));export{he as C,Xe as a,Le as g,Re as i,Be as o,Pe as s,Ce as t,ye as w};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
