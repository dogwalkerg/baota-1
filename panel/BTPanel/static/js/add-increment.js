import{c as e,r as a,R as l,o as t,k as o,l as n,e as u,x as r,q as s,p as m,I as i,aX as d,J as p,z as c,y as v,H as w,C as h,D as b,ag as _,ah as y,a7 as f,a4 as D,bS as x,M as V}from"./base-lib.js?v=1734676359";import{j as g,e as k,b6 as j,J as M,a6 as U,M as C,G as O,a4 as H}from"./utils-lib.js?v=1734676359";import{_ as E}from"./index88.js?v=1734676359";import{modifyIncrementData as N,addIncrementData as z}from"./database.js?v=1734676359";import{ay as I}from"./validator.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";import"./column.js?v=1734676359";const S={class:"flex items-center"},R={class:"flex items-center"},q=k(e({__name:"index",props:{rowData:{default:()=>({})}},setup(e,{expose:x}){const V=e,k=a(),j=a(0);let M=l([{type:"day",text:"每天",showDay:!1,showHour:!0,showMinute:!0},{type:"day-n",text:"N天",showDay:!0,showHour:!0,showMinute:!0},{type:"hour",text:"每小时",showDay:!1,showHour:!1,showMinute:!0},{type:"hour-n",text:"N小时",showDay:!1,showHour:!0,showMinute:!0},{type:"minute-n",text:"N分钟",showDay:!1,showHour:!1,showMinute:!0},{type:"week",text:"每周",showDay:!1,showHour:!0,showMinute:!0},{type:"month",text:"每月",showDay:!0,showHour:!0,showMinute:!0}]);const U={where1:[{validator:(e,a,l)=>{"day-n"!==C.value.type&&"month"!==C.value.type||(Number.parseInt(a)>31||Number.parseInt(a)<1||!Number.isInteger(parseFloat(a))?l(new Error("请输入1-31的整数")):""===a&&l(new Error("请输入天数")),l()),l()},trigger:["blur","change"]}],hour:[{validator:(e,a,l)=>{"minute-n"!==C.value.type&&"hour"!==C.value.type&&"second-n"!==C.value.type||l(),a>23||a<0||!a?l(new Error("请输入0-23的整数")):"hour-n"===C.value.type&&0===a&&0===C.value.minute&&l(new Error("小时和分钟不能同时为0")),l()},trigger:["blur","change"]}],minute:[{validator:(e,a,l)=>{a>59||a<0||!a?l(new Error("请输入0-59的整数")):"hour-n"===C.value.type&&0===a&&0===C.value.hour?l(new Error("小时和分钟不能同时为0")):"minute-n"===C.value.type&&(a<1||!a)&&l(new Error("请输入1-59的整数")),l()},trigger:["blur","change"]}]},C=a({type:"day",week:1,where1:"",hour:1,minute:30,notice:0,noticeChannel:""});return t((async()=>{V.rowData.cron_id&&Object.assign(C.value,{type:V.rowData.type,week:V.rowData.where1,where1:V.rowData.where1,hour:V.rowData.hour,minute:V.rowData.minute,notice:V.rowData.notice,noticeChannel:V.rowData.notice_channel.split(",").length>1?"all":V.rowData.notice_channel})})),x({formData:C,formDataRef:k}),(e,a)=>{const l=_,t=y,x=f,O=g,H=I,E=D;return o(),n("div",null,[u(E,{ref_key:"formDataRef",ref:k,rules:U,inline:!0,model:m(C),class:"demo-form-inline"},{default:r((()=>[u(x,{label:"执行周期",class:"!mb-0"},{default:r((()=>[s("div",S,[u(t,{onChange:a[0]||(a[0]=e=>{return a=m(C).type,V.rowData.cron_id||(C.value.notice=0),C.value.type=a,j.value=M.value.findIndex((e=>e.type===a)),"minute-n"===C.value.type&&(C.value.where1=C.value.minute),void("hour-n"===C.value.type&&(C.value.where1=C.value.hour));var a}),class:"!w-[8rem] mr-[4px]",modelValue:m(C).type,"onUpdate:modelValue":a[1]||(a[1]=e=>m(C).type=e)},{default:r((()=>[(o(!0),n(i,null,d(m(M),((e,a)=>(o(),p(l,{key:a,label:e.text,value:e.type},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),"week"==m(C).type?(o(),p(x,{key:0,class:"el-form-item-item"},{default:r((()=>[u(t,{class:"ml-[8px] mr-[4px] !w-[8rem]",modelValue:m(C).week,"onUpdate:modelValue":a[2]||(a[2]=e=>m(C).week=e)},{default:r((()=>[u(l,{label:"周一",value:1}),u(l,{label:"周二",value:2}),u(l,{label:"周三",value:3}),u(l,{label:"周四",value:4}),u(l,{label:"周五",value:5}),u(l,{label:"周六",value:6}),u(l,{label:"周日",value:7})])),_:1},8,["modelValue"])])),_:1})):c("",!0),u(x,{class:"el-form-item-item",prop:"where1"},{default:r((()=>{var e;return[(null==(e=m(M)[m(j)])?void 0:e.showDay)?(o(),p(O,{key:0,class:"ml-[8px] mr-[4px]",modelValue:m(C).where1,"onUpdate:modelValue":a[3]||(a[3]=e=>m(C).where1=e),min:1,width:"9.2rem",type:"number"},{append:r((()=>a[8]||(a[8]=[v(" 天 ")]))),_:1},8,["modelValue"])):c("",!0)]})),_:1}),u(x,{class:"el-form-item-item",prop:"hour"},{default:r((()=>{var e;return[(null==(e=m(M)[m(j)])?void 0:e.showHour)?(o(),p(O,{key:0,class:"ml-[8px] mr-[4px]",modelValue:m(C).hour,"onUpdate:modelValue":a[4]||(a[4]=e=>m(C).hour=e),width:"10rem",max:"23",min:"0",type:"number"},{append:r((()=>a[9]||(a[9]=[v(" 小时 ")]))),_:1},8,["modelValue"])):c("",!0)]})),_:1}),u(x,{class:"el-form-item-item",prop:"minute"},{default:r((()=>{var e;return[(null==(e=m(M)[m(j)])?void 0:e.showMinute)?(o(),p(O,{key:0,class:"ml-[8px] mr-[4px]",modelValue:m(C).minute,"onUpdate:modelValue":a[5]||(a[5]=e=>m(C).minute=e),width:"10rem",max:"59",min:"0",type:"number"},{append:r((()=>a[10]||(a[10]=[v(" 分钟 ")]))),_:1},8,["modelValue"])):c("",!0)]})),_:1})])])),_:1}),w(e.$slots,"other-config",{},void 0,!0),u(x,{label:"备份提醒",prop:"notice",class:"!mt-1.6rem"},{default:r((()=>[s("div",R,[u(t,{modelValue:m(C).notice,"onUpdate:modelValue":a[6]||(a[6]=e=>m(C).notice=e),class:"!w-[20rem]"},{default:r((()=>[u(l,{label:"不接受任何消息通知",value:0}),u(l,{label:"任务执行失败接收通知",value:1})])),_:1},8,["modelValue"]),h(u(x,{label:"消息通道"},{default:r((()=>[u(H,{modelValue:m(C).noticeChannel,"onUpdate:modelValue":a[7]||(a[7]=e=>m(C).noticeChannel=e),class:"!w-[12rem]",allAlarm:!0,multiple:!1,isDefault:!0,limit:["sms"]},null,8,["modelValue"])])),_:1},512),[[b,1===m(C).notice]])])])),_:1}),w(e.$slots,"bottom",{},void 0,!0)])),_:3},8,["model"])])}}}),[["__scopeId","data-v-c7aa61b3"]]),F={class:"flex flex-col justify-center items-center my-20px"},T={key:2,class:"mt-8px leading-8 text-[1.2rem] list-disc ml-20px"},B=e({__name:"add-increment",props:{compData:{default:()=>{}}},setup(e,{expose:l}){var v;const w=e,h=x(w.compData,"selectOptions"),b=a(),k=a(["localhost"]),I=a(),S=a(),R=a({db_name:(null==(v=h.value)?void 0:v.length)?h.value[0].value:"",zip_password:"",cron_type:"hour-n",backup_cycle:3,upload_alioss:"localhost",backup_type:"tables",name:"MySQL数据库增量备份",sType:"enterpriseBackup",sBody:"",sName:"tables",urladdress:"",save:"",save_local:1,tb_name:[]}),B=["mail","dingding","feishu","weixin","sms","wx_account"],J=[{label:"服务器磁盘",value:"localhost"},{label:"阿里云OSS",value:"alioss"},{label:"腾讯云OSS",value:"txcos"},{label:"七牛云存储",value:"qiniu"},{label:"华为云存储",value:"obs"},{label:"百度云存储",value:"bos"},{label:"天翼云存储",value:"tianyiyun"},{label:"WebDav存储",value:"webdav"},{label:"MinIO存储",value:"minio"}],L=async e=>{var a;if(e.length&&""!=e[e.length-1]){if((M(e)||U(e))&&e.length){const e=null==(a=R.value.tb_name)?void 0:a.indexOf("");-1!==e&&R.value.tb_name.splice(e,1)}}else R.value.tb_name=[""]},Q=async e=>{var a,l;const t=null==(a=w.compData.selectOptions)?void 0:a.find((a=>e===a.value));S.value=(null==t?void 0:t.table_list)||[],(null==(l=S.value)?void 0:l.length)?R.value.tb_name=[""]:R.value.tb_name=[]};return t((()=>{var e,a;(async()=>{Q(R.value.db_name),w.compData.rowData&&(Object.keys(R.value).forEach((e=>{w.compData.rowData.hasOwnProperty(e)&&(R.value[e]=w.compData.rowData[e])})),k.value=w.compData.rowData.backupTo)})(),w.compData.rowDatabaseName&&(R.value.db_name=null==(a=null==(e=w.compData.selectOptions)?void 0:e.find((e=>e.value===w.compData.rowDatabaseName)))?void 0:a.value)})),l({onConfirm:async e=>{if(await I.value.formDataRef.validate(),0===k.value.length)return void C.error("请至少选择一个数据备份位置");const a=(()=>{var e;const a={...I.value.formData,...R.value,backupTo:k.value.join("|"),name:"MySQL数据库增量备份["+R.value.db_name+"]",upload_alioss:(null==(e=k.value)?void 0:e.indexOf("localhost"))>0?"localhost":k.value[0],tb_name:""==R.value.tb_name[0]?"":"string"==typeof R.value.tb_name?R.value.tb_name:R.value.tb_name.join("|"),notice_channel:I.value.formData.noticeChannel};return a.notice_channel="all"===a.notice_channel?B.join(","):a.notice_channel,w.compData.rowData&&(a.id=w.compData.rowData.cron_id),a})(),l=w.compData.rowData;await O({loading:"正在提交任务中，请稍候...",request:(null==l?void 0:l.cron_id)?N(a):z(a),message:!0}),w.compData.refreshEvent(),e()}}),(e,a)=>{const l=_,t=y,v=f,w=H,x=E,M=g,U=D;return o(),n("div",F,[u(U,{ref_key:"increFormData",ref:b,class:"mr-16px w-[90%]",model:m(R)},{default:r((()=>[e.compData.rowData?c("",!0):(o(),p(v,{key:0,label:"数据库名称",prop:"db_name"},{default:r((()=>[u(t,{class:"!w-[42rem]",modelValue:m(R).db_name,"onUpdate:modelValue":a[0]||(a[0]=e=>m(R).db_name=e),onChange:Q},{default:r((()=>[(o(!0),n(i,null,d(m(h),((e,a)=>(o(),p(l,{key:a,label:e.name+(e.cron_id?"":"[无备份任务]"),value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})),e.compData.rowData?c("",!0):(o(),p(v,{key:1,label:"选择表",prop:"list"},{default:r((()=>[u(t,{class:"!w-[42rem]",modelValue:m(R).tb_name,"onUpdate:modelValue":a[1]||(a[1]=e=>m(R).tb_name=e),multiple:"","collapse-tags":"",onChange:L,placeholder:"请选择表"},{default:r((()=>[(o(!0),n(i,null,d(m(S),((e,a)=>(o(),p(l,{key:a,label:e.tb_name+(e.cron_id?"":"[无备份任务]"),value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})),u(v,{label:"数据备份到"},{default:r((()=>[u(w,{modelValue:m(k),"onUpdate:modelValue":a[2]||(a[2]=e=>V(k)?k.value=e:null),multiple:"",filterable:"","allow-create":"","default-first-option":"",class:"!w-[42rem] bt-multiple-select"},{default:r((()=>[(o(),n(i,null,d(J,((e,a)=>u(l,{key:a,label:e.label,value:e.value},null,8,["label","value"]))),64))])),_:1},8,["modelValue"])])),_:1}),u(v,{label:"压缩密码",prop:"zip_passwor d"},{default:r((()=>[e.compData.rowData?(o(),p(M,{key:1,disabled:"",modelValue:m(R).zip_password,"onUpdate:modelValue":a[5]||(a[5]=e=>m(R).zip_password=e),placeholder:"无"},null,8,["modelValue"])):(o(),p(x,{key:0,onIconClick:a[3]||(a[3]=()=>m(R).zip_password=m(j)(16)),placeholder:"请输入或选取随机密码，密码可为空",icon:"el-refresh",modelValue:m(R).zip_password,"onUpdate:modelValue":a[4]||(a[4]=e=>m(R).zip_password=e),width:"42rem"},null,8,["modelValue"]))])),_:1}),u(q,{ref_key:"alertFormRef",ref:I,class:"mt-20px",rowData:e.compData.rowData},null,8,["rowData"]),"edit"!==e.compData.type?(o(),n("ul",T,a[6]||(a[6]=[s("li",{class:"text-danger"},"请牢记压缩密码，以免因压缩密码导致无法恢复和下载数据",-1),s("li",null,"远程数据库暂不支持增量备份",-1)]))):c("",!0)])),_:1},8,["model"])])}}});export{B as default};
