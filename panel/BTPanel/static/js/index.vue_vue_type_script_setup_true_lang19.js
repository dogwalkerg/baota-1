import{G as t,dc as a,K as e,bR as s,bm as l,M as n,l as r,H as u,o,D as i,aO as c,a4 as d,c as m,h as p,x as v,j as y}from"./utils-lib.js?v=1734676359";import{g as h,r as g,i as f,h as _,c as w,e as b,C as j,B as k,a7 as x,y as E,Q as C,A as V,k as I,l as S,p as A,q as P,I as U,aX as L,x as O,v as R,z as q,M as F,aY as N,at as D,av as T,o as J,F as B,J as M,aj as H,a4 as $}from"./base-lib.js?v=1734676359";import{B as z}from"./column.js?v=1734676359";import{k as G}from"./form-item.js?v=1734676359";import{f as K}from"./validator.js?v=1734676359";import{s as Q}from"./useController3.js?v=1734676359";import{u as X,S as Y}from"./useStore7.js?v=1734676359";import{setNewAlarmTask as W,getJavaProjectInfo as Z,getRestartProjectConfig as tt,setRestartProjectConfig as at,setPath as et,getProjectRunState as st,getSystemUserListAsync as lt,getDirUserINI as nt,createRules as rt,modifyProjectAsync as ut}from"./site.js?v=1734676359";const ot=h("SITE-SERVICE-STORE",(()=>{const{siteInfo:s}=X();return{setAlertConfigEvent:async e=>{try{const s=await t({request:e.template_id?a(e):W({...e,template_id:"9"}),message:!0});return{data:s.data,status:s.status}}catch(s){return{msg:"修改状态失败",status:!1}}},getAlarmConfig:async()=>{try{const t=await e();return{data:t.data.data,status:t.status}}catch(t){return{msg:"获取告警配置失败",status:!1}}},getJavaServiceEvent:async t=>{try{const a=await Z(t);return{data:a.data,status:a.status}}catch(a){return{msg:"获取项目配置失败",status:!1}}},getRestartConfigEvent:async a=>{try{const{data:e}=await t({request:tt(a)});return{data:e,status:!0}}catch(e){return{msg:"获取重启配置失败",status:!1}}},setRestartStatusEvent:async a=>{try{const e=await t({loading:"正在设置状态，请稍后...",request:at(a),message:!0});return{data:e.data,status:e.status}}catch(e){return{msg:"设置状态失败",status:!1}}},saveSitePathEvent:async a=>{try{await t({loading:"正在保存中，请稍后...",request:et(a),message:!0})}catch(e){}},getRunInfoEvent:async()=>{try{const a=await t({request:st({sitename:s.value.name})});return{data:a.data,status:a.status}}catch(a){return{msg:"获取运行信息失败",status:!1}}},getDirInIEvent:async a=>{try{const e=await t({request:nt(a),data:{"runPath.dirs":[Array,"data"]}});return{data:e.data,status:!!e.data}}catch(e){}},releasePortEvent:async a=>{try{const e=await t({loading:"正在放行端口，请稍后...",request:rt(a),message:!0});return{msg:e.msg,status:e.status}}catch(e){return{msg:"释放端口失败",status:!1}}},getAsyncSystemUserList:async()=>{try{return{data:await t({request:lt(),data:Array}),status:!0}}catch(a){return{msg:"获取系统用户失败",status:!1}}},submitAsyncConfigEvent:async a=>{try{const e=await t({loading:"正在保存，请稍后...",request:ut(a),message:!0});return{status:e.status,msg:e.msg}}catch(e){return{msg:"保存失败",status:!1}}}}})),{siteInfo:it,siteType:ct}=X(),{getPhpVersionList:dt,setSiteInfo:mt,jumpTabEvent:pt}=Y(),{setAlertConfigEvent:vt,getAlarmConfig:yt,getJavaServiceEvent:ht,getRestartConfigEvent:gt,setRestartStatusEvent:ft,saveSitePathEvent:_t,getRunInfoEvent:wt,getAsyncSystemUserList:bt,getDirInIEvent:jt,releasePortEvent:kt,submitAsyncConfigEvent:xt}=ot(),Et=g(!1),Ct=f((()=>{var t,a;return"java"===ct.value?null!==(null==(t=it.value)?void 0:t.pid):"phpasync"===ct.value?!!(null==(a=it.value)?void 0:a.status):it.value.run})),Vt=g(!1),It=f((()=>{var t;return null==(t=it.value)?void 0:t.starting})),St=g({}),At=g([]),Pt=_({status:!1,id:""}),Ut=_({module:[],status:Pt.status,interval:60,count:1,push_count:1}),Lt=g(),Ot=g([]),Rt=g(!1);g();const qt=g(!1),Ft=g(),Nt=g({status:!1,time:0,where_hour:0,where_minute:0}),Dt=_({where_hour:[s({message:"请输入小时"}),{validator:(t,a,e)=>{!/^[0-9]*$/.test(a)||a<0||a>23||!Number.isInteger(parseFloat(a))?e(new Error("请输入0-23之间的整数")):e()}}],where_minute:[s({message:"请输入分钟"}),{validator:(t,a,e)=>{!/^[0-9]*$/.test(a)||a<0||a>59||!Number.isInteger(parseFloat(a))?e(new Error("请输入0-59之间的整数")):e()}}]}),Tt=t=>It.value?"开启中":t?"运行中":"已停止",Jt=t=>It.value?"el-icon-loading":t?"bt-link svgtofont-icon-start":"bt-danger svgtofont-icon-stop",Bt=()=>{It.value&&pt("logsManager")},Mt=async t=>{const a=await Q(it.value,t,ct.value);"java"===ct.value&&(null==a?void 0:a.status)&&Gt()},Ht=async t=>{try{if(Ut.status)return await zt(),Ut.status=!0,void $t();const a=await l({task_id:Pt.id,status:t?1:0});n.request(a),a.status||$t()}catch(a){return{msg:"修改状态失败",status:!1}}},$t=()=>{r({isAsync:!0,title:Pt.title||"项目异常停止告警设置",component:()=>u((()=>import("./project-exception-alarm.js?v=1734676359")),__vite__mapDeps([]),import.meta.url),area:48,btn:!0,compData:{refreshEvent:zt}})},zt=async()=>{try{const t=await yt();if(t.status){const a=t.data.find((t=>"project_status"===t.source&&t.task_data.project===it.value.id));if(a){const{task_data:t,status:e,sender:s,number_rule:l,id:n}=a;Object.assign(Ut,{...t,status:e,interval:t.interval,count:t.count,push_count:t.push_count||l.day_num,module:s}),Object.assign(Pt,{status:e,id:n})}else Object.assign(Ut,{status:!1,type:"project_status",title:"项目停止告警",tid:"9",interval:600,count:1,push_count:1,module:[]}),Object.assign(Pt,{status:!1,id:""})}return{data:Ut,status:!0}}catch(t){return{msg:"获取告警配置失败",status:!1}}},Gt=async t=>{try{const a=JSON.stringify({project_name:it.value.name}),e=await ht({data:a});return!0===t&&e.status&&n.success("刷新成功"),e.status&&mt(e.data),e}catch(a){return{msg:"获取项目配置失败",status:!1}}},Kt=async(t=it.value.name,a=ct.value)=>{try{Et.value=!0;const t=await gt({model_name:ct.value,project_name:it.value.name});return Et.value=!1,Object.assign(Nt.value,{...t.data,status:!!t.data.status}),qt.value=Boolean(t.data.status),{data:{...t.data,status:!!t.data.status},status:!0}}catch(e){return{msg:"获取重启配置失败",status:!1}}},Qt=()=>{Nt.value.status=qt.value},Xt=async t=>{try{if(!Vt.value&&t)return void(Vt.value=!0);Vt.value&&await Ft.value.validate();const a={model_name:ct.value,project_name:it.value.name,status:t?1:0,hour:Nt.value.where_hour,minute:Nt.value.where_minute};(await ft(a)).status&&(Vt.value=!1,Kt())}catch(a){return{msg:"修改状态失败",status:!1}}},Yt=async()=>{zt(),Kt()},Wt=async t=>{try{const a=(t=>({template_id:"9",task_data:JSON.stringify({task_data:{...t,cycle:{java:1,nodejs:2,go:3,python:4,other:5}[ct.value],project:it.value.id,interval:Number(t.interval)},sender:t.module,time_rule:{send_interval:Number(t.interval),time_range:[0,86399]},number_rule:{day_num:Number(t.push_count),total:0}}),title:"项目"+it.value.name+"停止告警",status:t.status?1:0}))(t),e=await vt(a);return e.status&&zt(),e.status}catch(a){return!1}},Zt=async()=>{try{const t=await _t({path:St.value.project_path,id:it.value.id});return aa(),t}catch(t){return{msg:"保存路径失败",status:!1}}},ta=async()=>{var t,a;try{const e=await wt();e.status&&(Object.assign(St.value,e.data),St.value.is_power_on=1===e.data.is_power_on,St.value.allPort=null==(a=null==(t=e.data.Listen)?void 0:t.map((t=>t[1])))?void 0:a.join(", "))}catch(e){return{msg:"获取项目信息失败",status:!1}}},aa=async()=>{try{const t={path:St.value.project_path,id:it.value.id},a=await jt(t);return a.status&&(Ot.value=a.data.map((t=>({label:t,value:t})))),a}catch(t){return{msg:"获取目录用户配置失败",status:!1}}},ea=async t=>{var a;try{if((null==(a=null==St?void 0:St.value.Listen)?void 0:a.length)>1&&!Rt.value)return void(Rt.value=!0);let e="",s=[],l=[],r=[];if(Rt.value){if(0===t.length)return n.error("最少选择一个端口进行放行"),!1;r=t}else r=null==St?void 0:St.value.Listen;e=r.map((t=>("127.0.0.1"===t[0]||"localhost"===t[0]?s.push(t[1]):l.push(t[1]),t[1]))).join(","),await o({icon:"warning-filled",title:"放行端口",content:"放行端口".concat(l.length?" [ "+l.join(",")+" ] 后，当前端口将正常访问，":"","  ").concat(s.length?" [ "+s.join(",")+" ] 为本地端口，只能本地访问，":""," 是否继续操作？")});const u={data:JSON.stringify({protocol:"tcp",ports:e,choose:"all",types:"accept",brief:it.value.name+"项目放行端口",address:"",domain:"",source:""})};(await kt(u)).status&&Rt.value&&(Rt.value=!1)}catch(e){return{msg:"放行端口失败",status:!1}}},sa=async(t,a)=>{try{await a();let e={sitename:it.value.name,...t.value,is_power_on:St.value.is_power_on?1:0};delete e.status,delete e.ps;const s=await xt(e);return s.status&&(it.value.php_version=(e.php_version/10).toFixed(1)),ta(),s.status}catch(e){return{msg:"提交配置失败",status:!1}}},la=async()=>{"phpasync"===it.value.project_type&&(await(async()=>{const t=await dt();At.value=t.data.map((t=>({...t,key:t.value,label:t.name,value:t.version}))).filter((t=>"纯静态"!==t.name)),At.value=At.value.reverse()})(),await(async()=>{try{const t=await bt();t.status&&(Lt.value=Array.isArray(t.data)?t.data.map((t=>({label:t,value:t}))):[])}catch(t){}})(),await ta(),await aa())},na={class:"relative -left-[3rem]"},ra={class:"text-[#777] mt-[2px] leading-[2rem] text-[12px] list-disc",style:{"padding-left":"4rem"}},ua={key:0},oa={key:0},ia={class:"p-[20px]"},ca=w({__name:"phpasync-config",setup(t){const{jumpTabEvent:a}=Y(),{BtForm:e,submit:l}=i({data:async()=>(await la(),St.value||{}),options:t=>f((()=>[{type:"custom",render:()=>b(c,{label:"pid"},{default:()=>{var a,e;return[b("div",{class:"flex items-center"},[b("span",null,[t.value.pid]),j(b("template",null,[b(x,{label:"端口"},{default:()=>[b("span",{class:"truncate block max-w-[30rem]",title:t.value.allPort},[t.value.allPort])]}),b("span",{class:"bt-link ml-1rem",onClick:ea},[E("一键放行")])]),[[k("if"),null==(e=null==(a=t.value)?void 0:a.Listen)?void 0:e.length]])])]}})},{type:"custom",render:()=>b(c,{label:"开机启动"},{default:()=>[b(C,{modelValue:t.value.is_power_on,"onUpdate:modelValue":a=>t.value.is_power_on=a},null)]})},{type:"input",label:"启动命令",key:"project_cmd",attrs:{placeholder:"请输入启动命令，例：php server.php",width:"34rem"},rules:[s({message:"请输入项目执行命令"})]},G("根目录","project_path",{attrs:{width:"34rem",placeholder:"请输入项目目录"}},(()=>{var a;(a=t.value.project_path)&&"/"===a[a.length-1]&&(a=a.slice(0,-1)),K({type:"all",path:a||"/www/wwwroot",change:t=>{Zt()}})})),{type:"custom",render:()=>b(c,{label:"运行目录"},{default:()=>[b(d,{modelValue:t.value.site_run_path,"onUpdate:modelValue":a=>t.value.site_run_path=a,options:Ot.value,class:"mr-[12px]",style:"width: 34rem;"},null),b("span",{class:"text-[#999] text-[1.2rem] ml-[.4rem]"},[E(" * 前端文件的运行目录 ")])]})},{type:"select",label:"PHP版本",key:"php_version",options:At.value,attrs:{class:"!w-[16rem]"}},{type:"custom",render:()=>b(c,{label:"运行用户"},{default:()=>[b(d,{modelValue:t.value.run_user,"onUpdate:modelValue":a=>t.value.run_user=a,options:Lt.value,class:"mr-[12px]",style:"width: 16rem;"},null),b("span",{class:"text-[#999] text-[1.2rem] ml-[.4rem]"},[E(" * 无特殊需求请选择www用户 ")])]})},{type:"custom",render:()=>b(c,{label:" "},{default:()=>[b(V,{type:"primary",onClick:l},{default:()=>[E("保存")]})]})}])),submit:sa});return(t,s)=>{var l,n,r;const u=N,o=m,i=D,c=T,d=p;return I(),S("div",na,[b(u),b(A(e),{"label-width":"80px"}),P("ul",ra,[(null==(n=null==(l=A(St))?void 0:l.Listen)?void 0:n.length)?(I(),S("li",ua,[s[3]||(s[3]=E(" 可以通过 ")),(I(!0),S(U,null,L(null==(r=A(St))?void 0:r.Listen,((t,a)=>{var e;return I(),S(U,{key:a},[b(o,{href:"http://".concat(null==t?void 0:t.join(":"),"}")},{default:O((()=>[E(R(null==t?void 0:t.join(":")),1)])),_:2},1032,["href"]),a!==(null==(e=A(St))?void 0:e.Listen.length)-1?(I(),S("span",oa,"、")):q("",!0)],64)})),128)),s[4]||(s[4]=E(" 访问此服务（需放行使用到的端口，")),b(o,{onClick:A(ea)},{default:O((()=>s[2]||(s[2]=[E("一键放行")]))),_:1},8,["onClick"]),s[5]||(s[5]=E("） "))])):q("",!0),P("li",null,[s[7]||(s[7]=E("可以通过设置 ")),b(o,{onClick:s[0]||(s[0]=t=>A(a)("proxy"))},{default:O((()=>s[6]||(s[6]=[E("反向代理")]))),_:1}),s[8]||(s[8]=E(" 后通过域名访问"))])]),b(d,{title:"一键放行端口",modelValue:A(Rt),"onUpdate:modelValue":s[1]||(s[1]=t=>F(Rt)?Rt.value=t:null),area:42,onConfirm:A(ea),showFooter:""},{default:O((()=>{var t;return[P("div",ia,[s[9]||(s[9]=P("div",{class:"leading-[2rem] mb-1rem"},"请选中需要放行的端口进行放行：",-1)),b(c,{ref:"releasePortRef",class:"param-table",data:null==(t=A(St))?void 0:t.Listen,"tooltip-effect":"dark",style:{width:"100%"},"max-height":280},{default:O((()=>[b(i,{type:"selection",width:"36"}),b(i,{label:"端口"},{default:O((t=>[E(R(t.row[1]),1)])),_:1}),b(i,{label:"监听地址"},{default:O((t=>[E(R(t.row[0]),1)])),_:1})])),_:1},8,["data"])])]})),_:1},8,["modelValue","onConfirm"])])}}}),da={class:"flex flex-col text-[#666]"},ma={class:"mb-[12px] flex items-center"},pa={key:0,class:"ml-[5rem]"},va={key:0},ya={key:1,class:"ml-[2rem]"},ha={key:0,class:"ml-[3rem]"},ga={key:1,class:"ml-[3rem]"},fa={class:"flex items-center"},_a={class:"flex items-center"},wa={key:1,class:"flex items-center"},ba={key:2,class:"pb-2rem leading-[2.6rem]"},ja={class:"items-center flex"},ka={class:"text-[#2196F3] bg-[#EEE] inline-block rounded-sm px-[0.4rem] leading-2rem"},xa={class:"p-2rem"},Ea={class:"flex items-center"},Ca=w({__name:"index",setup(t,{expose:a}){const{siteType:e,siteInfo:s}=X();return J(Yt),a({init:Yt}),(t,a)=>{const l=V,n=N,r=H,u=m,o=x,i=$,c=p,d=k("bt-loading");return j((I(),S("div",null,[P("div",da,[P("span",ma,[a[15]||(a[15]=E("当前状态： ")),"java"!==A(e)?(I(),S(U,{key:0},[b(A(z),{modelValue:A(Ct),"onUpdate:modelValue":a[0]||(a[0]=t=>F(Ct)?Ct.value=t:null),data:["停止","开启"]},null,8,["modelValue"]),"python"===A(e)?(I(),S("span",pa,[A(s).listen&&A(s).listen.length>0?(I(),S("span",va,"监听端口："+R(A(s).listen.join(",")),1)):q("",!0),A(s).pids&&A(s).pids.length>0?(I(),S("span",ya,"PID："+R(A(s).pids.join(",")),1)):q("",!0)])):q("",!0)],64)):(I(),S(U,{key:1},[P("div",{class:B(["flex items-center",{"cursor-pointer":A(It)}]),onClick:a[1]||(a[1]=(...t)=>A(Bt)&&A(Bt)(...t))},[P("span",{class:B("".concat(A(Ct)?"bt-link":"bt-danger"))},R(A(Tt)(A(Ct))),3),P("span",{class:B(A(Jt)(A(Ct))+" iconfont")},null,2)],2),A(s).pid?(I(),S("span",ha,"pid："+R(A(s).pid),1)):q("",!0),A(s).project_config.port?(I(),S("span",ga,"端口："+R(A(s).project_config.port),1)):q("",!0)],64))]),P("div",fa,[A(Ct)?q("",!0):(I(),M(l,{key:0,type:"default",onClick:a[2]||(a[2]=t=>A(Mt)("start"))},{default:O((()=>a[16]||(a[16]=[E("启动")]))),_:1})),A(Ct)?(I(),M(l,{key:1,type:"default",onClick:a[3]||(a[3]=t=>A(Mt)("stop"))},{default:O((()=>a[17]||(a[17]=[E("停止")]))),_:1})):q("",!0),b(l,{type:"default",onClick:a[4]||(a[4]=t=>A(Mt)("restart"))},{default:O((()=>a[18]||(a[18]=[E("重启")]))),_:1}),"java"===A(e)?(I(),M(l,{key:2,type:"default",onClick:a[5]||(a[5]=t=>A(Gt)(!0))},{default:O((()=>a[19]||(a[19]=[E("刷新")]))),_:1})):q("",!0)])]),"phpasync"!==A(e)?(I(),S(U,{key:0},["net"!==A(e)?(I(),S(U,{key:0},[b(n),P("span",_a,[a[21]||(a[21]=E("项目异常停止时提醒我: ")),b(r,{modelValue:A(Ut).status,"onUpdate:modelValue":a[6]||(a[6]=t=>A(Ut).status=t),class:"mx-[4px]",onChange:A(Ht)},null,8,["modelValue","onChange"]),b(u,{onClick:A($t)},{default:O((()=>a[20]||(a[20]=[E("告警设置")]))),_:1},8,["onClick"])])],64)):q("",!0),b(n),"java"!==A(e)?(I(),S("span",wa,[a[23]||(a[23]=E("项目定时重启: ")),b(r,{modelValue:A(Nt).status,"onUpdate:modelValue":a[7]||(a[7]=t=>A(Nt).status=t),class:"mx-[4px]",onChange:A(Xt)},null,8,["modelValue","onChange"]),b(u,{onClick:a[8]||(a[8]=t=>Vt.value=!0)},{default:O((()=>a[22]||(a[22]=[E("定时重启设置")]))),_:1})])):(I(),S("div",ba,[a[25]||(a[25]=P("div",null,"命令行操作:",-1)),a[26]||(a[26]=P("div",null,[E(" 命令行可使用 "),P("code",{class:"text-[#2196F3] bg-[#EEE] inline-block rounded-sm px-[0.4rem] leading-2rem"}," java-service [项目名称] [start|stop|restart] "),E(" 进行启动，停止和重启操作 ")],-1)),P("div",ja,[a[24]||(a[24]=E(" 示例： ")),P("code",ka," java-service "+R(A(s).name)+" start ",1),P("span",{class:"ml-[1rem] svgtofont-el-document-copy cursor-pointer",onClick:a[9]||(a[9]=t=>A(v)({value:"java-service ".concat(A(s).name," start")}))})]),a[27]||(a[27]=P("div",null,"如果提示没有该命令，可以尝试关闭系统加固，并重启面板，再次加载 java-service指令",-1))]))],64)):(I(),M(ca,{key:1})),b(c,{title:"项目重启设置",modelValue:A(Vt),"onUpdate:modelValue":a[13]||(a[13]=t=>F(Vt)?Vt.value=t:null),area:48,onConfirm:a[14]||(a[14]=t=>A(Xt)(!0)),onCancel:A(Qt),showFooter:""},{default:O((()=>[P("div",xa,[b(i,{ref_key:"restartFormRef",ref:Ft,"label-position":"right",model:A(Nt),rules:A(Dt)},{default:O((()=>[b(o,{label:"项目名称"},{default:O((()=>[b(A(y),{modelValue:A(s).name,"onUpdate:modelValue":a[10]||(a[10]=t=>A(s).name=t),disabled:"",width:"24rem"},null,8,["modelValue"])])),_:1}),b(o,{label:"执行周期"},{default:O((()=>[P("div",Ea,[b(o,{prop:"where_hour"},{default:O((()=>[b(A(y),{type:"number",width:"18.6rem",modelValue:A(Nt).where_hour,"onUpdate:modelValue":a[11]||(a[11]=t=>A(Nt).where_hour=t)},{prepend:O((()=>a[28]||(a[28]=[E("每天")]))),append:O((()=>a[29]||(a[29]=[E("时")]))),_:1},8,["modelValue"])])),_:1}),b(o,{prop:"where_minute"},{default:O((()=>[b(A(y),{type:"number",width:"14rem",modelValue:A(Nt).where_minute,"onUpdate:modelValue":a[12]||(a[12]=t=>A(Nt).where_minute=t)},{append:O((()=>a[30]||(a[30]=[E("分")]))),_:1},8,["modelValue"])])),_:1})])])),_:1})])),_:1},8,["model","rules"])])])),_:1},8,["modelValue","onCancel"])])),[[d,A(Et)]])}}});export{Ca as _,zt as g,Ut as m,Wt as s};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
