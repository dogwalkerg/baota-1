import{G as a,t as e,ah as t,o as l,b0 as s,M as u,dy as o,dz as d,dA as i,D as n,U as r,aO as _,O as c,e as m,aa as g}from"./utils-lib.js?v=1734676359";import{g as p,r as v,h as b,R as f,ar as y,c as x,s as O,i as N,e as h,y as S,aN as A,az as D,o as C,k as w,l as U,p as z,C as R,D as q,q as B,x as k,A as L,ah as E,ag as j,bn as F,a1 as M,J as I,M as V}from"./base-lib.js?v=1734676359";import{l as H,e as Y,b as J,i as G,F as T,d as Q}from"./form-item.js?v=1734676359";import{getDatabaseAuditLog as P,setDatabaseAuditLog as W,getAuditAdvUserList as K,getAuditAdvDatabaseList as X,getAuditAdvOrderList as Z,getAuditLog as $,setDatabaseAuditLogRules as aa}from"./database.js?v=1734676359";import{_ as ea}from"./index101.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";const ta=p("DATABASE-MYSQL-ADVANCED-AUDIT-STORE",(()=>{const n=v({status:!1,oldStatus:!1,audit_log_file:"",audit_log_format:"JSON",audit_log_buffer_size:"1",audit_log_flush:!1,audit_log_policy:"LOGINS",audit_log_rotate_on_size:"0",audit_log_rotations:"0",audit_log_strategy:"ASYNCHRONOUS"}),r=v({mode:"",audit_log_exclude_accounts:[],audit_log_exclude_databases:[],audit_log_exclude_commands:[],audit_log_include_accounts:[],audit_log_include_databases:[],audit_log_include_commands:[]}),_=v(""),c=v({user:!1,database:!1,order:!1,log:!1}),m=b({user:[],database:[],order:[]}),g=f(),p=f(),x=f(),O=async()=>{const l=a=>a.split(",").filter((a=>""!==a&&" "!==a));try{const s=await a({loading:"正在获取数据，请稍后...",request:P()});if(s.status){n.value.status="ON"===s.data.status||"on"===s.data.status,n.value.oldStatus="ON"===s.data.status||"on"===s.data.status,n.value.audit_log_format=s.data.audit_log_format||"JSON",n.value.audit_log_file=s.data.audit_log_file,n.value.audit_log_buffer_size=e(Number(s.data.audit_log_buffer_size||0),!1,2,"MB"),n.value.audit_log_flush="ON"===s.data.audit_log_flush||"on"===s.data.audit_log_flush,n.value.audit_log_policy=s.data.audit_log_policy,n.value.audit_log_rotate_on_size=e(Number(s.data.audit_log_rotate_on_size||0),!1,2,"MB"),n.value.audit_log_rotations=s.data.audit_log_rotations||"0",n.value.audit_log_strategy=s.data.audit_log_strategy||"ASYNCHRONOUS",r.value.audit_log_exclude_accounts=l(s.data.audit_log_exclude_accounts||""),r.value.audit_log_exclude_databases=l(s.data.audit_log_exclude_databases||""),r.value.audit_log_exclude_commands=l(s.data.audit_log_exclude_commands||""),r.value.audit_log_include_accounts=l(s.data.audit_log_include_accounts||""),r.value.audit_log_include_databases=l(s.data.audit_log_include_databases||""),r.value.audit_log_include_commands=l(s.data.audit_log_include_commands||"");const a=!h([s.data.audit_log_include_accounts,s.data.audit_log_include_databases,s.data.audit_log_include_commands]),t=!h([s.data.audit_log_exclude_accounts,s.data.audit_log_exclude_databases,s.data.audit_log_exclude_commands]);r.value.mode=a?"include":t?"exclude":""}else t(s)}catch(s){t(s)}},N=async e=>{const l=a=>JSON.stringify(a.filter((a=>""!==a&&" "!==a)).join(","));try{a({loading:"正在保存，请稍后...",message:!0,request:aa({type:e.mode,..."include"===e.mode?{accounts:l(e.audit_log_include_accounts),databases:l(e.audit_log_include_databases),commands:l(e.audit_log_include_commands)}:{accounts:l(e.audit_log_exclude_accounts),databases:l(e.audit_log_exclude_databases),commands:l(e.audit_log_exclude_commands)}})})}catch(s){t(s)}},h=a=>a.every((a=>!a||""===a.trim())),S=(a,e)=>{const t={b:1,kb:1024,mb:1048576,gb:1024**3,tb:1024**4};return o(d(a),(a=>t[a]),i)(e)};return{resetData:()=>{n.value.status=!1,n.value.oldStatus=!1,n.value.audit_log_format="JSON",n.value.audit_log_buffer_size="1",n.value.audit_log_flush=!1,n.value.audit_log_policy="ALL",n.value.audit_log_rotate_on_size="0",n.value.audit_log_rotations="0",n.value.audit_log_strategy="ASYNCHRONOUS",r.value.mode="",r.value.audit_log_exclude_accounts=[],r.value.audit_log_exclude_databases=[],r.value.audit_log_exclude_commands=[],r.value.audit_log_include_accounts=[],r.value.audit_log_include_databases=[],r.value.audit_log_include_commands=[],_.value=""},auditBaseFormData:n,getAuditBaseData:O,setAuditBaseData:async e=>{try{if(!e.status){try{await l({title:"关闭日志审计",content:"即将关闭日志审计并重启数据库，数据库不会再记录相关操作日志，可能会失去一些安全性和审计能力，是否继续操作！"}),a({loading:"正在关闭并重启数据库，请稍后...",message:!0,request:W({status:e.status?"on":"off"}),success:a=>{a.status||(n.value.status=!0)}})}catch(s){n.value.status=!0}return}a({loading:"正在保存，请稍后...",message:!0,request:W({...e,status:e.status?"on":"off",audit_log_flush:"SYNCHRONOUS"===e.audit_log_strategy&&e.audit_log_flush?"ON":"OFF",audit_log_buffer_size:S(Number(e.audit_log_buffer_size),"MB"),audit_log_rotate_on_size:S(Number(e.audit_log_rotate_on_size),"MB")})})}catch(s){t(s)}},userOptions:g,auditAdvFormData:r,loading:c,getDatabase:async()=>{try{a({loading:y(c.value,"database"),request:X(),data:[Array,a=>{m.database=a.flat(1),p.value=m.database.map((a=>({label:a,value:a})))}]})}catch(e){t(e)}},extsFilterMethod:(a,e,t,l,s)=>{var o;try{if(e.includes(",")){const t=[],o=[];e.split(",").filter((a=>""!==a&&" "!==a)).forEach((e=>{m[a].includes(e)?o.push(e):t.push(e)})),l(o),null==s||s.blur(),t.length>0?u.success("已选中".concat(o.length,"个，未查询到【").concat(t.join(","),"】选项，已忽略")):o.length>0&&u.success("已选中".concat(o.length,"个"))}else t.value=(null==(o=m[a])?void 0:o.filter((a=>a.includes(e))).map((a=>({label:a,value:a}))))||[]}catch(d){}},getUser:async()=>{try{a({loading:y(c.value,"user"),request:K(),data:[Array,a=>{m.user=a,g.value=a.map((a=>({label:a,value:a})))}]})}catch(e){t(e)}},databaseOptions:p,getCommands:async()=>{try{a({loading:y(c.value,"order"),request:Z(),data:[Array,a=>{m.order=a,x.value=m.order.map((a=>({label:a,value:a})))}]})}catch(e){t(e)}},orderOptions:x,setAuditRules:N,logContent:_,getAduitLogs:async()=>{try{a({loading:y(c.value,"log"),request:$(),success:a=>{a.status?_.value=a.msg:_.value="获取日志失败"}})}catch(e){t(e)}},restartDatabase:async()=>{try{await l({title:"重启数据库",content:"即将重启数据库，是否继续操作！"}),await a({loading:"正在重启数据库，请稍后...",message:!0,request:s({name:"mysqld",type:"restart"})}),O()}catch(e){t(e)}},clearSubmit:async()=>{try{await l({title:"清空记录规则",content:"即将清空已经设置的日志记录规则，是否继续"}),r.value.mode="",r.value.audit_log_exclude_accounts=[],r.value.audit_log_exclude_databases=[],r.value.audit_log_exclude_commands=[],r.value.audit_log_include_accounts=[],r.value.audit_log_include_databases=[],r.value.audit_log_include_commands=[],N(r.value)}catch(a){}}}})),la={class:"p-[2rem]"},sa={class:"flex justify-start pl-[23rem]"},ua=m(x({__name:"audit-common",setup(a,{expose:e}){const t=ta(),{auditBaseFormData:l}=O(t),{getAuditBaseData:s,setAuditBaseData:u,restartDatabase:o}=t,{BtForm:d,submit:i,ref:m}=n({data:()=>l.value,options:a=>N((()=>[H("开启日志审计","status",{attrs:{onChange:async a=>{!a&&l.value.oldStatus&&u({status:!1})}}}),...a.value.status?[Y("日志记录格式","audit_log_format",["JSON","CSV","OLD","NEW"].map((a=>({label:a,value:a})))),J("缓冲区大小","audit_log_buffer_size",{slots:{unit:()=>h("span",{class:"whitespace-nowrap ml-[.5rem]"},[S("MB"),h("span",{class:"ml-[2.5rem]"},[S("日志将会写入缓冲区，缓冲区满后再写入磁盘")])])},attrs:{class:"!w-[39rem]",placeholder:"缓冲区大小"},rules:[{required:!0,validator:(a,e,t)=>{""===e||Number.isNaN(Number(e))||!Number.isInteger(Number(e))||Number(e)<1?t(new Error("请输入正确的缓冲区大小")):t()},trigger:"blur"}]}),G("日志记录类型","audit_log_policy",[{label:"记录所有事件（ALL）",value:"ALL"},{label:"记录登录事件（LOGINS）",value:"LOGINS"},{label:"记录查询事件（QUERIES）",value:"QUERIES"}],{attrs:{class:"!w-[22rem]"}}),T((()=>h(_,null,{default:()=>h(r,{modelValue:l.value.audit_log_strategy,"onUpdate:modelValue":a=>l.value.audit_log_strategy=a,options:[{label:"异步",value:"ASYNCHRONOUS"},{label:"快速异步",value:"PERFORMANCE"},{label:"同步",value:"SYNCHRONOUS"}],type:"button"},null),label:()=>h("span",{class:"flex items-center"},[S("日志写入刷新方式"),h(A,{effect:"light",popperClass:"green-tips-popover",placement:"top"},{default:()=>h("span",{class:"svgtofont-el-question-filled text-[#fca146] !text-[1.6rem] cursor-pointer ml-[.5rem]"},null),content:()=>h("span",{class:"py-[.5rem] px-[1.1rem]"},[S("写入刷新方式："),h("br",null,null),S("异步写入：性能较好，但出现异常时可能丢失日志"),h("br",null,null),S("快速异步写入：性能最好, 但出现异常时可能丢失更多日志"),h("br",null,null),S("同步写入：性能较差，但不会丢失日志")])})])})),{key:"audit_log_strategy",rules:{}}),..."SYNCHRONOUS"===l.value.audit_log_strategy?[Q([H("实时刷新","audit_log_flush",{attrs:{}}),T((()=>D("span",{class:"text-[1.2rem] text-[#666] ml-[3.5rem] leading-[3.2rem]"},"开启后将实时刷新日志，可能会影响性能")),{key:"jump",rules:{}})])]:[],J("文件大小限制","audit_log_rotate_on_size",{slots:{unit:()=>h("span",{class:"whitespace-nowrap ml-[.5rem]"},[S("MB"),h("span",{class:"ml-[2.5rem]"},[S("日志文件大小限制，为0则不限制大小")])])},attrs:{class:"!w-[35rem]",placeholder:"文件大小限制"},rules:[{required:!0,validator:(a,e,t)=>{""===e||Number.isNaN(Number(e))||Number(e)<0?t(new Error("请输入正确的文件大小限制")):t()},trigger:"blur"}]}),J("文件保留份数","audit_log_rotations",{slots:{unit:()=>h("span",{class:"whitespace-nowrap ml-[.5rem]"},[S("份"),h("span",{class:"ml-[2.5rem]"},[S("日志文件最多保留份数，为0则不限制")])])},attrs:{class:"!w-[35rem]",placeholder:"文件保留份数"},rules:[{required:!0,validator:(a,e,t)=>{""===e||Number.isNaN(Number(e))||Number(e)<0?t(new Error("请输入正确的文件保留份数")):t()},trigger:"blur"}]})]:[]])),submit:async(a,e,t)=>{await e(),u(a.value)}});return C((()=>{s()})),e({init:s}),(a,e)=>{const t=L,s=c;return w(),U("div",la,[h(z(d),{class:"h-[40rem]"}),R(B("div",sa,[h(t,{type:"primary",onClick:z(i)},{default:k((()=>e[0]||(e[0]=[S("保存设置")]))),_:1},8,["onClick"]),h(t,{type:"default",onClick:z(o)},{default:k((()=>e[1]||(e[1]=[S("重启数据库")]))),_:1},8,["onClick"])],512),[[q,z(l).status]]),R(h(s,{class:"mt-[2rem]",options:[{content:"当前仅支持mysql-8.0/8.4"},{content:"缓冲区大小/日志记录格式/日志写入刷新方式/实时刷新需重启数据库才会生效"},{content:"审计日志大小将会非常大，请注意留足磁盘空间或设置仅记录登录事件，也可以在高级设置中设置过滤模式"}]},null,512),[[q,z(l).status]])])}}}),[["__scopeId","data-v-2508722d"]]),oa=ta(),{auditAdvFormData:da,userOptions:ia,databaseOptions:na,orderOptions:ra,loading:_a}=O(oa),{extsFilterMethod:ca}=oa,ma={includeUser:null,includeOrder:null,includeDatabase:null,excludeUser:null,excludeOrder:null,excludeDatabase:null},ga=(a,e,t,l,s)=>T((()=>h(_,{label:a},{default:()=>h("div",{class:"flex items-center"},[h(E,{ref:a=>{ma[t]=a},modelValue:da.value[l],"onUpdate:modelValue":a=>da.value[l]=a,placeholder:e,style:"width: 280px",loading:_a.value[t.replace("include","").replace("exclude","").toLowerCase()],"filter-method":a=>ca(t.replace("include","").replace("exclude","").toLowerCase(),a,{userOptions:ia,databaseOptions:na,orderOptions:ra}[s],(a=>{da.value[l]=a}),ma[t]),filterable:!0,multiple:!0,"collapse-tags":!0,"collapse-tags-tooltip":!0,"reserve-keyword":!1},{default:()=>{var a;return[null==(a={userOptions:ia,databaseOptions:na,orderOptions:ra}[s].value)?void 0:a.map((a=>h(j,{key:a.value,label:a.label,value:a.value},null)))]}})])}))),pa={class:"p-[2rem]"},va={class:"flex justify-start pl-[23rem]"},ba=m(x({__name:"audit-advanced",setup(a,{expose:e}){const t=ta(),{auditAdvFormData:l}=O(t),{getAuditBaseData:s,setAuditRules:u,getDatabase:o,getUser:d,getCommands:i,clearSubmit:r}=t,{BtForm:_,submit:m}=n({data:()=>l.value,options:()=>N((()=>[Y("日志记录规则模式","mode",[{label:"允许",value:"include"},{label:"排除",value:"exclude"}]),..."include"===l.value.mode?[ga("允许记录的用户","允许记录的用户,可多选","includeUser","audit_log_include_accounts","userOptions"),ga("允许记录的查询","允许记录的查询,可多选","includeOrder","audit_log_include_commands","orderOptions"),ga("允许记录的数据库","允许记录的数据库,可多选","includeDatabase","audit_log_include_databases","databaseOptions")]:"exclude"===l.value.mode?[ga("排除记录的用户","排除记录的用户,可多选","excludeUser","audit_log_exclude_accounts","userOptions"),ga("排除记录的查询","排除记录的查询,可多选","excludeOrder","audit_log_exclude_commands","orderOptions"),ga("排除记录的数据库","排除记录的数据库,可多选","excludeDatabase","audit_log_exclude_databases","databaseOptions")]:[]])),submit:async(a,e)=>{await e(),u(a.value)}});return C((()=>{o(),d(),i(),s()})),e({init:s}),(a,e)=>{const t=L,s=c;return w(),U("div",pa,[h(z(_),{class:"h-[20rem]"}),R(B("div",va,[h(t,{type:"primary",onClick:z(m)},{default:k((()=>e[0]||(e[0]=[S("保存设置")]))),_:1},8,["onClick"]),h(t,{type:"default",onClick:z(r)},{default:k((()=>e[1]||(e[1]=[S("清空规则")]))),_:1},8,["onClick"])],512),[[q,""!==z(l).mode]]),R(h(s,{class:"mt-[24rem]",options:[{content:"可粘贴识别快速选中多个选项，用,逗号分隔"}]},null,512),[[q,""!==z(l).mode]])])}}}),[["__scopeId","data-v-a3ff6782"]]),fa={class:"h-full"},ya={class:"flex"},xa=x({__name:"audit-log",setup(a,{expose:e}){const t=ta(),{loading:l,logContent:s}=O(t),{getAduitLogs:u}=t;return C(u),e({init:u}),(a,e)=>{const t=F;return R((w(),U("div",fa,[B("div",ya,[h(ea,{content:z(s),fullScreen:{title:"全屏查看审计日志",onRefresh:z(u)},style:{height:"53rem",width:"99.5%"}},null,8,["content","fullScreen"])])])),[[t,z(l).log]])}}}),Oa=x({__name:"index",props:{compData:{default:"base"}},setup(a,{expose:e}){const t=ta(),{resetData:l}=t,s=a,u=v(),o=v(s.compData||"base"),d=[{label:"基础设置",name:"base",render:()=>h(ua,null,null)},{label:"高级设置",name:"advanced",lazy:!0,render:()=>h(ba,null,null)},{label:"审计日志",name:"log",lazy:!0,render:()=>h(xa,null,null)}];return M((()=>{l()})),e({init:()=>{var a;const e=(null==(a=u.value)?void 0:a.getRef())||null;e&&e[o.value].init()}}),(a,e)=>{const t=g;return w(),I(t,{ref_key:"logTab",ref:u,class:"w-full h-full",modelValue:z(o),"onUpdate:modelValue":e[0]||(e[0]=a=>V(o)?o.value=a:null),options:d},null,8,["modelValue"])}}});export{Oa as default};
