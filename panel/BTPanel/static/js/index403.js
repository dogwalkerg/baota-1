import{_ as e}from"./index90.js?v=1734676359";import{e as a,ar as t,h as o,b as l,al as s,k as n,j as r,O as p,o as i}from"./utils-lib.js?v=1734676359";import{c as u,r as c,w as d,k as m,l as v,q as f,v as _,p as h,e as w,h as b,x as y,C as g,M as D,A as V,aZ as k,D as z,o as x,B as C,a7 as j,a4 as q}from"./base-lib.js?v=1734676359";import{u as U}from"./column.js?v=1734676359";import{setVersionPs as T,getVersionProject as R,nowFileBack as S,removeVersionProject as M,recoverVersionProject as B}from"./site.js?v=1734676359";import{_ as F}from"./index277.js?v=1734676359";import{u as H}from"./useStore7.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";const I={class:"download-speed"},O={class:"download-speed-top"},P={class:"download-speed-top-title"},E={class:"download-speed-top-score"},W=a(u({__name:"upload-speed",props:{compData:{default:()=>({})}},setup(e){const a=e,t=c(0);return d((()=>a.compData),(e=>{t.value=e.percentum})),(e,a)=>{const o=F;return m(),v("div",I,[f("div",O,[f("div",P,_(e.compData.title),1),f("div",E,_(h(t))+"%",1)]),w(o,{strokeWidth:5,percentage:h(t),showText:!1},null,8,["percentage"])])}}}),[["__scopeId","data-v-d2fa2cc6"]]),A={class:"p-2rem"},Z=u({__name:"upload-version-file",props:{compData:{default:{}}},setup(e,{expose:a}){const s=e,n=c(),r=c(),p=l(),i=window.location.protocol+"//"+window.location.host+"/mod/php/php_async/upload_version",u=c(!1),d=[".tar.gz",".gz",".zip",".tar",".bz2","xz"].join(","),_=b({f_size:0,f_path:"/tmp/",f_name:"",f_start:0,ps:s.compData.ps,version:s.compData.version,sitename:s.compData.sitename,blob:""}),x=c([]),C=c(0),j=({file:e,onProgress:a,onSuccess:o,onError:l})=>{const n=new FormData,r=Math.min(e.size,_.f_start+2097152);n.append("f_name",e.name),n.append("f_size",e.size),n.append("f_start",_.f_start.toString()),n.append("ps",s.compData.ps),n.append("version",s.compData.version),n.append("sitename",s.compData.sitename),n.append("blob",e.slice(_.f_start,r)),n.append("f_path",_.f_path);const i=t.CancelToken.source();return C.value||(u.value=!0),C.value=Math.round(_.f_start/e.size*100),t.post(s.compData.uploadUrl?s.compData.uploadUrl:"/mod/php/php_async/upload_version",n,{headers:{"Content-Range":"bytes ".concat(_.f_start,"-").concat(e.size,"/"),"x-http-token":window.vite_public_request_token,"Content-Type":"application/x-www-form-urlencoded"},onUploadProgress:e=>{e.event.lengthComputable&&a({percent:Math.round(100*e.loaded/e.total)})},cancelToken:i.token}).then((t=>{"number"==typeof t.data?(_.f_start=t.data,j({file:e,onProgress:a,onSuccess:o,onError:l})):(C.value=0,u.value=!1,p.request(t.data),s.compData.getVersion(),s.compData.close(),o(t.data))})).catch((e=>{C.value=0,u.value=!1,p.error("导入失败"),l(e)})),{abort(){i.cancel("Upload cancelled")}}},q=(e,a)=>{x.value=a},U=(e,a,t)=>{_.f_start=e.percent,x.value=t.map((t=>(t.uid===a.uid&&(t.percentage=e.percent),t)))},T=()=>{n.value.submit()};return a({onConfirm:T,open:()=>{r.value.$el.click()},fileData:_}),(e,a)=>{const t=V,l=k,s=o;return m(),v("div",null,[w(l,{"show-file-list":!1,class:"upload-demo",ref_key:"upload",ref:n,name:"blob",accept:h(d),action:i,"auto-upload":!0,multiple:!1,"file-list":h(x),"on-progress":U,"on-change":q,"http-request":j},{default:y((()=>[g(w(t,{ref_key:"openRef",ref:r,size:"small",type:"primary"},null,512),[[z,!1]]),g(w(t,{style:{"margin-left":"10px"},size:"small",type:"success",onClick:T},null,512),[[z,!1]])])),_:1},8,["accept","file-list"]),w(s,{title:!1,modelValue:h(u),"onUpdate:modelValue":a[0]||(a[0]=e=>D(u)?u.value=e:null),area:40},{default:y((()=>[f("div",A,[w(W,{compData:{title:"正在上传文件，请稍后...",percentum:h(C)}},null,8,["compData"])])])),_:1},8,["modelValue"])])}}}),$=u({__name:"index",setup(a,{expose:t}){const{siteInfo:u,activeType:d}=H(),f=d.value,_=l(),V=c(),k=c([]),z=c(!1),F=c(!1),I=c(),O=b({name:"",version:"",ps:""}),P={version:[{required:!0,message:"请输入版本号",trigger:"blur"}]},E=c(!1),W=c(),A=b({version:""}),{BtOperation:$}=s({options:[{label:"添加版本",type:"button",active:!0,onClick:()=>{O.ps="",O.version="",F.value=!0}},{label:"当前目录生成版本",type:"button",onClick:()=>{A.version="",E.value=!0}}]}),G=c([{label:"版本号",prop:"version"},{label:"备注",prop:"ps",minWidth:120,isCustom:!0,showOverflowTooltip:!1,render:e=>{var a;const t={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};return e.ps=null==(a=e.ps)?void 0:a.replace(/&(lt|gt|nbsp|amp|quot);/gi,(function(e,a){return t[a]})),w("input",{type:"text",value:e.ps,class:"bt-table-input w-full !whitespace-pre-line",placeholder:"点击编辑备注",onBlur:a=>{if(e.ps===a.target.value)return!1;e.ps=a.target.value,(async e=>{try{const a=await T({sitename:u.value.name,version:e.version,ps:e.ps},f);_.request(a),J()}catch(a){}})(e)}},null)}},U([{onClick:async e=>{let a;try{await i({title:"恢复版本【".concat(e.version,"】"),isHtml:!1,content:"恢复版本，会删除目录下所有文件后恢复，请将【当前目录生成版本】备份后继续操作？",type:"calc",icon:"warning-filled"}),a=_.load("正在恢复版本，请稍后...");const t=await B({sitename:u.value.name,version:e.version},f);_.request(t)}catch(t){}finally{a.close()}},title:"恢复"},{onClick:async e=>{try{await i({title:"删除版本【".concat(e.version,"】"),isHtml:!1,content:"删除版本，是否继续操作？",icon:"warning-filled"});const a=await M({sitename:u.value.name,version:e.version},f);_.request(a),a.status&&J()}catch(a){}},title:"删除"}])]),J=async()=>{z.value=!0;try{const{data:e}=await R({sitename:u.value.name},f);k.value=e.data,z.value=!1}catch(e){}},K=async()=>{let e;await W.value.validate();try{e=_.load("正在生成版本，请稍后...");const a=await S({sitename:u.value.name,version:A.version},f);_.request(a),a.status&&(E.value=!1,J())}catch(a){}finally{e.close()}},L=async()=>(await I.value.validate(),V.value.open(),!1),N=async e=>{};return x(J),t({init:J}),(a,t)=>{const l=n,s=r,i=j,c=p,d=q,f=o,_=e,b=C("bt-loading");return m(),v("div",null,[w(_,null,{"header-left":y((()=>[w(h($))])),"header-right":y((()=>t[5]||(t[5]=[]))),content:y((()=>[g(w(l,{"max-height":"500",column:h(G),data:h(k)},null,8,["column","data"]),[[b,h(z)]])])),"footer-left":y((()=>t[6]||(t[6]=[]))),"footer-right":y((()=>t[7]||(t[7]=[]))),popup:y((()=>[w(f,{title:"添加版本",area:44,modelValue:h(F),"onUpdate:modelValue":t[2]||(t[2]=e=>D(F)?F.value=e:null),"show-footer":"",confirmText:"上传文件",onConfirm:L},{default:y((()=>[w(d,{class:"p-[2rem]",ref_key:"addFromRef",ref:I,model:h(O),rules:P},{default:y((()=>[w(i,{label:"版本号",prop:"version"},{default:y((()=>[w(s,{modelValue:h(O).version,"onUpdate:modelValue":t[0]||(t[0]=e=>h(O).version=e),placeholder:"请输入版本号",width:"24rem"},null,8,["modelValue"])])),_:1}),w(i,{label:"备注",prop:"ps"},{default:y((()=>[w(s,{modelValue:h(O).ps,"onUpdate:modelValue":t[1]||(t[1]=e=>h(O).ps=e),placeholder:"请输入备注",width:"24rem"},null,8,["modelValue"])])),_:1}),w(Z,{ref_key:"fileIpRef",ref:V,onUploadSuccess:N,compData:{...h(O),sitename:h(u).name,getVersion:J,close:()=>{F.value=!1}}},null,8,["compData"]),w(c,{options:[{content:"支持zip,tar.gz,tar,bz2,gz,xz格式"}],class:"list-disc ml-[7rem]"})])),_:1},8,["model"])])),_:1},8,["modelValue"]),w(f,{title:"当前目录生成版本",area:44,modelValue:h(E),"onUpdate:modelValue":t[4]||(t[4]=e=>D(E)?E.value=e:null),"show-footer":"",onConfirm:K},{default:y((()=>[w(d,{class:"p-2rem",ref_key:"nowFromRef",ref:W,model:h(A),rules:P},{default:y((()=>[w(i,{label:"版本号",prop:"version"},{default:y((()=>[w(s,{modelValue:h(A).version,"onUpdate:modelValue":t[3]||(t[3]=e=>h(A).version=e),placeholder:"请输入版本号",width:"26rem"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])),_:1})])}}});export{$ as default};
