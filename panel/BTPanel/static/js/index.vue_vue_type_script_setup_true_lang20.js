var e,a;import{G as t,M as l,ah as s,o as n,t as o,u as r,D as u,j as i,aO as c,bR as p,l as m,h as d}from"./utils-lib.js?v=1734676359";import{g as v,r as g,h as y,c as f,o as h,k as w,l as x,p as _,q as b,e as V,M as j,Q as k,z as S,x as C,y as z,I as E,v as N,G as T,i as O,ag as U,ah as L,A as I,aw as J,aY as q}from"./base-lib.js?v=1734676359";import{_ as M}from"./index88.js?v=1734676359";import{_ as B}from"./index101.js?v=1734676359";import{m as G}from"./form-item.js?v=1734676359";import{f as R}from"./validator.js?v=1734676359";import{u as H}from"./useStore7.js?v=1734676359";import{changeProjectPath as $,mamgerLogSplit as P,getProjectLogs as F,setLogSplit as A,getLogSplit as D,setProjectLogStatus as Q}from"./site.js?v=1734676359";const Y=v("SITE-PROJECT-LOG-STORE",(()=>{const{siteInfo:e,siteType:a}=H();return{getLogEvent:async e=>{try{const{data:t}=await F(e,a.value);return{data:t,status:!0}}catch(t){return{status:!1,msg:"获取日志失败"}}},savePathEvent:async e=>{try{const l=await t({loading:"正在保存日志配置，请稍后...",request:$(e,a.value),message:!0});return{status:l.status,msg:l.msg}}catch(l){return{status:!1,msg:"保存日志路径失败"}}},saveSplitTaskEvent:async e=>{try{const l=await t({loading:"正在设置日志切割任务，请稍后...",request:P(e,a.value),message:!0});return{status:l.status,msg:l.msg}}catch(l){return{status:!1,msg:"保存日志切割配置失败"}}},setLogSplitEvent:async(e,t=!0)=>{let n;try{n=l.load("正在设置日志切割任务，请稍后...");const s=await A(e,a.value);return t&&l.request(s),s}catch(o){s(o)}finally{null==n||n.close()}},getLogSplitEvent:async e=>{try{const{data:t}=await D(e,a.value);return{data:t,status:!0}}catch(t){return{status:!1,msg:"获取日志切割信息失败"}}}}})),{siteInfo:K,siteType:W,isRefreshList:X}=H(),{savePathEvent:Z,setLogSplitEvent:ee,getLogSplitEvent:ae,saveSplitTaskEvent:te,getLogEvent:le}=Y(),se=g(!!(null==(a=null==(e=K.value)?void 0:e.project_config)?void 0:a.nohup_log)),ne=g(!1),oe=g(!1),re=g(null),ue=g(!1),ie=g(!1),ce=g("开启后默认每天2点0分进行切割日志文件，如需修改请点击"),pe=y({path:"",logs:"",type:"",split:!1,size:"",isNew:!1,isGunicorn:!1}),me=async()=>{t({loading:"正在设置控制台日志状态，请稍后...",request:Q({project_name:K.value.name,status:se.value?1:0}),message:!0,success:e=>{e.status?X.value=!0:se.value=!se.value}})},de=async()=>{try{const e=W.value,a={python:{data:JSON.stringify({name:K.value.name,data:{logpath:pe.path,loglevel:pe.type}})},default:{data:JSON.stringify({project_name:K.value.name,path:pe.path})}},t=await Z(a[e]||a.default);return t.status&&(K.value.project_config.log_path=pe.path,he()),t}catch(e){return{status:!1,msg:"保存日志路径失败"}}},ve=()=>{oe.value=!0,re.value=setInterval((()=>{he()}),2e3)},ge=()=>{oe.value=!1,re.value&&clearInterval(re.value)},ye=async e=>{try{const{name:a}=K.value,t=["net"].includes(W.value);if("1"===e.type&&!Number(e.log_size))return l.error("请填写日志大小"),!1;if(!pe.split){let e={data:JSON.stringify({[t?"project_name":"name"]:a})};await ee(e,!1)}const s={data:JSON.stringify({[t?"project_name":"name"]:a,hour:e.hour.toString(),minute:e.minute.toString(),num:e.num.toString(),compress:e.compress,log_size:"1"===e.type?e.log_size:5})},n=await te(s);return n.status&&(ue.value=!1,we(),ue.value=!1),n.status}catch(a){return!1}},fe=async e=>{pe.split=!e;const a=["net"].includes(W.value);await n({title:"设置日志切割任务",content:"".concat(e?"开启后":"关闭后停止","对该项目日志进行切割，是否继续操作？")});let t={data:JSON.stringify({[a?"project_name":"name"]:K.value.name})};const s=pe.isNew?await te(t):await ee(t);pe.isNew||l.request(s),s.status&&(await we(),await he())},he=async()=>{var e;ne.value=!0;try{const a={python:{name:K.value.name},default:{project_name:K.value.name}},t=a[W.value]||a.default,{data:l}=await le(t);let s=null==(e=K.value.project_config)?void 0:e.log_path;pe.logs=l.data||"暂无日志信息",pe.path=l.path||s||"",pe.size=l.size||l.szie||"0B",ne.value=!1}catch(a){s(a)}finally{ne.value=!1}},we=async(e=W.value)=>{try{ne.value=!0;const{name:a}=K.value,t={net:{project_name:a,data:JSON.stringify({project_name:a})},python:{name:a},default:{data:JSON.stringify({name:a})}},{data:l}=await ae(t[e]||t.default);let s={hour:"2",minute:"0",num:"180",compress:!1,log_size:5,type:"0"};return l.status?(pe.isNew=!1,pe.split=!!l.data.status,s={hour:l.data.hour,minute:l.data.minute,num:l.data.num,compress:l.data.compress,log_size:o(l.data.log_size,!1,2,"MB"),type:l.data.log_size?"1":"0"},ce.value="开启后".concat("1"===s.type?"日志文件大小超过":"默认每天").concat("1"===s.type?s.log_size+"MB":"".concat(s.hour,"点").concat(s.minute,"分"),"进行切割日志文件，如需修改请点击")):(pe.isNew=!0,pe.split=!1),ne.value=!1,{data:s,status:l.status}}catch(a){return s(a),{data:{},status:!1}}finally{ne.value=!1}},xe=()=>{he()},_e={class:"flex flex-col"},be={key:0,class:"flex h-3.2rem items-center mb-1rem"},Ve={class:"flex items-center"},je={key:0},ke={class:"mt-[16px] flex items-center"},Se={class:"mt-[16px] flex items-center"},Ce={class:"ml-[8px]"},ze={key:0,class:"mt-[16px] leading-8 text-[1.2rem] list-disc ml-[20px]"},Ee={class:"mt-[16px]"},Ne={key:0,class:"mb-[16px]"},Te={class:"p-[12px] w-full flex items-start overflow-y-auto h-full"},Oe=["innerHTML"],Ue={class:"p-2rem"},Le={class:"flex items-center"},Ie={class:"mt-[16px] flex items-center"},Je={class:"ml-[8px]"},qe={class:"py-20x"},Me=f({__name:"index",setup(e,{expose:a}){const{mainHeight:t}=r(),{siteType:l,siteInfo:s}=H(),n=()=>{R({type:"dir",path:pe.path,change:e=>{pe.path=e}})},{BtForm:o,submit:v}=u({data:async()=>{const{data:e}=await we();return e},options:e=>O((()=>[{type:"radio",label:"切割方式",key:"type",options:[{label:"按日志大小",value:"1"},{label:"按执行周期",value:"0"}]},..."0"===e.value.type?[{type:"custom",render:()=>V(c,{label:"执行时间"},{default:()=>[V("div",{class:"flex items-center"},[V(i,{width:"18.6rem",modelValue:e.value.hour,"onUpdate:modelValue":a=>e.value.hour=a},{prepend:"每天",append:"时"}),V(i,{width:"12rem",modelValue:e.value.minute,"onUpdate:modelValue":a=>e.value.minute=a},{append:"分"})])]}),rules:{hour:[{validator:(a,t,l)=>{"0"!==e.value.type||/^(?:[01]?[0-9]|2[0-3])$/.test(t)?l():l(new Error("请输入0-23的整数"))},trigger:["blur","change"]}],minute:[{validator:(a,t,l)=>{"0"!==e.value.type||/^[0-5]?[0-9]$/.test(t)?l():l(new Error("请输入0-59的整数"))},trigger:["blur","change"]}]}}]:[G("日志大小","log_size","MB",{attrs:{style:"width: 24rem;"},rules:[{required:!0,message:"请输入日志大小",trigger:["blur","change"]},{validator:(e,a,t)=>{!/^\d+(\.\d+)?$/.test(a)||a<=0?t(new Error("请输入大于0的数")):t()},trigger:["blur","change"]}]})],{type:"custom",render:()=>V(c,{label:"保留最新",prop:"num"},{default:()=>[V(i,{type:"number",modelValue:e.value.num,"onUpdate:modelValue":a=>e.value.num=a,class:"!w-[24rem]"},{append:"份"})]}),rules:{num:[p({message:"请输入保留最新份数"}),{validator:(e,a,t)=>{/^(?:[1-9]\d{0,2}|1[01]\d{2}|1800)$/.test(a)?t():t(new Error("请输入1-1800的整数"))},trigger:["blur","change"]}]}},{type:"custom",render:()=>V(c,{label:" "},{default:()=>[V(k,{modelValue:e.value.compress,"onUpdate:modelValue":a=>e.value.compress=a},{default:()=>[z("切割后压缩日志")]})]})},..."java"===l.value?[{type:"button",label:" ",slots:"保存",attrs:{type:"primary",onClick:()=>{v()}}}]:[],{type:"help",options:[..."1"===e.value.type?[{content:"每5分钟执行一次"},{content:"【日志大小】：日志文件大小超过指定大小时进行切割日志文件"}]:[],{content:"【保留最新】：保留最新的日志文件，超过指定数量时，将自动删除旧的日志文件"}]}])),submit:async(e,a)=>(await a(),await ye(e.value))}),g=()=>{m({title:"配置日志切割任务",area:50,showFooter:!0,component:()=>V(o,{class:"p-2rem"},null),onConfirm:v})};return h(xe),a({init:xe}),(e,a)=>{var r,u;const i=U,c=L,p=M,m=I,v=J,y=q,f=d;return w(),x("div",_e,["springboot"===(null==(u=null==(r=_(s))?void 0:r.project_config)?void 0:u.java_type)?(w(),x("div",be,[a[8]||(a[8]=b("span",{class:"inline-block mr-[1rem]"},"控制台日志",-1)),V(_(k),{slot:"reference",modelValue:_(se),"onUpdate:modelValue":a[0]||(a[0]=e=>j(se)?se.value=e:null),size:"small",onChange:_(me)},null,8,["modelValue","onChange"])])):S("",!0),b("div",Ve,[_(pe).isGunicorn?(w(),x("div",je,[a[9]||(a[9]=b("span",null,"日志级别",-1)),V(c,{class:"mx-[8px] w-[10rem]",modelValue:_(pe).type,"onUpdate:modelValue":a[1]||(a[1]=e=>_(pe).type=e)},{default:C((()=>[V(i,{label:"debug",value:"debug"}),V(i,{label:"info",value:"info"}),V(i,{label:"warning",value:"warning"}),V(i,{label:"error",value:"error"}),V(i,{label:"critical",value:"critical"})])),_:1},8,["modelValue"])])):S("",!0),a[11]||(a[11]=b("span",{class:"mr-[8px]"},"日志路径",-1)),V(p,{modelValue:_(pe).path,"onUpdate:modelValue":a[2]||(a[2]=e=>_(pe).path=e),icon:"el-folder-opened",onIconClick:n,width:"38rem"},null,8,["modelValue"]),V(m,{class:"ml-[8px]",type:"primary",onClick:_(de)},{default:C((()=>a[10]||(a[10]=[z("保存")]))),_:1},8,["onClick"])]),"java"!==_(l)?(w(),x(E,{key:1},[b("div",ke,[a[12]||(a[12]=b("span",{class:"mr-[8px]"},"日志大小",-1)),b("span",null,N(_(pe).size),1)]),b("div",Se,[V(v,{placement:"bottom",width:"200","popper-class":"green-tips-popover",trigger:"hover"},{reference:C((()=>[V(_(k),{modelValue:_(pe).split,"onUpdate:modelValue":a[3]||(a[3]=e=>_(pe).split=e),size:"small",onChange:_(fe)},{default:C((()=>a[13]||(a[13]=[z("日志切割")]))),_:1},8,["modelValue","onChange"])])),default:C((()=>[a[14]||(a[14]=b("span",{class:"p-[8px] inline-block"},"当日志文件过大时，读取和搜索时间会增加，同时也会占用存储空间，因此需要对日志进行切割以方便管理和维护。",-1))])),_:1}),b("span",Ce,[z(N(_(ce)),1),b("span",{class:"bt-link",onClick:g},"编辑配置")])]),"java"===_(l)?(w(),x("ul",ze,a[15]||(a[15]=[b("li",null,"修改日志路径会重启项目",-1),b("li",null,"Tomcat内置项目，修改日志路径会对当前版本Tomcat的所有站点生效，不能单独设置",-1)]))):S("",!0)],64)):S("",!0),b("div",Ee,["java"===_(l)?(w(),x("div",Ne,[V(m,{onClick:_(he)},{default:C((()=>a[16]||(a[16]=[z("刷新日志")]))),_:1},8,["onClick"]),V(m,{type:"default",onClick:_(ve)},{default:C((()=>a[17]||(a[17]=[z("实时日志")]))),_:1},8,["onClick"]),V(y,{direction:"vertical"}),V(m,{type:"default",onClick:a[4]||(a[4]=e=>ie.value=!0)},{default:C((()=>a[18]||(a[18]=[z("日志切割设置")]))),_:1})])):S("",!0),V(B,{content:_(pe).logs,isHtml:!0,fullScreen:{title:"全屏查看【项目】日志",onRefresh:_(he)},style:T({height:"java"===_(l)?"46rem":"54rem",width:"99.5%"})},null,8,["content","fullScreen","style"])]),V(f,{title:"查看日志",onCancel:_(ge),modelValue:_(oe),"onUpdate:modelValue":a[5]||(a[5]=e=>j(oe)?oe.value=e:null),area:["100%","100%"],"close-btn":2},{default:C((()=>[b("div",{class:"bg-[#333] text-white w-full h-full",style:T("height: ".concat(_(t),"px;"))},[b("pre",Te,[a[19]||(a[19]=z("\t\t\t\t\t")),b("code",{class:"flex-1 w-full p-0 bg-none whitespace-pre-line text-i text-[#ececec]",innerHTML:_(pe).logs},null,8,Oe),a[20]||(a[20]=z("\n\t\t\t\t"))])],4)])),_:1},8,["onCancel","modelValue"]),V(f,{title:"日志切割设置",modelValue:_(ie),"onUpdate:modelValue":a[7]||(a[7]=e=>j(ie)?ie.value=e:null),area:56},{default:C((()=>[b("div",Ue,[b("div",Le,[a[21]||(a[21]=b("span",{class:"mr-[8px]"},"日志大小",-1)),b("span",null,N(_(pe).size),1)]),b("div",Ie,[V(v,{placement:"bottom",width:"200","popper-class":"green-tips-popover",trigger:"hover"},{reference:C((()=>[V(_(k),{modelValue:_(pe).split,"onUpdate:modelValue":a[6]||(a[6]=e=>_(pe).split=e),size:"small",onChange:_(fe)},{default:C((()=>a[22]||(a[22]=[z("日志切割")]))),_:1},8,["modelValue","onChange"])])),default:C((()=>[a[23]||(a[23]=b("span",{class:"p-[8px] inline-block"},"当日志文件过大时，读取和搜索时间会增加，同时也会占用存储空间，因此需要对日志进行切割以方便管理和维护。",-1))])),_:1}),b("span",Je,N(_(ce).replace("修改请点击","修改下面配置")),1)]),V(y),b("div",qe,[V(_(o),{class:"py-2rem -ml-1rem"})])])])),_:1},8,["modelValue"])])}}});export{Me as _};
