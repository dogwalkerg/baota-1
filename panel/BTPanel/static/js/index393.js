import{_ as e}from"./index90.js?v=1734676359";import{B as a}from"./index185.js?v=1734676359";import{u as l,G as t,M as s,ah as o,o as r,k as n,V as u,j as i,O as d,h as p}from"./utils-lib.js?v=1734676359";import{c,r as m,h as y,o as v,B as b,k as h,l as f,e as x,x as g,y as V,C as w,p as _,M as U,q as k,J as j,z as C,I as q,aX as R,R as L,A as E,aj as S,a7 as M,a4 as N}from"./base-lib.js?v=1734676359";import{_ as J}from"./index99.js?v=1734676359";import{modifyModulesProxy as O,modifyProxy as I,getProxyFile as A,removeModulesProxy as B,removeProxy as P,getModulesProxyList as T,getProxyList as z,asyncSaveProxyFile as D,saveRedirectFile as F,createProxySite as G,createProxy as H}from"./site.js?v=1734676359";import{b as X,u as $,c as K}from"./column.js?v=1734676359";import{q as Q}from"./useController3.js?v=1734676359";import{u as W}from"./useStore7.js?v=1734676359";import"./ace.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";import"./validator.js?v=1734676359";const Y={class:"p-[20px]"},Z={class:"flex items-center"},ee={class:"flex items-center"},ae=["onClick"],le={class:"p-2rem"},te=c({__name:"index",props:{compData:{default:()=>({})}},setup(c,{expose:te}){var se,oe;const{plugin:re}=l(),{siteInfo:ne}=W(),{webserver:ue}=re.value,ie=m(null==(oe=null==(se=ne.value)?void 0:se.project_type)?void 0:oe.toLowerCase()),de=m();m(""),m([]),m("");const pe=m([]),ce=m(!1),me=m(!1),ye=m({}),ve=y({proxyname:[{required:!0,message:"请输入代理名称",trigger:["blur","change"]},{trigger:["blur","input","change"],validator:(e,a,l)=>{a.length<3?l(new Error("代理名称必须大于3个字符串")):l()}}],proxysite:[{required:!0,message:"请输入目标url",trigger:"blur",validator:(e,a,l)=>{a?l():l(new Error("目标URL不能为空"))}}],todomain:[{required:!0,message:"请输入发送域名",trigger:["blur","change"]}]}),be=m({isEdit:!1,type:!0,cache:!1,advanced:!1,proxyname:"",cachetime:1,proxydir:"/",proxysite:"http://",todomain:"",subfilter:[{sub1:"",sub2:"",id:1}],subNum:1,path:"",content:""}),he=m(!1),fe=m(!1),xe=[{content:"代理目录：访问这个目录时将会把目标URL的内容返回并显示(需要开启高级功能)"},{content:"目标URL：可以填写你需要代理的站点，目标URL必须为可正常访问的URL，否则将返回错误"},{content:"发送域名：将域名添加到请求头传递到代理服务器，默认为目标URL域名，若设置不当可能导致代理无法正常运行"},{content:"内容替换：只能在使用nginx时提供，最多可以添加3条替换内容,如果不需要替换请留空"}],ge=async(e,a,l,t)=>{const{label:s,value:o}=t,r=new Map([["start","批量启动选中的规则后，配置的反向代理规则将继续生效"],["stop","批量停用选中的规则后，配置的反向代理规则将会失效"],["delete","批量删除选中的规则后，配置的反向代理规则将会彻底失效"]]),n=async(e,a)=>{const{proxyname:l,subfilter:t}=e,s=["proxy","phpasync"].includes(ie.value);switch(o){case"start":case"stop":let a={...e,subfilter:JSON.stringify(t),type:"start"===o?1:0};const r=s?await O(a,ie.value):await I(a);return{...e,batchStatus:r.status?1:2,message:r.msg};case"delete":const n={sitename:ne.value.name,proxyname:"phpasync"===ie.value?[l]:l},u=s?await B(n,ie.value):await P(n);return{...e,batchStatus:u.status?1:2,message:u.msg}}};await e({title:"批量".concat(s),content:"".concat(r.get(o),"，是否继续操作？"),column:[{label:"名称",prop:"proxyname"},K()],onConfirm:async()=>(await a(n),Se(),!1)})},Ve=e=>{let a=e.replace(/^http[s]?:\/\//,"");a=a.replace(/(:|\?|\/|\\)(.*)$/,""),be.value.todomain=a},we=async(e,a)=>{let l={...e,subfilter:JSON.stringify(e.subfilter)};"cache"===a?l.cache=e.cache?0:1:l.type=e.type?0:1;const s=["proxy","phpasync"].includes(ie.value);(await t({loading:"正在修改状态中，请稍后...",request:s?O(l,ie.value):I(l),message:!0})).status&&Se()},_e=async e=>{try{const{data:a}=await A({sitename:ne.value.name,proxyname:e.proxyname,webserver:ue});!1===a.status?s.request(a):(be.value.content=a[0].data,be.value.path=a[1],be.value.proxyname=e.proxyname,fe.value=!0)}catch(a){o(a)}},Ue=async()=>{const e="phpasync"===ie.value,a=e?D:F,l={path:be.value.path,[e?"config":"data"]:be.value.content,encoding:"utf-8"};(await t({loading:"正在保存配置文件，请稍后...",request:a(l),message:!0})).status&&(fe.value=!1,Ce(),Se())},ke=async e=>{be.value.isEdit=!0,be.value.proxyname=e.proxyname,be.value.proxydir=e.proxydir,be.value.proxysite=e.proxysite,be.value.todomain=e.todomain,be.value.type=!!e.type,be.value.cache=!!e.cache,be.value.advanced=!!e.advanced,be.value.cachetime=e.cachetime,be.value.subfilter=e.subfilter.map(((e,a)=>({sub1:e.sub1,sub2:e.sub2,id:a}))).filter((e=>""!==e.sub1)),he.value=!0},je=async()=>{Ce(),he.value=!0},Ce=async()=>{be.value.isEdit=!1,be.value.proxyname="",be.value.proxydir="/",be.value.proxysite="http://",be.value.todomain="",be.value.type=!0,be.value.cache=!1,be.value.advanced=!1,be.value.cachetime=1,be.value.subfilter=[{sub1:"",sub2:"",id:1}],be.value.subNum=1},qe=async()=>{3!==be.value.subfilter.length?be.value.subfilter.push({sub1:"",sub2:"",id:100*Math.random()}):s.error("最多添加三条内容替换")},Re=e=>{const a=[...e];for(;a.length<3;)a.push({sub1:"",sub2:""});return a.map(((e,a)=>({sub1:e.sub1,sub2:e.sub2,id:100*Math.random()})))},Le=async()=>{await ye.value.validate();const{isEdit:e,type:a,subfilter:l,cache:s,advanced:o,proxyname:r,proxydir:n,proxysite:u,todomain:i,cachetime:d}=be.value;let p={subfilter:JSON.stringify(Re(l).map((e=>({sub1:e.sub1,sub2:e.sub2})))),type:a?1:0,cache:s?1:0,advanced:o?1:0,sitename:ne.value.name,proxyname:r,proxydir:n,proxysite:u,todomain:i,cachetime:d};const c=["proxy","phpasync"].includes(ie.value),m=e?O:G,y=e?I:H;(await t({loading:me,request:c?m(p,ie.value):y(p),message:!0})).status&&(Se(),he.value=!1)},Ee=async e=>{await r({title:"删除反向代理规则【".concat(e.proxyname,"】"),content:"删除选中的规则后，配置的反向代理规则将会彻底失效，是否继续操作？",icon:"warning-filled"});const a=["proxy","phpasync"].includes(ie.value),l={phpasync:{sitename:ne.value.name,proxyname:e.proxyname},default:{sitename:ne.value.name,proxyname:[e.proxyname]}},s=l[ie.value]||l.default;(await t({loading:"正在删除，请稍后...",request:a?B(s,ie.value):P(l.default),message:!0})).status&&Se()},Se=async()=>{const e={sitename:ne.value.name},a=["proxy","phpasync"].includes(ie.value);await t({loading:ce,request:a?T(e,ie.value):z(e),data:[Array,pe]})},Me=[{label:"启用反向代理规则",value:"start",event:ge},{label:"停用反向代理规则",value:"stop",event:ge},{label:"删除反向代理规则",value:"delete",event:ge}],Ne=L([{type:"selection"},{label:"名称",prop:"proxyname"},{label:"代理目录",prop:"proxydir"},{label:"目标URL",width:140,render:e=>x("span",{class:"bt-link",onClick:()=>{window.open(e.proxysite)}},[e.proxysite])},{prop:"cache",label:"缓存",width:60,render:e=>{const{cache:a}=e;return x("span",{class:"".concat(a?"bt-link":"bt-danger"),onClick:()=>{we(e,"cache")}},[a?"已开启":"已关闭"])}},X({prop:"type",event:we,data:["已暂停","运行中"]}),$([{onClick:_e,title:"配置文件",width:56},{onClick:ke,title:"编辑"},{onClick:Ee,title:"删除"}])]);return v(Se),te({init:Se}),(l,t)=>{const o=E,r=J,c=n,m=u,y=S,v=M,L=i,O=N,I=d,A=p,B=a,P=e,T=b("bt-loading");return h(),f("div",null,[x(P,null,{"header-left":g((()=>[x(o,{type:"primary",onClick:je},{default:g((()=>t[11]||(t[11]=[V("添加反向代理")]))),_:1})])),"header-right":g((()=>[x(r,{onRefresh:Se})])),content:g((()=>[w(x(c,{ref_key:"reverseTableRef",ref:de,column:_(Ne),"min-height":520,data:_(pe)},null,8,["column","data"]),[[T,_(ce)],[T,"正在获取列表，请稍候...","title"]])])),"footer-left":g((()=>[x(m,{"table-ref":_(de),options:_(Me)},null,8,["table-ref","options"])])),"footer-right":g((()=>t[12]||(t[12]=[]))),popup:g((()=>[x(A,{title:_(be).isEdit?"修改反向代理【".concat(_(be).proxyname,"】"):"添加反向代理",modelValue:_(he),"onUpdate:modelValue":t[8]||(t[8]=e=>U(he)?he.value=e:null),"show-footer":!0,area:68,onConfirm:Le},{default:g((()=>[k("div",Y,[x(O,{ref_key:"proxyForm",ref:ye,model:_(be),rules:_(ve),disabled:_(me),"label-width":"80px"},{default:g((()=>[x(v,{label:"开启代理"},{default:g((()=>[k("div",Z,[x(y,{modelValue:_(be).type,"onUpdate:modelValue":t[0]||(t[0]=e=>_(be).type=e)},null,8,["modelValue"]),x(v,{label:"开启缓存",class:"!mt-0"},{default:g((()=>[x(y,{modelValue:_(be).cache,"onUpdate:modelValue":t[1]||(t[1]=e=>_(be).cache=e)},null,8,["modelValue"])])),_:1}),x(v,{label:"高级功能",class:"!mt-0"},{default:g((()=>[x(y,{modelValue:_(be).advanced,"onUpdate:modelValue":t[2]||(t[2]=e=>_(be).advanced=e)},null,8,["modelValue"])])),_:1})])])),_:1}),x(v,{label:"代理名称",prop:"proxyname"},{default:g((()=>[x(L,{modelValue:_(be).proxyname,"onUpdate:modelValue":t[3]||(t[3]=e=>_(be).proxyname=e),disabled:_(be).isEdit,placeholder:"请输入代理名称",width:"20rem"},null,8,["modelValue","disabled"])])),_:1}),_(be).cache?(h(),j(v,{key:0,label:"缓存时间",prop:"cachetime"},{default:g((()=>[x(L,{modelValue:_(be).cachetime,"onUpdate:modelValue":t[4]||(t[4]=e=>_(be).cachetime=e),placeholder:"请输入缓存时间",width:"20rem",textType:"分钟"},{append:g((()=>t[13]||(t[13]=[V(" 分钟 ")]))),_:1},8,["modelValue"])])),_:1})):C("",!0),_(be).advanced?(h(),j(v,{key:1,label:"代理目录",prop:"proxydir"},{default:g((()=>[x(L,{modelValue:_(be).proxydir,"onUpdate:modelValue":t[5]||(t[5]=e=>_(be).proxydir=e),placeholder:"请输入代理目录",width:"20rem"},null,8,["modelValue"])])),_:1})):C("",!0),x(v,{label:"目标URL",prop:"proxysite","label-width":"80px"},{default:g((()=>[k("div",ee,[x(L,{modelValue:_(be).proxysite,"onUpdate:modelValue":t[6]||(t[6]=e=>_(be).proxysite=e),placeholder:"请输入目标URL",width:"20rem",onInput:Ve},null,8,["modelValue"]),x(v,{label:"发送域名",prop:"todomain","label-width":"50px"},{default:g((()=>[x(L,{modelValue:_(be).todomain,"onUpdate:modelValue":t[7]||(t[7]=e=>_(be).todomain=e),placeholder:"请输入发送域名",width:"20rem"},null,8,["modelValue"])])),_:1})])])),_:1}),x(v,{label:"内容替换"},{default:g((()=>[(h(!0),f(q,null,R(_(be).subfilter,((e,a)=>(h(),f("div",{key:e.id,class:"flex items-center mb-1rem"},[x(L,{modelValue:e.sub1,"onUpdate:modelValue":a=>e.sub1=a,placeholder:"被替换的文本，可留空",width:"20rem",class:"mr-2rem !w-20rem"},null,8,["modelValue","onUpdate:modelValue"]),x(L,{modelValue:e.sub2,"onUpdate:modelValue":a=>e.sub2=a,placeholder:"替换为，可留空",width:"20rem",class:"mr-1rem !w-20rem"},null,8,["modelValue","onUpdate:modelValue"]),k("span",{class:"text-danger cursor-pointer",onClick:a=>(async e=>{1!==be.value.subfilter.length?be.value.subfilter=be.value.subfilter.filter((a=>a.id!==e.id)):s.error("至少保留一条内容替换")})(e)},"删除",8,ae)])))),128)),x(o,{disabled:3===_(be).subfilter.length,type:"primary",class:"!mt-1rem",onClick:qe},{default:g((()=>t[14]||(t[14]=[k("span",{class:"svgtofont-el-plus"},null,-1),V(" 添加内容替换 ")]))),_:1},8,["disabled"])])),_:1})])),_:1},8,["model","rules","disabled"]),x(I,{options:xe,class:"mt-2rem pl-2rem"})])])),_:1},8,["title","modelValue"]),x(A,{title:"编辑配置文件【".concat(_(be).proxyname,"】"),modelValue:_(fe),"onUpdate:modelValue":t[10]||(t[10]=e=>U(fe)?fe.value=e:null),area:55},{default:g((()=>[k("div",le,[t[16]||(t[16]=k("div",{class:"text-[#666] h-[2rem] leading-[2rem] mb-[1rem]"},"提示：Ctrl+S 保存",-1)),x(B,{modelValue:_(be).content,"onUpdate:modelValue":t[9]||(t[9]=e=>_(be).content=e),filePath:_(be).path,config:_(Q)(),request:!1,class:"!h-38rem"},null,8,["modelValue","filePath","config"]),x(o,{type:"primary",class:"!mt-2rem",onClick:Ue},{default:g((()=>t[15]||(t[15]=[V("保存")]))),_:1})])])),_:1},8,["title","modelValue"])])),_:1}),t[17]||(t[17]=k("ul",{class:"mt-[20px] leading-8 text-[1.2rem] list-disc ml-[20px]"},[k("li",null,"设置了反向代理后，【访问限制】中的相应路径的规则将会失效")],-1))])}}});export{te as default};
