import{_ as a}from"./index90.js?v=1734676359";import{s as t,g as e,r as n,e as s,c as r,k as i,l,q as o,x as u,y as m,p as d,M as c,v as p,C as v,D as y,z as h,i as g,aw as f,A as b}from"./base-lib.js?v=1734676359";import{G as w,bb as _,M as x,J as j,bU as S,bV as N,o as O,ah as T,bX as D,an as E,D as P,bR as J,bS as k,l as C,j as I,ao as B}from"./utils-lib.js?v=1734676359";import{B as q}from"./index353.js?v=1734676359";import{h as M}from"./form-item.js?v=1734676359";import{u as V,S as A}from"./useStore7.js?v=1734676359";import{c as H}from"./useController3.js?v=1734676359";import{getOtherDomainList as R,getHttpsPort as U,setProxyHttpsPort as F,setHttpsPort as L,addDomain as z,addProjectDomain as G,removeDomain as X,removeProjectDomain as K,multiRemoveProjectDomain as Q}from"./site.js?v=1734676359";import{u as W}from"./useStore11.js?v=1734676359";const Y=e("SITE-DOMAIN-STORE",(()=>{const{siteType:a,siteInfo:t}=V(),e=n();return{isRefreshDomain:n(!1),port:e,delMultDomainEvent:async t=>{const e=x.load("正在删除域名，请稍后...");try{let e=[];const{data:n}=await Q(t,a.value);if(null==n?void 0:n.success){e=n.success.map((a=>({name:a,status:!0})));const a=Object.entries(n.error).map((([a,t])=>({name:a,msg:t,status:!1})));e=e.concat(a)}return Array.isArray(n.data)&&(e=n.data.map((a=>({name:(null==a?void 0:a.name)||(null==a?void 0:a.domain),msg:a.msg,status:a.status})))),{data:e,status:!0}}catch(n){return{status:!1,msg:"删除域名失败"}}finally{e.close()}},getDomainListEvent:async(t,e)=>{try{const n=await w({request:e.isSpecial?await _(t):await R(t,a.value),...e.isPort?{}:{data:Array}});return{data:e.isPort?n.data.data:n,status:!0}}catch(n){return{status:!1,msg:"获取域名信息失败"}}},getPortEvent:async()=>{try{const a=await U({siteName:t.value.name});return e.value=a.data||"未开启",{data:a.data,status:a.status}}catch(a){return{status:!1,msg:"获取https端口失败"}}},addDomainEvent:async t=>{try{const e=await w({loading:"正在添加域名，请稍后...",request:"php"===a.value?z(t):G(t,a.value)});return{status:e.status,msg:e.msg,data:e.data}}catch(e){return{status:!1,msg:"添加域名失败"}}},setPortEvent:async t=>{try{const e="proxy"===a.value?F:L;return{...await w({loading:"正在设置HTTPS端口，请稍候...",request:e(t),message:!0})}}catch(e){return{status:!1,msg:"设置https端口失败"}}},delDomainEvent:async t=>{var e;let n=x.load("正在删除域名，请稍后...");try{const n=a.value,s="php"===n?await X(t):await K(t,n),r=(null==(e=s.data)?void 0:e.hasOwnProperty("status"))?s.data:s;return j(r.data)?{status:r.status,msg:r.data[0].msg}:{status:r.status,msg:(null==r?void 0:r.data)||(null==r?void 0:r.error_msg)||r.msg}}catch(s){return{status:!1,msg:"删除域名失败"}}finally{n.close()}}}})),Z=()=>t(Y()),{isBindExtranet:$,siteType:aa,siteInfo:ta}=V(),{getProjectConfig:ea}=A(),{port:na,isRefreshDomain:sa}=Z(),{getDomainListEvent:ra,getPortEvent:ia,setPortEvent:la,addDomainEvent:oa,delDomainEvent:ua,delMultDomainEvent:ma}=Y(),da=n(!1),ca=n(""),pa=["php","html"],va=[{label:"域名",prop:"name"},{label:"结果",align:"right",render:a=>{const t=a;return s("span",{class:"".concat(t.status?"text-primary":"text-danger"),innerHTML:t.status?(null==t?void 0:t.msg)||"操作成功":(null==t?void 0:t.msg)||"操作失败"},null)}}],ya=async()=>{var a,t,e,n,s,r;try{const i=ca.value,l=["21","25","443","888","8888","8443"];if(""===i)return x.error("域名不能为空"),!1;let o=String(i.match(/:(\d+)/g)).replace(/:/g,"");if(l.includes(o))return x.error("端口不能为常用端口21、25、443、888、8888、8443"),!1;if(!(await ga()))return!1;const u=(a=>{const{name:t,id:e}=ta.value,n=aa.value,s=a.split("\n"),r=JSON.stringify(s),i={php:{domain:a.replace(/\n/g,","),webname:t,id:e},python:{data:JSON.stringify({name:t,domains:s})},phpasync:{sitename:t,domains:r},proxy:{id:e,site_name:t,domains:a},java:{project_name:t,domains:r},default:{data:JSON.stringify({project_name:t,domains:s})}};return i[n]||i.default})(i),m=await oa(u);return m.status&&((null==(t=null==(a=null==m?void 0:m.data)?void 0:a.domains)?void 0:t.length)||(null==(n=null==(e=null==m?void 0:m.data)?void 0:e.data)?void 0:n.length))&&H({title:"域名添加结果",resultData:(null==(s=null==m?void 0:m.data)?void 0:s.domains)||(null==(r=null==m?void 0:m.data)?void 0:r.data)||[],autoTitle:"添加域名完成",resultColumn:va}),sa.value=!0,ca.value="",m.status}catch(i){}},ha=async()=>{try{const a=aa.value,t=(()=>{const a=aa.value,t=ta.value,e={name:t.name,id:t.id};if(pa.includes(a))return{table:"domain",list:"True",search:e.id};const n={python:{data:JSON.stringify({name:e.name})},phpasync:{sitename:e.name},proxy:{site_name:e.name,id:e.id},default:{data:JSON.stringify({project_name:e.name})}};return n[a]||n.default})();let e=pa.includes(a);const n=["proxy"].includes(a);let s=null;["phpasync","php"].includes(a)&&(s=await ia());const r=await ra(t,{isSpecial:e,isPort:n});return s&&(na.value=Number(s.data)||"未开启"),n?(na.value=Number(r.data.https_port)||"未开启",{data:r.data.domain_list,total:r.data.domain_list.length,other:{port:r.data.https_port}}):{data:r.data,total:r.data.length,other:{...s?{port:Number(s.data)}:{}}}}catch(a){return{data:[],total:0,other:{}}}},ga=async(a=ca.value)=>{let t=a.trim().replace(" ","").split("\n");const e=t.findIndex((a=>a.split(":")[0].length<3));for(var n=0;n<t.length;n++){var s=t[n];let a=s.includes(":");if(a&&!S(s))return x.error("第"+(n+1)+"行【"+s+"】域名格式错误"),!1;if(!a&&!N(s))return x.error("第"+(n+1)+"行【"+s+"】域名格式错误"),!1}return-1!==e?(x.error("第 ".concat(e+1," 个域名长度不符合要求（必须大于3个字符）")),!1):t},fa=async a=>{try{const t=await la({...a.value,siteName:ta.value.name});(null==t?void 0:t.status)&&(na.value=Number(a.value.port))}catch(t){}},ba=async a=>{try{await O({icon:"warning-filled",title:"删除【".concat(a.name,"】"),content:"删除".concat(a.name,"后，将无法使用该域名访问网站，是否继续操作？")});const t=(a=>{const t=aa.value,{id:e,name:n}=ta.value,s={php:{webname:n,id:a.pid,domain:a.name,port:a.port},phpasync:{sitename:n,domain:JSON.stringify([a.name])},python:{data:JSON.stringify({name:n,domain:a.name})},proxy:{id:e,site_name:n,domain:a.name,port:a.port},java:{data:JSON.stringify({project_name:n,domains:[a.id]})},html:{data:JSON.stringify({project_name:n,domain:"".concat(a.name,":").concat(a.port)})},default:{data:JSON.stringify({project_name:n,domain:a.name})}};return s[t]||s.default})(a),e=await ua(t);return x.request(e),sa.value=!0,e}catch(t){}},wa=async a=>{try{await O({icon:"warning-filled",title:"批量删除",content:"同时删除选中的域名，是否继续？",type:"calc"});const t=aa.value;let e=[];if(["php","python","java","phpasync","proxy"].includes(t)){const t=(a=>{const{id:t,name:e}=ta.value,n=aa.value,s=a.map((a=>a.id)),r=a.map((a=>a.name)).join("\n"),i={php:{domains_id:s.join(","),id:t},java:{data:JSON.stringify({project_name:e,domains:s})},python:{name:e,domain_ids:JSON.stringify(s)},phpasync:{sitename:e,domain:JSON.stringify(s)},proxy:{id:t,site_name:e,domains:r}};return i[n]||i.default})(a),n=await ma(t);e=n.data}else await Promise.all(a.map((async a=>{const t={data:JSON.stringify({project_name:ta.value.name,domain:a.name})};try{const n=await ua(t);e.push({name:(null==a?void 0:a.name)||(null==a?void 0:a.domain),msg:n.msg,status:n.status})}catch(n){T(n)}})));return await H({resultData:e,autoTitle:"删除域名完成",resultColumn:va}),sa.value=!0,{status:!0,msg:"删除域名成功"}}catch(t){return{status:!1,msg:"删除域名失败"}}},_a=async()=>{try{const a=aa.value;return["php","proxy","html","phpasync"].includes(a)?$.value=!0:await(async()=>{try{let{project_type:a,name:t}=ta.value,e="python"===a?{name:t}:{project_name:t};await ea(e)}catch(a){return{status:!1,msg:"获取域名信息失败"}}})(),await ha()}catch(a){return{data:[],total:0,other:{}}}},xa={class:""},ja={class:"flex items-end mb-[12px]"},Sa={key:0},Na={key:0,class:"mt-[.8rem] leading-8 text-[1.2rem] list-disc ml-2rem"},Oa={key:0,class:"text-danger"},Ta=r({__name:"index",setup(t,{expose:e}){const{isBindExtranet:n,siteType:r}=V(),{isRefreshDomain:w,port:_}=Z(),{sslInfo:x}=W(),j=B([{label:"删除",value:"delete",event:async(a,t,e,n)=>{wa(e.value)}}]),{BtTable:S,BtBatch:N,config:O,refresh:T}=D({request:_a,columns:[{type:"selection",width:40},{label:"域名",prop:"name",width:400,render:a=>s("div",{class:""},[s("a",{class:"inline-block bt-link !w-[38rem] truncate",href:"http".concat(x.value.https?"s":"","://").concat(a.name).concat(x.value.https?"":":".concat(a.port)),title:a.name,target:"_blank"},[a.name]),"php"===r.value&&(null==a?void 0:a.cn_name)&&a.name!==(null==a?void 0:a.cn_name)?s("span",null,[m("（"),a.cn_name,m("）")]):""])},{label:"端口",prop:"port"},{label:"操作",align:"right",render:a=>1===O.data.length&&n.value?s("span",null,[m("不可操作")]):s("span",{class:"bt-link",onClick:()=>{ba(a)}},[m("删除")])}],extension:[j,E(w)]}),A=()=>{const{BtForm:a,submit:t}=P({data:{port:O.other.port},options:a=>g((()=>[M("HTTPS端口",(()=>s(q,{modelValue:a.value.port,"onUpdate:modelValue":t=>a.value.port=t},null)),"port",{attrs:{min:1,max:65535},rules:[J({message:"请输入端口号",trigger:"blur"}),k()]})])),submit:fa});C({title:"更换端口",area:42,showFooter:!0,component:()=>s(a,{class:"p-2rem"},null),onConfirm:t})};return e({init:T}),(t,e)=>{const n=I,g=f,w=b,x=a;return i(),l("div",xa,[o("div",ja,[s(g,{ref:"popover",placement:"top-start",width:"34rem","popper-class":"green-tips-popover !p-0 !border-none",visible:d(da),"onUpdate:visible":e[2]||(e[2]=a=>c(da)?da.value=a:null),"trigger-keys":[],trigger:"focus"},{default:u((()=>e[3]||(e[3]=[o("div",{class:"!p-[12px] bg-[#20a53a] text-white leading-[2.4rem]"},[m(" 如需绑定外网，请换行填写，每行一个域名，默认为80端口 "),o("br"),m(" IP地址格式：192.168.1.199 "),o("br"),m(" 泛解析添加方法 *.domain.com "),o("br"),m(" 如另加端口格式为 www.domain.com:88 ")],-1)]))),reference:u((()=>[s(n,{modelValue:d(ca),"onUpdate:modelValue":e[0]||(e[0]=a=>c(ca)?ca.value=a:null),type:"textarea",resize:"none",rows:4,width:"42rem",onFocus:e[1]||(e[1]=a=>da.value=!0),placeholder:"如需绑定外网，请换行填写，每行一个域名，默认为80端口\nIP地址格式：192.168.1.199\n泛解析添加方法 *.domain.com\n如另加端口格式为 www.domain.com:88",class:"domain-textarea"},null,8,["modelValue"])])),_:1},8,["visible"]),s(w,{type:"primary",class:"absolute",style:{right:"4rem",top:"5rem"},onClick:d(ya)},{default:u((()=>e[4]||(e[4]=[m("添加")]))),_:1},8,["onClick"])]),s(x,null,{"header-right":u((()=>[["php","proxy","phpasync"].includes(d(r))?(i(),l("div",Sa,[m(" HTTPS端口："+p(d(_))+" ",1),v(o("span",{class:"bt-link cursor-pointer",onClick:A},"更换",512),[[y,"number"==typeof d(_)]])])):h("",!0)])),content:u((()=>[s(d(S),{"max-height":440})])),"footer-left":u((()=>[s(d(N))])),_:1}),["php","java"].includes(d(r))?h("",!0):(i(),l("ul",Na,[e[5]||(e[5]=o("li",null,"如果您的是HTTP项目，且需要映射到外网，请至少绑定一个域名",-1)),e[6]||(e[6]=o("li",null,"建议所有域名都使用默认的80端口",-1)),"phpasync"===d(r)?(i(),l("li",Oa,"只有部署前端或反向代理域名后此域名才可用")):h("",!0)]))])}}});export{Ta as _};
