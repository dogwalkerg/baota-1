import{B as a}from"./index185.js?v=1734676359";import{u as e,M as l,b6 as t,o as s,G as i,af as n,H as o,l as d,ah as r,v as u,c,j as m,h as p,e as f}from"./utils-lib.js?v=1734676359";import{r as h,h as g,s as _,n as y,e as v,c as w,o as V,B as b,C as x,p as C,k as P,l as k,q as I,x as U,y as q,I as T,aX as j,M as F,J as L,z as E,A,ah as N,aj as D,aY as S,a7 as B,a4 as R,ag as z}from"./base-lib.js?v=1734676359";import{_ as G}from"./index88.js?v=1734676359";import{f as H,h as M,p as O,i as J}from"./validator.js?v=1734676359";import{c as W}from"./useController3.js?v=1734676359";import{setHasPwd as X,closeHasPwd as Y,setPath as K,setSiteRunPath as Q,setSitesFtp as Z,delSiteRsync as $,removeSendTask as aa,delGitTask as ea,getGitTask as la,addGitTask as ta,runSiteTask as sa,getFileBody as ia,setDirUserINI as na,writeAccessLog as oa,getCatalogueKey as da,getDirUserINI as ra,getSitesFtp as ua,getBtSyncStatus as ca}from"./site.js?v=1734676359";import{u as ma}from"./useStore7.js?v=1734676359";import"./ace.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";import"./column.js?v=1734676359";const{payment:pa}=e(),{siteInfo:fa}=ma(),{authType:ha}=pa.value,ga=h(!1),_a=h(),ya=h(),va=g({path:"",runPath:"",dirs:[],userini:!1,sync_git:!1,logs:!1,pass:!1}),wa=h(!1),Va=g({ftp_status:!1,ftp_name:"",ftp_pwd:""}),ba=h(!1),xa=h(""),Ca=h([]),Pa=h(!1),ka=g({git_addr:"",branch:"",cycle:1}),Ia=h(""),Ua=h(!1),qa=h(!1),Ta={git_addr:[{required:!0,message:"请输入git地址",trigger:"blur"}]};h({mode:"ace/mode/nginx",theme:"ace/theme/monokai",wrap:!0,showInvisibles:!1,showFoldWidgets:!1,useSoftTabs:!0,tabSize:2,showPrintMargin:!1,readOnly:!0,fontSize:"12px"});const ja=g({status:!1,username:"",password:"",rePass:""}),Fa={username:[{required:!0,message:"账号不能为空",trigger:["blur"]}],password:[{required:!0,message:"密码不能为空",trigger:["blur"]}],rePass:[{required:!0,message:"重复密码不能为空",trigger:["blur"]},{validator:(a,e,l)=>{e!==ja.password?l(new Error("两次输入密码不一致")):l()},trigger:["blur","change"]}]},La=async()=>{_a.value.validate((async a=>{if(a){let a=l.load("正在设置,请稍后...");try{const a=await X({id:fa.value.id,username:ja.username,password:ja.password});l.request(a)}catch(e){}finally{a.close()}}}))},Ea=async a=>{let e;try{if(!a){e=l.load("正在关闭密码访问,请稍后...");const a=await Y({id:fa.value.id});e.close(),l.request(a)}}catch(t){}finally{null==e||e.close()}},Aa=()=>{H({type:"dir",path:va.path,change:a=>{va.path=a}})},Na=async()=>{try{const a=await ra({path:va.path,id:fa.value.id});va.dirs=a.data.runPath.dirs,va.runPath=a.data.runPath.runPath,va.sync_git=a.data.sync_git,va.logs=a.data.logs,va.userini=a.data.userini,ja.status=a.data.pass}catch(a){}},Da=async()=>{let a=l.load("正在保存中...");try{const a=await K({path:va.path,id:fa.value.id});l.request(a),a.status&&(fa.value.path=va.path),Na()}catch(e){}finally{a.close()}},Sa=async()=>{let a=l.load("正在设置,请稍后...");try{const a=await Q({runPath:va.runPath,id:fa.value.id});l.request(a)}catch(e){}finally{a.close()}},Ba=async()=>{var a,e,l;try{const t=await ua({site_id:fa.value.id});(null==(a=t.data.info)?void 0:a.id)?(Va.ftp_status=!0,Va.ftp_id=null==(e=t.data.info)?void 0:e.id,Va.ftp_name=null==(l=t.data.info)?void 0:l.name,Va.ftp_pwd=t.data.info.password):(Va.ftp_status=!1,Va.ftp_name="",Va.ftp_pwd="",Va.ftp_id="")}catch(t){}},Ra=async(a,e)=>{if(e){let a=l.load("正在处理中,请稍后...");try{if(!Va.ftp_id)return void Ra(!0,!1);let a={site_id:fa.value.id,...Va,siteName:fa.value.name};delete a.ftp_status;const e=await Z(a);l.request(e),wa.value=!1,Ba()}catch(n){}finally{a.close()}}else{a&&(Va.ftp_name=Va.ftp_name||t(12),Va.ftp_pwd=Va.ftp_pwd||t(12));let e={site_id:fa.value.id,...Va,siteName:fa.value.name};e.ftp_id||delete e.ftp_id,Va.ftp_status=!a,await s({title:"FTP状态",content:a?"创建FTP将会同步到FTP界面，是否继续操作？":"关闭FTP后，将会删除当前网站的FTP账号，是否继续操作？",icon:"warning-filled"});(await i({loading:"正在处理中,请稍后...",request:Z(e),message:!0})).status&&Ba()}},za=async()=>{var a,e,l,t,s,i;try{const n=await ca({path:va.path});ba.value=n.data.have_sync,ba.value&&(Ca.value=Array.isArray(null==(a=n.data)?void 0:a.data)?null==(e=n.data)?void 0:e.data:[],(null==(t=null==(l=n.data)?void 0:l.data)?void 0:t.name)&&(xa.value=null==(i=null==(s=n.data)?void 0:s.data)?void 0:i.name))}catch(n){}},Ga=async a=>{try{if(ba.value=a,a){const{data:a}=await n({sName:"rsync"});if(a.setup&&a.endtime>=0)if(parseFloat(a.version)>=parseFloat("3.9.3")){const{default:a}=await o((()=>import("./store2.js?v=1734676359").then((a=>a.aq))),__vite__mapDeps([]),import.meta.url),e=a(),{compData:l,isSuccess:t}=_(e);l.value={row:{path:fa.value.path,type:"site",refreshEvent:za}},d({isAsync:!0,title:"【".concat(fa.value.name,"】设置数据同步"),area:56,component:()=>o((()=>import("./index198.js?v=1734676359")),__vite__mapDeps([]),import.meta.url),onCancel:()=>{y((()=>{t.value||(ba.value=!1)}))}})}else await s({title:"更新提示",content:"当前版本过低，无法使用此功能，是否继续更新？",icon:"warning-filled"}),await Ha(a);else a.endtime>=0?(await s({title:"安装提示",content:"检测到【".concat(a.title,"】未安装，是否立即安装开启使用？"),icon:"warning-filled"}),M({name:a.name,type:"i",pluginInfo:a})):O({sourceId:120}),y((()=>{ba.value=!1}))}else{if(await s({title:"删除同步任务",content:"即将删除该同步任务，是否继续操作？",icon:"warning-filled"}),Ca.value.length){const a=l.load("正在删除同步任务，请稍后..."),e=Ca.value.map((async a=>{if("modules"===a.type){return{...(await $({mName:a.data.name})).data,title:"接收任务",name:a.data.name}}return{...(await aa({send_id:a.data.id})).data,title:"发送任务",name:a.data.name}})),t=await Promise.all(e);a.close(),t.length>1?W({title:"删除同步任务",autoTitle:"删除同步任务完成",resultData:t,resultColumn:[{label:"任务名称",prop:"name"},{label:"任务类型",prop:"title"},{label:"操作结果",prop:"msg",align:"rigth",render:a=>v("span",{class:a.status?"text-primary":"text-danger"},[a.msg])}]}):l.request(t[0])}else await i({loading:"正在删除同步任务，请稍后...",request:$({mName:xa.value}),message:!0});za()}}catch(e){ba.value=!a}},Ha=async a=>{},Ma=async()=>{try{const{data:a}=await n({sName:"rsync"});await J({name:"rsync",softData:a})}catch(a){}},Oa=async a=>{if("ltd"!==ha)return O({sourceId:310,disablePro:!0});if(a)va.sync_git=!1,await Wa();else{va.sync_git=!0,await s({title:"关闭git同步",content:"关闭后将不在同步git文件到网站目录，是否继续操作？",icon:"warning-filled"});const a=await i({loading:"正在关闭，请稍后...",request:ea({site_id:fa.value.id}),message:!0});a.status&&(va.sync_git=!a.status)}},Ja=async()=>{if("ltd"!==ha)return O({sourceId:310,disablePro:!0});await Wa(),Pa.value=!0},Wa=async()=>{var a;try{const e=await la({site_id:fa.value.id});(null==(a=e.data)?void 0:a.git_addr)?(ka.git_addr=e.data.git_addr,ka.branch=e.data.branch,ka.cycle=e.data.cycle):(ka.git_addr="",ka.branch="",ka.cycle=1,Pa.value=!0)}catch(e){}},Xa=async()=>{await ya.value.validate(),await s({title:"git同步覆盖提示",content:"从git同步文件到网站目录将覆盖网站目录的文件，是否继续操作？",icon:"warning-filled"});(await i({loading:"正在设置，请稍后...",request:ta({site_id:fa.value.id,...ka}),message:!0})).status&&(Pa.value=!1,Na())},Ya=async()=>{if("ltd"!==ha)return O({sourceId:310,disablePro:!0});i({request:sa({site_id:fa.value.id}),message:!0})},Ka=async()=>{await Qa(),qa.value=!0},Qa=async()=>{Ua.value=!0;try{const a=await ia({path:"/www/wwwlogs/syncsite/"+fa.value.id+".log"});Ia.value=a.data.data||"暂无日志数据"}catch(a){r(a)}finally{Ua.value=!1}},Za=async()=>{(await i({loading:"正在设置放跨站，请稍后...",request:na({path:va.path}),message:!0})).status&&Na()},$a=async()=>{(await i({loading:"正在设置写访问日志，请稍后...",request:oa({id:fa.value.id}),message:!0})).status&&Na()},ae=async()=>{ga.value=!0;try{await(async()=>{try{const a=await da({table:"sites",key:"path",id:fa.value.id});va.path=a.data}catch(a){}})(),await Na(),await Ba(),await za()}catch(a){}finally{ga.value=!1}},ee={class:""},le={class:"formItem"},te={class:"formItem"},se={class:"formItem"},ie={class:"formItem"},ne={class:"formItem"},oe={class:"formItem"},de={class:"formItem"},re={class:"flex items-center"},ue={class:"p-[20px]"},ce={class:"p-[20px]"},me={class:"p-[20px]"},pe=f(w({__name:"cataluge-setting",setup:(e,{expose:l})=>(V(ae),l({init:ae}),(e,l)=>{const t=G,s=A,i=z,n=N,o=D,d=c,r=S,f=m,h=B,g=R,_=p,y=a,w=b("bt-loading");return x((P(),k("div",ee,[I("div",le,[l[25]||(l[25]=I("span",{class:"formLabel"},"网站目录",-1)),v(t,{class:"mr-[12px]",modelValue:C(va).path,"onUpdate:modelValue":l[0]||(l[0]=a=>C(va).path=a),icon:"el-folder-opened",onIconClick:C(Aa),width:"32rem"},null,8,["modelValue","onIconClick"]),v(s,{type:"primary",onClick:C(Da)},{default:U((()=>l[24]||(l[24]=[q("保存")]))),_:1},8,["onClick"])]),l[49]||(l[49]=I("span",{class:"formTips"},"当前网站的部署目录，可以选择其他目录",-1)),I("div",te,[l[27]||(l[27]=I("span",{class:"formLabel"},"运行目录",-1)),v(n,{class:"mr-[12px] !w-[32rem]",modelValue:C(va).runPath,"onUpdate:modelValue":l[1]||(l[1]=a=>C(va).runPath=a)},{default:U((()=>[(P(!0),k(T,null,j(C(va).dirs,(a=>(P(),L(i,{key:a,label:a,value:a},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),v(s,{type:"primary",onClick:C(Sa)},{default:U((()=>l[26]||(l[26]=[q("保存")]))),_:1},8,["onClick"])]),l[50]||(l[50]=I("span",{class:"formTips"},"部分程序需要指定二级目录作为运行目录，如ThinkPHP5,Laravel",-1)),I("div",se,[l[29]||(l[29]=I("span",{class:"formLabel"},"添加FTP",-1)),v(o,{class:"mr-[12px]",modelValue:C(Va).ftp_status,"onUpdate:modelValue":l[2]||(l[2]=a=>C(Va).ftp_status=a),onChange:C(Ra)},null,8,["modelValue","onChange"]),l[30]||(l[30]=I("span",{class:"text-[#999]"},"为当前目录添加一个FTP账号，以支持访问",-1)),v(d,{onClick:l[3]||(l[3]=a=>wa.value=!0)},{default:U((()=>l[28]||(l[28]=[q("点击配置>>")]))),_:1})]),I("div",ie,[l[32]||(l[32]=I("span",{class:"formLabel"},"文件同步",-1)),v(o,{class:"mr-[12px]",modelValue:C(ba),"onUpdate:modelValue":l[4]||(l[4]=a=>F(ba)?ba.value=a:null),onChange:C(Ga)},null,8,["modelValue","onChange"]),l[33]||(l[33]=I("i",{class:"svgtofont-icon-ltd text-[2rem] text-[#9B7E48] mr-4px"},null,-1)),l[34]||(l[34]=I("span",{class:"text-[#999]"},"可以同步网站文件至其他服务节点",-1)),v(d,{onClick:C(Ma)},{default:U((()=>l[31]||(l[31]=[q("点击配置>>")]))),_:1},8,["onClick"])]),I("div",ne,[l[38]||(l[38]=I("span",{class:"formLabel"},"git同步",-1)),v(o,{class:"mr-[12px]",modelValue:C(va).sync_git,"onUpdate:modelValue":l[5]||(l[5]=a=>C(va).sync_git=a),onChange:C(Oa)},null,8,["modelValue","onChange"]),l[39]||(l[39]=I("i",{class:"svgtofont-icon-ltd text-[2rem] text-[#9B7E48] mr-4px"},null,-1)),l[40]||(l[40]=I("span",{class:"text-[#999]"},"可以从git中下载文件到网站目录中",-1)),v(d,{onClick:C(Ja)},{default:U((()=>l[35]||(l[35]=[q("点击配置>>")]))),_:1},8,["onClick"]),v(r,{direction:"vertical"}),v(d,{onClick:C(Ka)},{default:U((()=>l[36]||(l[36]=[q("查看日志")]))),_:1},8,["onClick"]),v(r,{direction:"vertical"}),v(d,{onClick:C(Ya)},{default:U((()=>l[37]||(l[37]=[q("立即同步")]))),_:1},8,["onClick"])]),v(r),I("div",oe,[l[41]||(l[41]=I("span",{class:"formLabel"},"防跨站攻击",-1)),v(o,{class:"mr-[12px]",modelValue:C(va).userini,"onUpdate:modelValue":l[6]||(l[6]=a=>C(va).userini=a),onChange:C(Za)},null,8,["modelValue","onChange"]),l[42]||(l[42]=I("span",{class:"text-[#999]"},"防跨站攻击(open_basedir)，防止黑客通过其他网站目录进行入侵攻击",-1))]),I("div",de,[l[43]||(l[43]=I("span",{class:"formLabel"},"写访问日志",-1)),v(o,{class:"mr-[12px]",modelValue:C(va).logs,"onUpdate:modelValue":l[7]||(l[7]=a=>C(va).logs=a),onChange:C($a)},null,8,["modelValue","onChange"]),l[44]||(l[44]=I("span",{class:"text-[#999]"},"允许当前日志增加访问日志",-1))]),v(r),I("div",re,[l[45]||(l[45]=I("span",{class:"mr-[20px] w-[7rem] text-right"},"密码访问",-1)),v(o,{modelValue:C(ja).status,"onUpdate:modelValue":l[8]||(l[8]=a=>C(ja).status=a),onChange:C(Ea)},null,8,["modelValue","onChange"])]),C(ja).status?(P(),L(g,{key:0,model:C(ja),ref_key:"passVisitFormRef",ref:_a,rules:C(Fa),class:"mt-[20px]","label-width":"70px","label-position":"right"},{default:U((()=>[v(h,{label:"账号",prop:"username"},{default:U((()=>[v(f,{width:"20rem",modelValue:C(ja).username,"onUpdate:modelValue":l[9]||(l[9]=a=>C(ja).username=a),placeholder:"不修改请留空"},null,8,["modelValue"])])),_:1}),v(h,{label:"访问密码",prop:"password"},{default:U((()=>[v(f,{width:"20rem",modelValue:C(ja).password,"onUpdate:modelValue":l[10]||(l[10]=a=>C(ja).password=a),type:"password",placeholder:"不修改请留空"},null,8,["modelValue"])])),_:1}),v(h,{label:"重复密码",prop:"rePass"},{default:U((()=>[v(f,{width:"20rem",modelValue:C(ja).rePass,"onUpdate:modelValue":l[11]||(l[11]=a=>C(ja).rePass=a),type:"password",placeholder:"不修改请留空"},null,8,["modelValue"])])),_:1}),v(h,{label:" "},{default:U((()=>[v(s,{type:"primary",onClick:C(La)},{default:U((()=>l[46]||(l[46]=[q("保存")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"])):E("",!0),v(_,{title:"FTP配置",modelValue:C(wa),"onUpdate:modelValue":l[16]||(l[16]=a=>F(wa)?wa.value=a:null),area:42,showFooter:"",onConfirm:l[17]||(l[17]=a=>C(Ra)(!1,!0))},{default:U((()=>[I("div",ue,[v(g,{"label-position":"right",model:C(Va)},{default:U((()=>[v(h,{label:"用户名"},{default:U((()=>[v(f,{modelValue:C(Va).ftp_name,"onUpdate:modelValue":l[12]||(l[12]=a=>C(Va).ftp_name=a),placeholder:"请输入ftp用户名",style:{width:"100%"}},null,8,["modelValue"])])),_:1}),v(h,{label:"密码"},{default:U((()=>[v(t,{modelValue:C(Va).ftp_pwd,"onUpdate:modelValue":l[13]||(l[13]=a=>C(Va).ftp_pwd=a),icon:"el-refresh",onIconClick:l[14]||(l[14]=()=>C(Va).ftp_pwd=C(u)(16)),width:"32rem"},null,8,["modelValue"])])),_:1}),v(h,{label:"根目录"},{default:U((()=>[v(f,{modelValue:C(va).path,"onUpdate:modelValue":l[15]||(l[15]=a=>C(va).path=a),disabled:"",style:{width:"100%"}},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])])),_:1},8,["modelValue"]),v(_,{title:"配置GIT同步",modelValue:C(Pa),"onUpdate:modelValue":l[21]||(l[21]=a=>F(Pa)?Pa.value=a:null),area:42,showFooter:"",onConfirm:C(Xa)},{default:U((()=>[I("div",ce,[v(g,{"label-position":"right",ref_key:"gitFormRef",ref:ya,model:C(ka),rules:C(Ta)},{default:U((()=>[v(h,{label:"git地址",prop:"git_addr"},{default:U((()=>[v(f,{modelValue:C(ka).git_addr,"onUpdate:modelValue":l[18]||(l[18]=a=>C(ka).git_addr=a),placeholder:"请输入git地址",width:"24rem"},null,8,["modelValue"])])),_:1}),v(h,{label:"分支"},{default:U((()=>[v(f,{modelValue:C(ka).branch,"onUpdate:modelValue":l[19]||(l[19]=a=>C(ka).branch=a),placeholder:"请输入git分支,为空默认主分支",width:"24rem"},null,8,["modelValue"])])),_:1}),v(h,{label:"同步周期"},{default:U((()=>[v(f,{modelValue:C(ka).cycle,"onUpdate:modelValue":l[20]||(l[20]=a=>C(ka).cycle=a),"text-type":"天",type:"number",min:1,width:"24rem"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])])),_:1},8,["modelValue","onConfirm"]),v(_,{title:"GIT日志",modelValue:C(qa),"onUpdate:modelValue":l[23]||(l[23]=a=>F(qa)?qa.value=a:null),area:70},{default:U((()=>[I("div",me,[v(s,{type:"primary",onClick:C(Qa)},{default:U((()=>l[47]||(l[47]=[q("刷新")]))),_:1},8,["onClick"]),x(v(y,{class:"!h-[54rem] !w-full my-[12px]",modelValue:C(Ia),"onUpdate:modelValue":l[22]||(l[22]=a=>F(Ia)?Ia.value=a:null),config:e.config},null,8,["modelValue","config"]),[[w,C(Ua)]]),l[48]||(l[48]=I("span",{class:"text-[#999] mt-[8px]"},"提示：支持Ctrl + F，快捷搜索日志内容",-1))])])),_:1},8,["modelValue"])])),[[w,C(ga)]])})}),[["__scopeId","data-v-75103360"]]);export{pe as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
