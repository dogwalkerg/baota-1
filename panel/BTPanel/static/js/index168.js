import{u as a,b6 as e,o as t,l,H as s,G as o,M as n,ah as i,bb as c,S as r,k as p,V as m,h as d,j as u,O as f,J as w,a6 as b,e as v,aa as _}from"./utils-lib.js?v=1734676359";import{c as k,ax as h,r as y,h as g,o as x,B as D,k as V,l as q,e as j,x as C,p as B,J as P,y as O,q as U,I as F,C as A,M as E,D as I,ap as z,ao as H,an as R,A as T,a7 as J,a4 as L,z as M,ay as S}from"./base-lib.js?v=1734676359";import{g as N,x as G,z as $}from"./useMethod3.js?v=1734676359";import{_ as K}from"./index.vue_vue_type_script_setup_true_lang9.js?v=1734676359";import{_ as Q}from"./index90.js?v=1734676359";import{_ as W}from"./index88.js?v=1734676359";import{_ as X}from"./index97.js?v=1734676359";import{backDatabase as Y,backModuleDatabase as Z,delBackup as aa,backupDownload as ea,checkDatabasePass as ta,restoreModuleBack as la,restoreBack as sa}from"./database.js?v=1734676359";import{c as oa,a as na,i as ia,g as ca,u as ra}from"./column.js?v=1734676359";import{f as pa}from"./validator.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index100.js?v=1734676359";import"./index101.js?v=1734676359";import"./index91.js?v=1734676359";const ma={class:"p-20px"},da={class:"p-20px"},ua={class:"mt-4px leading-8 text-[1.2rem] list-disc ml-[20px]"},fa=v(k({__name:"route-back",props:{compData:{default:()=>({id:0,name:""})}},setup(v){const _=v,{refs:{tabActive:k},refreshTableList:M}=N(),{panel:S}=a(),K=h("popupClose"),fa=y(),wa=y(),ba=y(),va=y([]),_a=y(!1),ka=y(!1),{id:ha,name:ya}=_.compData,ga=g({search:ha,type:1,table:"backup",total:0,p:1,limit:10}),xa=y(!1),Da=g({backupPath:""}),Va=y(),qa=y(!1),ja=g({pwd:""}),Ca=[{label:"删除",value:"delete",event:async(a,e,t,l)=>{await a({title:"批量删除备份文件",content:"批量删除已选备份文件，是否继续操作？",column:[{prop:"filename",label:"文件名"},oa()],onConfirm:async()=>(await e(Ea),Ja(),M(),!1)})}}],Ba=()=>{pa({type:"dir",path:Da.backupPath,change:a=>{Da.backupPath=a}})},Pa=async()=>{await t({title:"提示",content:"修改默认备份目录，会导致网站和站点默认备份会备份到该目录下，是否继续操作？"}),S.value.backupPath=Da.backupPath},Oa=({filename:a})=>(w(a)||b(a))&&-1!==a.indexOf("|"),Ua=()=>{l({title:"表备份",area:60,component:()=>s((()=>import("./table-back.js?v=1734676359")),__vite__mapDeps([]),import.meta.url),compData:{..._.compData,refreshFn:Ja},showFooter:!0})},Fa=async()=>{const{router:a}=await s((()=>import("./utils-lib.js?v=1734676359").then((a=>a.dH))),__vite__mapDeps([]),import.meta.url);K(),a.push({name:"crontab"})},Aa=async a=>{let e=null;"mysql"===k.value&&(e=G({type:"backup",config:{path:"/tmp/import_sql.log",id:_.compData.id,name:_.compData.name},refreshFn:Ja}));let t={id:_.compData.id};a&&(t.password=ja.pwd),await o({loading:"mysql"===k.value?void 0:"正在备份数据库，请稍后...",request:"mysql"===k.value?Y(t):Z({data:JSON.stringify(t)},k.value),message:!0,success:async a=>{const t=await e;null==t||t.unmount(),a.status&&(Ja(),M())}})},Ea=async(a,e=!1)=>{try{e&&await t({title:"删除备份",content:'<p>删除备份后，<span class="text-danger">备份数据将无法恢复</span>，是否继续？</p>',icon:"warning-filled",isHtml:!0});const l=await aa({id:a.id});return e&&(n.request(l),Ja()),l}catch(l){i(l,"delBackEvent")}finally{ka.value&&ka.value.close()}},Ia=async(a,e=!1)=>{wa.value=a,await t({title:"恢复数据库",content:"恢复备份文件将会覆盖当前数据库[".concat(_.compData.name,"]，是否继续？"),type:"calc",icon:"warning-filled"});let l={file:a.localexist?a.local:a.filename,name:_.compData.name};if(e&&(l.disk_check=!0),"mysql"===k.value){const{data:e}=await ta({file:a.localexist?a.local:a.filename});if(e)return fa.value=!0,void(qa.value=!0);za(l,a)}else l.file=a.local,o({loading:"正在恢复数据库,请稍后...",request:la({data:JSON.stringify(l)},k.value),message:!0})},za=async(a,e)=>{const t=G({type:"import",config:{path:"/tmp/import_sql.log",id:e.id,name:_.compData.name}});await o({request:sa(a),message:!0,success:async a=>{var t;if(-1!==(null==(t=a.msg)?void 0:t.indexOf("警告")))return await Ha(a.msg,"恢复"),void Ia(e,!0)}});const l=await t;null==l||l.unmount()},Ha=(a,e)=>t({title:"提示",isHtml:!0,width:"50rem",confirmText:"继续".concat(e),content:'<div class="flex"><i class="svgtofont-el-warning-filled text-[4rem] text-warning mr-4"></i><div><div>'.concat(a,"</div><div>\n\t\t\t<p>如继续").concat(e,"可能会有以下影响：</p>\n\t\t\t<p>1.").concat(e,"数据不完整</p>\n\t\t\t<p>2.系统运行缓慢</p>\n\t\t\t<p>3.面板无法正常工作</p>\n\t\t\t<p>4.mysql无法正常运行</p></div></div></div>")}),Ra=a=>{switch(a){case"databaseBack":Aa(!1);break;case"backPath":break;case"databasePwdBack":qa.value=!0;break;case"tableBack":Ua()}},Ta=async()=>{if(await Va.value.validate(),fa.value){const a={file:wa.value.localexist?wa.value.local:wa.value.filename,name:_.compData.name,password:ja.pwd};za(a,wa.value),qa.value=!1,fa.value=!1}else Aa(!0),qa.value=!1},Ja=async()=>{o({request:c({...ga}),loading:_a,data:{data:[Array,va],page:r(ga)}})},La=[na(),{label:"文件名称",prop:"name",width:220,showOverflowTooltip:!0},{label:"存储对象",render:a=>{let e=!1,t="";return Oa(a)&&(e=!0,t=a.filename.match(/\|(.+)\|/,"$1")),j("span",null,[e?$[t[1]]:"本地"])}},ia({prop:"size",width:100}),{width:160,prop:"addtime",label:"备份时间"},ca({table:"backup"}),ra([{onClick:a=>Ia(a),title:"恢复"},{onClick:a=>(async a=>{if("mysql"!==k.value||a.localexist)window.open("/download?filename="+a.local,"_blank");else if(Oa(a)){const e=await o({loading:"正在下载数据库,请稍后...",request:ea({filename:a.filename,cron_id:a.cron_id})});window.open(e.path,"_blank")}else n.error("备份文件不存在")})(a),title:"下载"},{onClick:a=>Ea(a,!0),title:"删除"}])];return x(Ja),(a,t)=>{const l=z,s=H,o=R,n=T,i=p,c=m,r=X,w=W,b=J,v=L,_=d,h=u,y=Q,g=f,x=D("bt-loading");return V(),q("div",null,[j(y,null,{"header-left":C((()=>["mysql"==B(k)?(V(),P(o,{key:0,"split-button":"",class:"active-route",onCommand:Ra,onClick:t[0]||(t[0]=a=>Ra("databaseBack"))},{dropdown:C((()=>[j(s,null,{default:C((()=>[j(l,{command:"databaseBack"},{default:C((()=>t[12]||(t[12]=[O(" 备份数据库 ")]))),_:1}),j(l,{command:"databasePwdBack"},{default:C((()=>t[13]||(t[13]=[O(" 加密备份数据库 ")]))),_:1}),j(l,{command:"tableBack"},{default:C((()=>t[14]||(t[14]=[O("表备份")]))),_:1})])),_:1})])),default:C((()=>[t[15]||(t[15]=U("span",{class:"text-white"},"备份数据库",-1))])),_:1})):(V(),q(F,{key:1},[j(n,{type:"primary",onClick:t[1]||(t[1]=a=>Aa(!1))},{default:C((()=>t[16]||(t[16]=[O(" 备份数据库 ")]))),_:1}),j(n,{type:"default",onClick:t[2]||(t[2]=a=>Ua())},{default:C((()=>t[17]||(t[17]=[O(" 表备份 ")]))),_:1})],64))])),"header-right":C((()=>t[18]||(t[18]=[]))),content:C((()=>[A(j(i,{ref_key:"routeBackupRef",ref:ba,data:B(va),description:"暂无数据","max-height":460,column:B(La)},null,8,["data","column"]),[[x,B(_a)],[x,"正在加载中，请稍后...","title"]])])),"footer-left":C((()=>[j(c,{options:Ca,"table-ref":B(ba)},null,8,["table-ref"])])),"footer-right":C((()=>[j(r,{total:B(ga).total,page:B(ga).p,"onUpdate:page":t[3]||(t[3]=a=>B(ga).p=a),row:B(ga).limit,"onUpdate:row":t[4]||(t[4]=a=>B(ga).limit=a),onChange:Ja},null,8,["total","page","row"])])),popup:C((()=>[j(_,{title:"更换默认备份目录",modelValue:B(xa),"onUpdate:modelValue":t[6]||(t[6]=a=>E(xa)?xa.value=a:null),area:42,onConfirm:Pa,showFooter:""},{default:C((()=>[U("div",ma,[j(v,{ref:"ruleFormData",class:"mr-[16px] w-[80%]",model:B(Da),rule:{backupPath:[{required:!0,message:"请输入默认备份目录",trigger:"blur"}]}},{default:C((()=>[j(b,{label:"默认备份目录",prop:"backupPath"},{default:C((()=>[j(w,{icon:"icon-file_mode",modelValue:B(Da).backupPath,"onUpdate:modelValue":t[5]||(t[5]=a=>B(Da).backupPath=a),onIconClick:Ba,width:"26rem"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])])),_:1},8,["modelValue"]),j(_,{title:B(fa)?"数据库加密密码":"加密备份数据库",modelValue:B(qa),"onUpdate:modelValue":t[10]||(t[10]=a=>E(qa)?qa.value=a:null),area:42,onConfirm:Ta,showFooter:"",onCancel:t[11]||(t[11]=()=>B(ja).pwd="")},{default:C((()=>[U("div",da,[j(v,{ref_key:"pwdBackFormRef",ref:Va,class:"mr-[16px] w-[80%]",model:B(ja),rules:{pwd:[{required:!0,message:"请输入压缩密码",trigger:"blur"}]}},{default:C((()=>[j(b,{label:"压缩密码",prop:"pwd"},{default:C((()=>[B(fa)?(V(),P(h,{key:1,modelValue:B(ja).pwd,"onUpdate:modelValue":t[9]||(t[9]=a=>B(ja).pwd=a),width:"26rem"},null,8,["modelValue"])):(V(),P(w,{key:0,modelValue:B(ja).pwd,"onUpdate:modelValue":t[7]||(t[7]=a=>B(ja).pwd=a),icon:"el-refresh",width:"26rem",onIconClick:t[8]||(t[8]=()=>B(ja).pwd=B(e)(16)),"is-active":!0},null,8,["modelValue"]))])),_:1})])),_:1},8,["model"]),A(U("ul",ua,t[19]||(t[19]=[U("li",{class:"text-warning"},"设置密码后请注意保存密码，以防忘记密码导致无法恢复备份数据",-1)]),512),[[I,B(fa)]])])])),_:1},8,["title","modelValue"])])),_:1}),j(g,{class:"!pl-2rem mt-1rem"},{default:C((()=>[U("li",null,[t[20]||(t[20]=O(" 定时备份请前往【 ")),U("span",{title:"点击前往【计划任务】",class:"bt-link",onClick:Fa}," 计划任务 "),t[21]||(t[21]=O(" 】增加【备份数据库】 "))])])),_:1})])}}}),[["__scopeId","data-v-c8e7ee8d"]]),wa={class:"p-[20px] h-full"},ba=k({__name:"index",props:{compData:{default:()=>({row:{}})}},emits:["close"],setup(a,{emit:e}){const{refs:{tabActive:t}}=N(),l=y("routeBackup");return x((()=>{})),(a,e)=>{const s=S,o=_;return V(),q("div",wa,[j(o,{type:"card",modelValue:B(l),"onUpdate:modelValue":e[0]||(e[0]=a=>E(l)?l.value=a:null),class:"bt-tabs bt-tabs-card"},{default:C((()=>[j(s,{name:"routeBackup",label:"常规备份",lazy:!0},{default:C((()=>[j(fa,{compData:a.compData.row},null,8,["compData"])])),_:1}),"mysql"==B(t)?(V(),P(s,{key:0,name:"increment",class:"mt-4",lazy:!0},{label:C((()=>e[1]||(e[1]=[U("span",{class:"flex items-center"},[U("i",{class:"mr-[4px] svgtofont-icon-ltd text-[1.8rem] text-[#9B7E48]"}),U("span",null,"增量备份")],-1)]))),default:C((()=>[j(K,{compData:a.compData.row,isRowBackup:!0},null,8,["compData"])])),_:1})):M("",!0)])),_:1},8,["modelValue"])])}}});export{ba as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
