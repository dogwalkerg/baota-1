import{u as a,t as e,l as t,H as l,M as n,G as i,o as s,x as o,S as r,k as d,h as c}from"./utils-lib.js?v=1734676359";import{_ as u}from"./index100.js?v=1734676359";import{_ as m}from"./index90.js?v=1734676359";import{c as p,i as _,r as b,h as f,o as g,B as w,k as y,l as h,p as x,e as v,x as k,y as C,z as V,q as j,I as q,aX as D,J as A,C as B,M as R,v as U,A as S,ag as T,ah as z,bR as E}from"./base-lib.js?v=1734676359";import{_ as I}from"./index101.js?v=1734676359";import{_ as M}from"./index97.js?v=1734676359";import{g as O}from"./useMethod3.js?v=1734676359";import{u as L}from"./column.js?v=1734676359";import{startIncrementTask as P,getIncrementLogs as F,clearIncrementLog as G,delIncrementData as H,restoreRecord as J,getIncrementRecord as N,outRecord as X,getIncrementBackData as K,getDatabaseOptions as Q}from"./database.js?v=1734676359";const W={key:0},Y={key:0,class:"ml-4px svgtofont-el-loading animate-spin"},Z={class:"flex items-center"},$={class:"p-20px"},aa={class:"mb-10px"},ea={class:"p-20px"},ta={class:"items-center justify-center !w-[40rem] text-[#666] inline-flex flex-col"},la=p({__name:"index",props:{compData:{default:()=>[]},isRowBackup:{type:Boolean,default:!1}},setup(p,{expose:la}){const{payment:na}=a();_((()=>na.value.authType));const{refreshTableList:ia}=O(),sa=p,oa=b(),ra=b(!1),da=b(!1),ca=b("暂无数据"),ua=b(!1),ma=b({name:"",size:"",path:""}),pa=b([]),_a=b(0),ba=b(!1),fa=b([]),ga=f({p:1,limit:10,db_name:"all"}),wa=b(!1),ya=b([]),ha={title:"企业增量备份",ps:"企业增量备份只定时备份发生变化新增、修改、删除文件和数据，不会每次都备份所有数据",source:54,desc:[],tabImgs:[{title:"概览",imgSrc:"https://www.bt.cn/Public/new/plugin/introduce/database/database_enterprise_backup.png"}]},xa=a=>{t({title:"添加备份任务",area:64,component:()=>l((()=>import("./add-increment.js?v=1734676359")),__vite__mapDeps([]),import.meta.url),compData:{rowData:a,selectOptions:ya.value,rowDatabaseName:!!sa.isRowBackup&&sa.compData.name,refreshEvent:qa},showFooter:!0})},va=async(a,e=!1)=>{if(0===a.cron_id||0===a.cron_id.length)return n.error("备份计划任务丢失，无法查看日志");oa.value=a,await i({request:F({id:a.cron_id}),data:{msg:[String,ca]}}),da.value=!0,e&&n.success("刷新成功")},ka=async()=>{await s({title:"提示",content:"确定清空日志吗？",icon:"warning-filled"}),await i({request:G({id:oa.value.cron_id}),loading:"正在清空日志，请稍后...",message:!0}),va(oa.value)},Ca=async()=>{window.open("/download?filename="+ma.value.path)},Va=[{prop:"db_name",label:"数据库名"},{prop:"tb_name",label:"表名"},{prop:"full_size",label:"备份大小"},{prop:"last_backup_time",label:"备份时间",render:a=>a.last_backup_time||"--"},L([{onClick:async a=>{if(0===a.cron_id||0===a.cron_id.length)return n.error("备份计划任务丢失，无法执行");await i({request:P({id:a.cron_id}),loading:"正在执行任务，请稍后...",message:!0}),qa(),ia()},title:"执行"},{onClick:a=>{if(0===a.cron_id||0===a.cron_id.length)return n.error("备份计划任务丢失，无法编辑");xa(a)},title:"编辑"},{onClick:a=>va(a,!1),title:"日志"},{onClick:async a=>{await i({request:N({cron_id:a.cron_id}),data:{data:[Array,fa]}}),ba.value=!0},title:"记录"},{onClick:async a=>{await s({title:"删除备份任务"+a.name,content:"删除备份任务后，备份数据将永久消失，是否继续操作？",input:{content:"删除备份任务"},type:"input",icon:"warning-filled"}),await i({request:H({id:a.cron_id}),loading:"正在删除任务，请稍后...",message:!0}),qa()},title:"删除"}])],ja=[{label:"备份名称",prop:"name",width:220},{label:"备份大小",render:a=>e(a.size)},{label:"类型",prop:"type",render:a=>1===a.type?"全量":"增量"},{label:"时间点",prop:"addtime",width:180},L([{onClick:async a=>{await s({title:"恢复数据",content:"恢复后会覆盖当前数据库数据，此操作不可逆，是否继续操作？",icon:"warning-filled",type:"input",input:{content:"我已知晓"}}),await i({loading:"正在恢复数据，请稍后...",request:J({cron_id:a.cron_id,node_time:a.addtime}),data:{data:[Array,fa]},message:!0})},title:"恢复"},{onClick:async a=>{await i({request:X({cron_id:a.cron_id,node_time:a.addtime}),data:{data:[Object,ma]}}),ua.value=!0},title:"导出"}])],qa=async()=>{await i({request:K({...ga,db_name:"all"==ga.db_name?"":ga.db_name}),loading:ra,data:{data:[Array,pa],page:r(_a)}})},Da=async()=>{sa.isRowBackup&&(ga.db_name=sa.compData.name),await i({loading:wa,request:Q(),data:{data:[Array,ya]}}),qa()};return g(Da),la({init:Da}),(a,e)=>{const t=S,l=T,n=z,i=d,s=M,r=I,p=c,_=E,b=m,f=u,g=w("bt-loading");return y(),h("div",null,["ltd"===x(na).authType?(y(),h("div",W,[v(b,null,{"header-left":k((()=>[v(t,{type:"primary",onClick:e[0]||(e[0]=a=>xa()),disabled:x(wa)},{default:k((()=>[e[9]||(e[9]=C("添加备份任务 ")),x(wa)?(y(),h("i",Y)):V("",!0)])),_:1},8,["disabled"])])),"header-right":k((()=>[j("div",Z,[e[10]||(e[10]=j("span",{class:"h-[3rem] bg-[#e8e8e8] leading-[3rem] text-center w-[6rem] inline-block"},"数据库",-1)),v(n,{onChange:qa,modelValue:x(ga).db_name,"onUpdate:modelValue":e[1]||(e[1]=a=>x(ga).db_name=a),class:"rounded-none !w-[12rem]"},{default:k((()=>[v(l,{label:"全部",value:"all"}),(y(!0),h(q,null,D(x(ya),((a,e)=>(y(),A(l,{key:e,label:a.name,value:a.name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])])),content:k((()=>[B(v(i,{ref:"incrementBackupTable","max-height":420,data:x(pa),column:Va},null,8,["data"]),[[g,x(ra)],[g,"正在加载列表，请稍后...","title"]])])),"footer-right":k((()=>[v(s,{page:x(ga).p,"onUpdate:page":e[2]||(e[2]=a=>x(ga).p=a),row:x(ga).limit,"onUpdate:row":e[3]||(e[3]=a=>x(ga).limit=a),onChange:qa,total:x(_a)},null,8,["page","row","total"])])),popup:k((()=>[v(p,{title:"查看日志",modelValue:x(da),"onUpdate:modelValue":e[5]||(e[5]=a=>R(da)?da.value=a:null),area:[76]},{default:k((()=>[j("div",$,[j("div",aa,[v(t,{type:"primary",onClick:e[4]||(e[4]=a=>va(x(oa),!0))},{default:k((()=>e[11]||(e[11]=[C("刷新日志")]))),_:1}),v(t,{onClick:ka},{default:k((()=>e[12]||(e[12]=[C("清空日志")]))),_:1})]),v(r,{class:"!h-[46rem]",content:x(ca),fullScreen:{title:"全屏查看日志",onRefresh:()=>va(x(oa))}},null,8,["content","fullScreen"])])])),_:1},8,["modelValue"]),v(p,{title:"备份记录",modelValue:x(ba),"onUpdate:modelValue":e[6]||(e[6]=a=>R(ba)?ba.value=a:null),area:70},{default:k((()=>[j("div",ea,[v(i,{"max-height":"400",column:ja,data:x(fa)},null,8,["data"]),e[13]||(e[13]=j("ul",{class:"mt-8px leading-8 text-[1.2rem] list-disc ml-20px"},[j("li",{class:"text-danger"},"恢复：会从最早【全量备份】开始恢复至选择的【增量备份】时间点")],-1))])])),_:1},8,["modelValue"]),v(p,{title:"导出结果",modelValue:x(ua),"onUpdate:modelValue":e[8]||(e[8]=a=>R(ua)?ua.value=a:null),area:44},{default:k((()=>[v(_,{class:"w-full",icon:x(ma).path?"success":"error",title:x(ma).path?"导出成功":"导出失败"},{extra:k((()=>[j("div",ta,[j("span",null,U(x(ma).name),1),j("div",null,[v(t,{type:"text",onClick:e[7]||(e[7]=a=>{return e=x(ma).name,o({value:e});var e})},{default:k((()=>e[14]||(e[14]=[C(" 复制 ")]))),_:1}),v(t,{class:"!ml-4px",type:"text",onClick:Ca},{default:k((()=>e[15]||(e[15]=[C("下载")]))),_:1})])])])),_:1},8,["icon","title"])])),_:1},8,["modelValue"])])),_:1}),e[16]||(e[16]=j("ul",{class:"mt-[8px] leading-8 text-[1.2rem] list-disc ml-[20px]"},[j("li",null,"备份大小：备份大小包含完全备份数据大小和增量备份数据大小"),j("li",null,"备份会保留一个星期的备份数据，当备份时，检测到完全备份为一个星期前，会重新完全备份"),j("li",null,"请勿同一时间添加多个备份任务，否则可能因同一时间执行多个备份任务导致文件句柄数打开过多或者爆内存")],-1))])):(y(),A(f,{key:1,data:ha,class:"p-20px"}))])}}});export{la as _};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
