import{R as e,ah as a,o as t,G as l,a7 as n,aa as s,j as i,k as o,V as c,O as u,b as r,e as d}from"./utils-lib.js?v=1734676359";import{_ as p}from"./index90.js?v=1734676359";import{_ as m}from"./index99.js?v=1734676359";import{c as w,r as v,h,i as f,e as _,y,I as b,o as g,B as j,C as x,p as V,k,l as C,J as M,z as q,M as H,x as R,q as z,aj as D,n as E,A as I}from"./base-lib.js?v=1734676359";import{a as O,g as U,u as P,c as A}from"./column.js?v=1734676359";import{getTamperRuleByPath as B,addWhiteDirs as G,addWhiteFiles as J,releaseWhiteDirname as S,releaseWhiteFileExt as T,getActionLogsForDirname as W,getActionLogsForFilename as F,setWhiteDirWithPs as K,removeWhiteDirs as L,removeWhiteFiles as N}from"./site.js?v=1734676359";import{v as Q}from"./useController3.js?v=1734676359";import{u as X}from"./useStore7.js?v=1734676359";import{_ as Y}from"./masker.vue_vue_type_script_setup_true_lang.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";import"./index91.js?v=1734676359";import"./validator.js?v=1734676359";import"./index116.js?v=1734676359";import"./index.vue_vue_type_style_index_0_scoped_03ce946a_lang.js?v=1734676359";const Z={class:"flex gap-col-1rem"},$=d(w({__name:"white-list",props:{compData:{default:{}}},setup(d,{expose:w}){const{siteInfo:$}=X(),ee=r(),ae=v("dir"),te=v(),le=v(!1),ne=v(""),se=v(!1),ie=v({}),oe=v([]);v(!1),v(!1),v(),v(!1),h({sites:[],list:[]}),h({isRecurrence:!1,describe:{title:"",th:"",message:"",propsValue:""}});const ce=f((()=>"dir"===ae.value?[{content:_(b,null,[y("此处允许使用全路径或目录名或路径的一部分如："),_("code",null,[y("/www/abc/cache/test/,test,cache/test/")])])},{content:_(b,null,[y("全路径首位必需为"),_("code",null,[y("/")]),y("，如："),_("code",null,[y("/www/abc/cache/test/")])])},{content:_(b,null,[y("录名或路径的一部分首位不能是"),_("code",null,[y("/")]),y("，如："),_("code",null,[y("cache/test/")]),y("或"),_("code",null,[y("test")])])},{content:_(b,null,[y("例1："),_("code",null,[y("/www/abc/")]),y("匹配:"),_("code",null,[y("/www/abc/*")]),y("不匹配："),_("code",null,[y("/www/abc")]),_("code",null,[y("/www/abc123")])])},{content:_(b,null,[y("例2："),_("code",null,[y("test")]),y("匹配："),_("code",null,[y("/www/test/1.txt")]),_("code",null,[y("/www/test_abc")]),y("不匹配："),_("code",null,[y("/www/1.php")])])},{content:_(b,null,[y("例3："),_("code",null,[y("cache/test/")]),y("匹配："),_("code",null,[y("/www/cache/test/1.txt")]),_("code",null,[y("/cache/test/")]),y("不匹配："),_("code",null,[y("/www/cache/test")]),_("code",null,[y("/cache/")])])}]:[{content:"支持以下5种方式"},{content:_(b,null,[y("1、完整文件路径，如："),_("code",null,[y("/www/wwwroot/test/123.php")])])},{content:_(b,null,[y("2、相对于网站的相对路径，如：全路径是"),_("code",null,[y("/www/wwwroot/test/app/123.php")]),y("相对路径"),_("code",null,[y("./app/123.php")])])},{content:_(b,null,[y("3、指定目录下的所有文件，如："),_("code",null,[y("/www/wwwroot/test/app/*")]),y("相对路径"),_("code",null,[y("./app/*")])])},{content:_(b,null,[y("4、指定目录下的指定文件类型，如："),_("code",null,[y("/www/wwwroot/test/app/*.php")]),y("相对路径"),_("code",null,[y("./app/*.php")])])},{content:_("span",{class:"text-danger"},[y("注意，已经在【受保护的文件类型】中被包含的文件无需专门设置规则")])}])),ue=async(e,a,t,l)=>{const n="dir"===ae.value,s=n?"目录":"文件",{label:i,value:o}=l,c=new Map([["start","批量开启选中的".concat(s,"白名单")],["stop","批量关闭选中的".concat(s,"白名单")],["delete","批量删除选中的".concat(s,"白名单")]]),u=async(e,a)=>{const t=new Map([["start",n?S:T],["stop",n?S:T],["delete",n?L:N]]).get(o);let l={path_id:ie.value.pid,[n?"dirname":"filename"]:e[n?"dir":"filename"]};switch(o){case"start":case"stop":return l.release="start"===o?1:0,t(l);case"delete":return l.path=ie.value.path,t(l)}};await e({title:"批量".concat(i),content:"".concat(c.get(o),"，是否继续操作？"),column:[{prop:"".concat(n?"dir":"filename"),label:"".concat(n?"文件全路径 或 相对路径":"文件类型")},A()],onConfirm:async()=>(await a(u),me(),!1)})},re=()=>v([{label:"开启".concat("dir"==ae.value?"目录":"文件","白名单"),value:"start",event:ue},{label:"关闭".concat("dir"==ae.value?"目录":"文件","白名单"),value:"stop",event:ue},{label:"删除".concat("dir"==ae.value?"目录":"文件","白名单"),value:"delete",event:ue}]),de=()=>v([O(),{label:"dir"==ae.value?"目录":"文件名",prop:"dir"==ae.value?"dir":"filename"},"dir"==ae.value?U({minWidth:150,width:300,request:_e}):{label:"备注",prop:"ps"},{label:"状态",prop:"limit_status",width:50,render:e=>{let a=1===e.limit_status;return _(D,{size:"small",modelValue:a,"onUpdate:modelValue":e=>a=e,onChange:a=>ve(e,a)},null)}},P([{title:"日志",onClick:fe},{title:"删除",onClick:he}])]),pe=v([{label:"目录白名单",name:"dir",lazy:!0,render:()=>_("span",null,null)},{label:"文件白名单",name:"file",lazy:!0,render:()=>_("span",null,null)}]),me=async(t=!1)=>{var l,n;try{t&&(le.value=!0);const{data:a}=await B({path:$.value.path});let s=[];if(a.hasOwnProperty("status"))if(ie.value=a,"dir"==ae.value)null==(l=null==a?void 0:a.unused_white_dirs)||l.forEach((e=>{s.push({...e,ps:e.ps||"",limit_status:0})})),null==(n=null==a?void 0:a.white_dirs)||n.forEach((t=>{var l;let n={...t,ps:t.ps||"",limit_status:1},i=null==(l=null==a?void 0:a.temporarily_dirs)?void 0:l.find((e=>e.value===t.dir));i&&(n.time=i.time,n.ps="临时放行截止至"+e(i.time,"yyyy-MM-dd HH:mm:ss")),s.push(n)}));else{let t=a.white_files;a.unused_white_files.forEach((e=>{s.push({filename:e,limit_status:0,ps:"-"})})),t.forEach((t=>{var l;let n={filename:t,limit_status:1,ps:"-"},i=null==(l=null==a?void 0:a.temporarily_files)?void 0:l.find((e=>e.value===t));i&&(n.time=i.time,n.ps="临时放行截止至"+e(i.time,"yyyy-MM-dd HH:mm:ss")),s.push(n)}))}oe.value=s}catch(s){a(s)}finally{t&&(le.value=!1)}},we=async()=>{if(""===ne.value)return ee.error("文件类型不能为空");try{const e="dir"==ae.value?await G({path_id:ie.value.pid,path:ie.value.path,dirnames:ne.value}):await J({path_id:ie.value.pid,path:ie.value.path,filename:ne.value});ee.request(e),e.status&&(ne.value="",me())}catch(e){}},ve=async(e,a)=>{const n="dir"==ae.value;try{if(e.hasOwnProperty("time"))return void E((()=>{e.limit_status=!a,ee.error("临时放行文件无法修改状态")}));e.limit_status=a?1:0,await t({title:"".concat(a?"开启":"关闭","【").concat(e.filename,"】"),content:"".concat(a?"开启该文件白名单后，该文件将不被保护，是否继续？":"关闭该文件白名单后，该文件将被保护，是否继续？")});const s={path_id:ie.value.pid,[n?"dirname":"filename"]:e[n?"dir":"filename"],release:a?1:0},i=n?S:T;(await l({loading:"正在设置白名单状态，请稍后...",request:i(s),message:!0})).status&&me()}catch(s){"cancel"===s&&(e.limit_status=a?0:1)}},he=async e=>{let a="dir"===ae.value,n=a?"目录":"文件";await t({title:"删除【".concat(a?e.dir:e.filename,"】"),content:"删除该".concat(n,"白名单后，该").concat(n,"将受到保护，是否继续操作？")});const s={path_id:ie.value.pid,path:ie.value.path,[a?"dirname":"filename"]:e[a?"dir":"filename"]},i=a?L:N;(await l({loading:"正在删除".concat(n,"白名单，请稍后..."),request:i(s),message:!0})).status&&me()},fe=async e=>{var t;const l="dir"===ae.value;try{const a={path_id:ie.value.pid,[l?"dirname":"filename"]:e[l?"dir":"filename"],row:10,pid:ie.value.pid,p:1},s=l?W:F,{data:i}=await s(a);(null==(t=i.data)?void 0:t.length)?Q({title:"".concat("dir"===ae.value?"目录【".concat(e.dir,"】"):"文件【".concat(e.filename,"】"),"白名单日志"),row:e,data:i,params:{...a,total:n(i.page)}}):ee.error("暂无日志")}catch(s){a(s)}},_e=async(e,a)=>{l({loading:"正在修改备注信息，请稍后...",request:K({path_id:ie.value.pid,dir_name:e.dir,ps:a}),message:!0})},ye=de(),be=re(),ge=e=>{ne.value="",ae.value=e,ye.value=de().value,be.value=re().value,oe.value=[],me()};return g((()=>{me(!0)})),w({init:()=>{me(!0)}}),(e,a)=>{var t;const l=s,n=i,r=I,d=m,w=o,v=c,h=p,f=u,b=j("bt-loading");return x((k(),C("div",null,[(null==(t=V(ie))?void 0:t.path)?q("",!0):(k(),M(Y,{key:0,compData:{...e.compData,init:me}},null,8,["compData"])),_(l,{ref:"tamperRef",type:"",modelValue:V(ae),"onUpdate:modelValue":a[0]||(a[0]=e=>H(ae)?ae.value=e:null),options:V(pe),onChange:ge},null,8,["modelValue","options"]),_(h,null,{"header-left":R((()=>[z("div",Z,[_(n,{modelValue:V(ne),"onUpdate:modelValue":a[1]||(a[1]=e=>H(ne)?ne.value=e:null),width:"30rem",placeholder:"".concat("dir"===V(ae)?"目录名":"文件名")},null,8,["modelValue","placeholder"]),_(r,{type:"primary",onClick:we},{default:R((()=>a[2]||(a[2]=[y("添加")]))),_:1})])])),"header-right":R((()=>[_(d,{onRefresh:me})])),content:R((()=>[x(_(w,{ref_key:"whiteTableRef",ref:te,column:V(ye),maxHeight:350,data:V(oe)},null,8,["column","data"]),[[b,V(se)]])])),"footer-left":R((()=>[_(v,{"table-ref":V(te),options:V(be)},null,8,["table-ref","options"])])),"footer-right":R((()=>a[3]||(a[3]=[]))),_:1}),_(f,{options:V(ce),class:"ml-2rem mt-2rem tamper-help-info leading-2rem"},null,8,["options"])])),[[b,V(le)],[b,"正在获取站点防篡改信息，请稍侯","title"]])}}}),[["__scopeId","data-v-6f1da782"]]);export{$ as default};
