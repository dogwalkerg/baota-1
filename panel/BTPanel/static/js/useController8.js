import{closeLimitNet as e,setLimitNet as a,setModulesLimitNet as t,setMultipleLimitNet as s,getLimitNet as l,getModulesLimitNet as i,setLimitStatus as r,setLimitConfig as u,getPluginInfo as n,removeFlowRule as o,createFlowRule as v,getGeneratedFlowInfo as p,getLimitConfig as m}from"./site.js?v=1734676359";import{G as d,M as c,o as y,t as _,ah as h}from"./utils-lib.js?v=1734676359";import{r as g,h as f}from"./base-lib.js?v=1734676359";import{c as b}from"./useController3.js?v=1734676359";import{u as w}from"./useStore7.js?v=1734676359";import{p as j,h as q}from"./validator.js?v=1734676359";const{siteInfo:x,siteType:N,isBindExtranet:O,isRefreshList:E,selectedList:I}=w(),L=g([{label:"论坛/博客",value:0,items:{perserver:300,perip:25,limit_rate:512}},{label:"图片站",value:1,items:{perserver:200,perip:10,limit_rate:1024}},{label:"下载站",value:2,items:{perserver:50,perip:3,limit_rate:2048}},{label:"商城",value:3,items:{perserver:500,perip:10,limit_rate:2048}},{label:"门户",value:4,items:{perserver:400,perip:15,limit_rate:1024}},{label:"企业",value:5,items:{perserver:60,perip:10,limit_rate:512}},{label:"视频",value:6,items:{perserver:150,perip:4,limit_rate:1024}},{label:"自定义",value:7,items:{perserver:"",perip:"",limit_rate:""}}]),P=async(a,t)=>{if(!S)if(a)B(t);else{const a={["php"!==N.value?"site_id":"id"]:x.value.id};(await d({loading:"正在关闭流量限制，请稍后...",request:e(a,N.value),message:!0})).status&&await C()}},B=async e=>{try{if(!S){const s=["php","proxy","phpasync"].includes(N.value),{perserver:l,perip:i,limit_rate:r}=e,u={perserver:l,perip:i,limit_rate:r,[s?"id":"site_id"]:x.value.id};return void((await d({loading:"正在设置流量，请稍后...",request:s?a(u):t(u,N.value),message:!0})).status&&C())}let l=c.load("正在设置，请稍后..."),i=[],r=[];return I.value.forEach((e=>{var a;"PHPMOD"===(null==(a=null==e?void 0:e.project_config)?void 0:a.type)?i.push({name:e.name,msg:"异步项目不支持",status:!1}):r.push(e.id)})),(null==r?void 0:r.length)&&await d({request:s({...J,close_limit_net:J.value?0:1,site_ids:JSON.stringify(r)}),success:e=>{[...e.data.errors,...e.data.succeed].forEach((e=>{var a,t;i.push({...e,name:(null==(t=null==(a=I.value)?void 0:a.find((a=>a.id===e.id)))?void 0:t.name)||""})}))}}),b({resultData:i}),I.value=[],l.close(),E.value=!0,!0}catch(l){return!1}},C=async()=>{try{const e=["php","proxy","phpasync"].includes(N.value),a={[e?"id":"site_id"]:x.value.id},t=await d({loading:R,request:e?l(a):i(a,N.value)});return t.data.hasOwnProperty("limit_rate")?(k.value=!1,J.limit_rate=t.data.limit_rate,J.perserver=t.data.perserver,J.perip=t.data.perip,Object.values(t.data).every((e=>0===e))?(J.value=!1,J.type=0,M(0)):(J.type=t.data.value-1,J.value=!0),-1===J.type&&(J.type=7),J):(k.value=!0,c.error("获取流量限制失败"),k.value=!0,H.value=t.data.msg,{status:!1,msg:"获取流量限制失败"})}catch(e){return{status:!1,msg:"获取流量限制失败"}}},D=async()=>{var e,a;try{let t=null==(e=x.value.project_type)?void 0:e.toLowerCase();if("node"===t&&(t="nodejs"),"nodejs"===t){if(O.value=null==(a=x.value.project_config)?void 0:a.bind_extranet,!O.value)return k.value=!0,J}else O.value=!0;return S?await M(0):await C(),J}catch(t){}},M=e=>{const{perserver:a,perip:t,limit_rate:s}=L.value[e].items;J.perserver=a,J.perip=t,J.limit_rate=s},S=Boolean(I.value.length),k=g(!1),G=g(!1),H=g(""),J=f({value:!0,perserver:300,perip:25,limit_rate:512,type:0}),R=g(!1),T=async e=>{try{let a={...e,site_name:x.value.name,module:e.module.join(",")};"request"===e.type&&(a.limit_unit="frequency"),delete a.type;const t=await d({loading:"正在添加流量限额配置，请稍后...",request:v(a),message:!0});return t.status&&(X.value=!0),t.status}catch(a){return!1}},z=async e=>{const a=!e.limit_status;await y({title:(a?"开启":"关闭")+"流量限额配置",icon:"warning-filled",content:(a?"开启":"关闭")+"检测到问题时将"+(a?"会":"不会")+"发送告警通知，是否继续？"}),await d({loading:"正在设置，请稍后...",request:r({id:e.id,limit_status:a,site_name:x.value.name}),message:!0}),X.value=!0},A=async()=>{try{const{data:e}=await u({sName:"total"});Q.value=e,e.nginx_status&&e.total_status||(G.value=!0)}catch(e){}},F=async()=>{try{const{data:e}=await n({sName:"total"});return G.value=!(e.setup&&e.endtime>=0),e.setup&&e.endtime>0?((async()=>{R.value=!0;try{const{data:e}=await p({site_name:x.value.name});W.value.length=_(Number(e.length)),W.value.request=_(Number(e.request))}catch(e){h(e)}finally{R.value=!1}})(),await(async()=>{try{const e=await m({site_name:x.value.name});return{data:e.data,total:e.data.length,other:{}}}catch(e){h(e)}})()):{data:[],total:0,other:{}}}catch(e){return{data:[],total:0,other:{}}}},K=async e=>{await y({title:"删除",icon:"warning-filled",content:"是否删除此条流量限额配置？"}),await d({loading:"正在删除，请稍后...",request:o({site_name:x.value.name,id:e.id}),message:!0}),X.value=!0},Q=g({nginx_status:!1,total_status:!1,buy_status:!1}),U=[{label:"1小时",value:"1h"},{label:"1天",value:"1day"},{label:"30天",value:"30day"},{label:"自然月",value:"month"}],V=[{label:"10分钟",value:"10m"},{label:"30分钟",value:"30m"}],W=g({length:"--",request:"--"}),X=g(!1),Y=async e=>{if("buy"===e)j({sourceId:142});else try{const{data:e}=await n({sName:"total"});await q({name:e.name,type:"i",pluginInfo:e})}catch(a){}};export{H as a,S as b,z as c,K as d,G as e,Q as f,F as g,P as h,D as i,Y as j,V as k,U as l,k as m,T as n,B as o,L as p,X as q,A as r,W as t,R as v};
