import{H as e}from"./utils-lib.js?v=1734676359";import{j as l,k as a,g as t,b as r,l as o,s}from"./api.js?v=1734676359";import{a as i,t as d}from"./store6.js?v=1734676359";import{c as n,p as u,r as p,h as c,o as m,B as v,k as f,l as b,e as P,x as y,y as g,q as h,C as w,M as _}from"./base-lib.js?v=1734676359";import"./__commonjsHelpers__.js?v=1734676359";const C={class:"p-2rem"},V=n({__name:"rules-table",props:{dependencies:{default:()=>({})}},setup(n,{expose:V}){const k=n,{BtDialog:A,ElButton:B,BtTable:x,BtInput:j,BtTableGroup:E,ElTooltip:I,ElForm:T,ElFormItem:F}=u(k.dependencies.components),{useAxios:R,useMessage:D,useConfirm:U,useDialog:q}=u(k.dependencies.hooks),{setPortConfig:H,useOperate:L,portsPs:O}=u(k.dependencies.custom),S=D(),M=p(!1),G=p(!1),z=p([]),J=p(!1),K=p(!1),N=p(),Q=c({Port:"",CidrBlock:"",ps:""}),W=p(!1),X=p(!1),Y=c({Port:[{required:!0,message:"请输入端口",trigger:"blur"}],ps:[{validator:(e,l,a)=>{l&&(null==l?void 0:l.length)>60?a(new Error("备注不能超过60个字符")):a()},trigger:["blur","change"]}]}),Z=async e=>{await U({icon:"warning",title:"删除防火墙规则",content:"删除后可能导致服务无法访问，是否继续操作？"});try{const a=S.load("正在删除防火墙规则，请稍后..."),t=e;delete t.FirewallRuleDescription;const r=await l(t);a.close(),S.request(r),r.status&&ee()}catch(a){}},$=()=>{W.value||X.value?te():(M.value=!0,ee())},ee=async()=>{W.value=!1;try{G.value=!0;const e=await a();X.value=!Array.isArray(e.data.FirewallRuleSet),z.value=Array.isArray(e.data.FirewallRuleSet)?e.data.FirewallRuleSet:[]}catch(e){W.value=!0}finally{G.value=!1}},le=()=>({label:"端口",prop:"Port",renderHeader:()=>{return e="防火墙会加载系统所有端口信息，IPV6端口无法与IPV4分开管理，非必要勿删除IPV6端口",P("div",null,[P("span",null,["端口"]),P(I,{content:e,placement:"top"},{default:()=>[P("span",{class:"ml-4x bt-ico-ask"},["?"])]})]);var e},width:300,render:e=>{e.brief=e.brief||O[e.Port];const l=z.value.some((l=>l.Port===e.Port)),a=["20","21","22","80","443","8888","3306"].includes(e.Port);return P("div",null,[P("span",{class:"mr-[1rem]"},[e.Port+("ipv6"===e.Family?"（ipv6）":"")]),l||a?"":P("span",{class:"bt-link cursor-pointer",onClick:()=>{var l;ae({Port:e.Port,CidrBlock:"all"!==e.Address?e.Address:"",ps:null==(l=e.brief)?void 0:l.substring(0,60)})}},[g("点击放行，腾讯云轻量云防火墙端口")])])}}),ae=e=>{W.value||X.value?te():(oe(),K.value=!!e,e&&Object.assign(Q,e),J.value=!0)},te=l=>{(l=l||{}).alert=W.value?"当前密钥错误，请重新关联API密钥":"",q({isAsync:!0,component:()=>e((()=>import("./config3.js?v=1734676359")),__vite__mapDeps([]),import.meta.url),title:!1,area:[48],compData:{...l,dependencies:k.dependencies}})},re=async()=>{try{await N.value.validate();const e=S.load("正在添加防火墙规则，请稍后..."),l={...Q,Protocol:"ALL",ActionType:"ACCEPT",CidrBlock:Q.CidrBlock||"0.0.0.0/0"},a=await o(l);e.close(),S.request(a),a.status&&(J.value=!1,ee())}catch(e){}},oe=()=>{Q.Port="",Q.CidrBlock="",Q.ps=""},se=p([{label:"应用类型",prop:"AppType"},{label:"来源",prop:"CidrBlock"},{label:"协议",prop:"Protocol",width:150},{label:"端口",prop:"Port",width:120},{label:"策略",prop:"Action",width:60,render:e=>{const l="ACCEPT"===e.Action;return P("span",{class:l?"text-primary":"text-danger"},[l?"允许":"拒绝"])}},L([{onClick:Z,isHide:()=>1===z.value.length,title:"删除"}])]);return m((async()=>{s(R),await(async()=>{try{const{data:e}=await t();!1===(null==e?void 0:e.status)&&(null==e?void 0:e.msg)&&(X.value=!0);const{data:l}=await r();i.value=l,d.value="cvm"===l.server_type}catch(e){}})(),await ee(),H(le())})),V({getPortConfig:le}),(e,l)=>{const a=v("bt-loading");return f(),b("div",null,[P(u(B),{type:"default",class:"!mr-[1rem]",onClick:$},{default:y((()=>l[6]||(l[6]=[g("轻量云防火墙规则")]))),_:1}),P(u(A),{title:"轻量云防火墙规则",modelValue:u(M),"onUpdate:modelValue":l[1]||(l[1]=e=>_(M)?M.value=e:null),area:[80]},{default:y((()=>[h("div",C,[P(u(E),null,{"header-left":y((()=>[P(u(B),{type:"primary",onClick:l[0]||(l[0]=e=>ae())},{default:y((()=>l[7]||(l[7]=[g("添加规则")]))),_:1})])),"header-right":y((()=>l[8]||(l[8]=[]))),content:y((()=>[w(P(u(x),{ref:"ftpTable",column:u(se),data:u(z),description:"列表为空","max-height":360},null,8,["column","data"]),[[a,u(G)],[a,"正在加载轻量云防火墙规则列表，请稍后...","title"]])])),_:1})])])),_:1},8,["modelValue"]),P(u(A),{title:"添加轻量云防火墙规则",modelValue:u(J),"onUpdate:modelValue":l[5]||(l[5]=e=>_(J)?J.value=e:null),"show-footer":!0,area:[48],onConfirm:re},{default:y((()=>[P(u(T),{ref_key:"addRulesformRef",ref:N,class:"p-2rem",model:u(Q),rules:u(Y)},{default:y((()=>[P(u(F),{label:"端口",prop:"Port"},{default:y((()=>[P(u(j),{modelValue:u(Q).Port,"onUpdate:modelValue":l[2]||(l[2]=e=>u(Q).Port=e),width:"30rem",disabled:u(K),placeholder:"端口范围1到65535之间，支持端口放行范围80-90"},null,8,["modelValue","disabled"])])),_:1}),P(u(F),{label:"允许访问IP"},{default:y((()=>[P(u(j),{modelValue:u(Q).CidrBlock,"onUpdate:modelValue":l[3]||(l[3]=e=>u(Q).CidrBlock=e),width:"30rem",disabled:u(K),placeholder:"默认为空，表示所有来源，支持IP网段，可为空"},null,8,["modelValue","disabled"])])),_:1}),P(u(F),{label:"备注",prop:"ps"},{default:y((()=>[P(u(j),{modelValue:u(Q).ps,"onUpdate:modelValue":l[4]||(l[4]=e=>u(Q).ps=e),rows:4,type:"textarea",width:"30rem",placeholder:"备注和说明，可为空"},null,8,["modelValue"])])),_:1}),P(u(F),{label:""},{default:y((()=>l[9]||(l[9]=[h("ul",{class:"pl-[4rem] list-disc text-[#777] leading-[2.4rem] text-12px"},[h("li",null,"支持添加多个端口，如：80,88"),h("li",null,"支持添加多个端口范围，如：80,88,90-99,110-120")],-1)]))),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue"])])}}});export{V as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
