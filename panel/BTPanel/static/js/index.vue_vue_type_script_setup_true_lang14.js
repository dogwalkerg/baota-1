var t,a,e,r,s,l,o,n,i;import{G as u,M as d,ah as p,o as c,bX as v,l as m,H as y,an as _,r as g,D as x,aO as f,j as h}from"./utils-lib.js?v=1734676359";import{g as w,s as j,r as E,h as b,c as P,ax as S,o as k,k as T,l as V,q as C,y as q,e as F,p as O,M as L,v as N,x as I,z as J,i as U,Q as A,aj as D,A as M}from"./base-lib.js?v=1734676359";import{B as R}from"./index353.js?v=1734676359";import{k as H,n as B}from"./form-item.js?v=1734676359";import{p as X}from"./useController3.js?v=1734676359";import{u as z,S as $}from"./useStore7.js?v=1734676359";import{setJavaStaticFile as G,getPortStatus as Q,removeServerProxy as K,bindExtranet as W,unbindExtranet as Y,modifyServerProxy as Z,addServerProxy as tt}from"./site.js?v=1734676359";import{f as at}from"./validator.js?v=1734676359";const et=w("SITE-EXTERNAL-MAP-STORE",(()=>{const{siteInfo:t,siteType:a}=z();return{isRefreshPortList:E(!1),setStaticFileEvent:async a=>{try{const{status:e,index:r,path:s}=a,l=await u({loading:"正在设置静态文件...",request:G({status:e?1:0,index:r,path:s,project_name:t.value.name}),message:!0});return{status:l.status,msg:l.msg}}catch(e){return{status:!1,msg:"设置静态文件失败"}}},getJavaPortData:async()=>{try{const a=await Q({project_name:t.value.name});return Array.isArray(a.data.data)?{data:a.data.data,total:a.data.data.length,other:{}}:{data:[],total:0,other:{}}}catch(a){return{data:[],total:0,other:{}}}},deleteProxyEvent:async t=>{try{const a=await u({loading:"正在删除反向代理映射...",request:K(t),message:!0});return{status:a.status,msg:a.msg}}catch(a){return{status:!1,msg:"删除代理失败"}}},changeStatusEvent:async(t,{status:e})=>{let r=d.load("正在修改状态，请稍后...");try{let r=a.value;const s=e?W:Y,{data:l}=await s(t,r),o=l.msg||l.data||l.error_msg;return{status:l.status,msg:o}}catch(s){return{status:!1,msg:"修改状态失败"}}finally{r.close()}},saveProxyMapEvent:async(t,a)=>{try{const e=await u({loading:"正在操作中，请稍后...",request:a?Z(t):tt(t)});return{msg:e.msg,status:e.status}}catch(e){p(e)}}}})),{activeType:rt,siteInfo:st,siteType:lt,rowData:ot}=z(),{getFileEvent:nt,saveFileEvent:it,setSiteInfo:ut,getProjectConfig:dt,jumpTabEvent:pt}=$(),{isRefreshPortList:ct}=j(et()),{setStaticFileEvent:vt,deleteProxyEvent:mt,getJavaPortData:yt,saveProxyMapEvent:_t,changeStatusEvent:gt}=et(),xt=b({status:null==(e=null==(a=null==(t=st.value)?void 0:t.project_config)?void 0:a.static_info)?void 0:e.status,index:(null==(l=null==(s=null==(r=st.value)?void 0:r.project_config)?void 0:s.static_info)?void 0:l.index)||"index.html",path:(null==(i=null==(n=null==(o=st.value)?void 0:o.project_config)?void 0:n.static_info)?void 0:i.path)||"",popup:!1}),ft=E(!1),ht=E(!1),wt=E(!1),jt=async()=>{try{let{project_type:t,name:a}=st.value,e="python"===t?{name:a}:{project_name:a};const r=await dt(e);if(r.status&&r.data.name){const{project_config:a}=r.data;ft.value=!!a.bind_extranet,ht.value="springboot"!==a.java_type&&"java"===t,a&&ut(r.data)}}catch(t){return{status:!1,msg:"获取域名信息失败"}}},Et=t=>{let a=t.split("\n").filter((t=>""!==t)),e=[];return a.forEach((t=>{let a=t.split("=");e.push({k:a[0],v:a[1]})})),e},bt=t=>"".concat(t,"/").replace(/\s+/g,"").replace(/\/\//g,"/"),Pt=async t=>{try{const a=lt.value;"java"!==a&&(ft.value=!t,await c({width:40,title:"外网映射",content:"".concat(t?"开启":"关闭","外网映射后，").concat(t?"可以通过绑定域名进行访问":"已绑定域名将取消关联访问","，是否继续操作？"),icon:"warning-filled"}));const{name:e,project_config:r}=st.value,s={python:{data:JSON.stringify({name:e})},java:{data:JSON.stringify({project_name:e})},default:{data:JSON.stringify({project_name:e,domains:r.domains})}},l=s[a]||s.default,o=await gt(l,{status:t});d.request(o),o.status&&(jt(),ct.value=!0),St(o)}catch(a){p(a)}},St=t=>{var a,e,r,s,l;const o=lt.value;if("java"===o&&t.msg.includes("域名")){ft.value=!1;const a=()=>{pt("domain")};d.msg({message:"".concat(t.msg,'，<span class="text-primary cursor-pointer go-domains">前往添加域名</span>'),duration:3e3,dangerouslyUseHTMLString:!0,type:"error",onClose:()=>{a&&window.removeEventListener("click",a)}}),a&&window.addEventListener("click",a,{once:!0})}else"java"!==o?t.status||t.data.status?d.success((null==(a=t.data)?void 0:a.msg)||(null==(e=t.data)?void 0:e.data)||t.msg):d.error((null==(r=t.data)?void 0:r.error_msg)||(null==(s=t.data)?void 0:s.msg)||(null==(l=t.data)?void 0:l.data)):d.request(t)},kt=async(t,a)=>{var e,r;if((null==(r=null==(e=st.value.project_config)?void 0:e.static_info)?void 0:r.status)&&"/"===t.value.proxy_dir)return d.error("项目已存在根路由【/】配置，无法设置该代理目录"),!1;await a();try{if(!t.value.status&&t.value.proxy_id)return wt.value=!1,(async t=>{const a={proxy_id:t.proxy_id,site_name:st.value.name},e=await mt(a);return e.status&&(ct.value=!0),e.status})(t.value);{t.value.rewrite.src_path=bt(t.value.rewrite.src_path),t.value.rewrite.target_path=bt(t.value.rewrite.target_path);let a=(t=>{let a={...t,status:t.status?1:0,site_name:st.value.name,rewrite:JSON.stringify(t.rewrite),add_headers:JSON.stringify(Et(t.add_headers))};return a.isEdit||delete a.proxy_id,delete a.isEdit,a})(t.value);const e=await _t(a,t.value.isEdit);return d.request(e),e.status&&(wt.value=!1,ct.value=!0),e.status}}catch(s){}},Tt={class:"flex flex-col"},Vt={class:"flex items-center"},Ct={key:0},qt={key:0,class:"flex items-center"},Ft={class:"mt-[8px] leading-8 text-[1.2rem] list-disc ml-[20px]"},Ot={key:0,class:"text-danger"},Lt=P({__name:"index",setup(t,{expose:a}){const{siteType:e,siteInfo:r}=j($()),{isRefreshPortList:s}=j(et()),{getJavaPortData:l}=et(),o=S("popupClose"),n=E(!1),{BtTable:i,refresh:u}=v({request:async()=>"java"===e.value?await l():{data:[],total:0},columns:[X(),{label:"防火墙状态",prop:"fire_wall",width:200,render:t=>{var a,e;return F("span",{onClick:()=>{null===t.fire_wall?m({title:"端口规则",area:44,component:()=>y((()=>import("./add-port-rule.js?v=1734676359")),__vite__mapDeps([]),import.meta.url),compData:{...null===t.fire_wall?{port:t.port,isEdit:!1,noNps:!0}:{...t.fire_wall,isEdit:!0,noNps:!0},refreshFn:l},showFooter:!0}):d.msg({message:F("span",null,[q("请前往系统防火墙模块修改，"),F("span",{class:"text-primary cursor-pointer go-firewall",onClick:c},[q("立即前往")])]),duration:2e3,dangerouslyUseHTMLString:!0,type:"error"})},class:(null===t.fire_wall||"drop"===(null==(a=t.fire_wall)?void 0:a.Strategy)?"text-danger":"text-primary")+" cursor-pointer"},[null===t.fire_wall?"未配置":"accept"===(null==(e=t.fire_wall)?void 0:e.Strategy)?"放行":"禁止"])}},{label:"外网映射",prop:"nginx_proxy",showOverflowTooltip:!1,render:t=>{var a,e,r,s,l;return ft.value?F("div",{class:"flex"},[F("span",{onClick:()=>{let a={isEdit:!1,proxy_dir:"",proxy_id:"",proxy_port:"",site_name:"",rewrite:{status:!1,src_path:"",target_path:""},add_headers:"",status:!0};null!==t.nginx_proxy?(a.isEdit=!0,a.proxy_id=t.nginx_proxy.proxy_id,a.proxy_dir=t.nginx_proxy.proxy_dir,a.proxy_port=t.nginx_proxy.proxy_port,a.site_name=t.nginx_proxy.site_name,a.status=!!t.nginx_proxy.status,a.rewrite=t.nginx_proxy.rewrite,a.add_headers=t.nginx_proxy.add_headers.map((t=>"".concat(t.k,"=").concat(t.v))).join("\n")):(a.isEdit=!1,a.proxy_port=t.port),b(a)},class:(null===t.nginx_proxy||0===(null==(a=t.nginx_proxy)?void 0:a.status)?"text-danger":"text-primary")+" cursor-pointer max-w-[26rem] truncate",title:null!==t.nginx_proxy&&(null==(e=t.nginx_proxy)?void 0:e.status)?"已开启，代理路由："+(null==(r=t.nginx_proxy)?void 0:r.proxy_dir):""},[null===t.nginx_proxy?"未配置":(null==(s=t.nginx_proxy)?void 0:s.status)?"已开启，代理路由："+(null==(l=t.nginx_proxy)?void 0:l.proxy_dir):"已停止"])," "]):"请先点击上方启用外网映射后再使用"}}],extension:[_(s)]}),p=t=>({type:"custom",render:a=>(a.value.hasOwnProperty("status")||(a.value.status=!1),F(f,{label:"开启代理"},{default:()=>[F(A,{modelValue:t.value.status,"onUpdate:modelValue":a=>t.value.status=a},null)]}))}),c=()=>{o(),g.push({path:"/firewall/system"})},w=t=>{var a,e,s,l,o,n,i,u,c;if(!ft.value)return d.error("请先点击上方启用外网映射后再使用");const{BtForm:v,submit:y}=x({data:{status:null==(s=null==(e=null==(a=r.value)?void 0:a.project_config)?void 0:e.static_info)?void 0:s.status,index:(null==(n=null==(o=null==(l=r.value)?void 0:l.project_config)?void 0:o.static_info)?void 0:n.index)||"index.html",path:(null==(c=null==(u=null==(i=r.value)?void 0:i.project_config)?void 0:u.static_info)?void 0:c.path)||""},options:t=>{var a,e;return t.value.status=(null==(e=null==(a=r.value.project_config)?void 0:a.static_info)?void 0:e.status)||!1,U((()=>[p(t),{type:"input",label:"默认文档",key:"index",attrs:{placeholder:"请输入内容，用,分割",class:"w-[26rem]"},rules:[{validator:(a,e,r)=>{t.value.status&&""===e?r(new Error("默认文档不能为空")):r()}}]},H("文件路径","path",{attrs:{style:"width: 26rem"},rules:[{validator:(a,e,r)=>{t.value.status&&""===e?r(new Error("文件路径不能为空")):r()}}]},(()=>{at({type:"dir",path:t.value.path,change:a=>{t.value.path=a}})}))]))},submit:async(t,a)=>(await a(),(async t=>{const a=await vt(t);return a.status&&(xt.popup=!1,jt()),a.status})(t.value))});m({title:"设置静态文件【".concat(r.value.name,"】"),area:65,showFooter:!0,component:()=>F(v,{class:"p-2rem"},null),onConfirm:y})},b=t=>{const{BtForm:a,submit:e}=x({data:t,options:t=>U((()=>[p(t),{type:"input",label:"代理目录",key:"proxy_dir",attrs:{width:"26rem",placeholder:"请输入内容，用,分割",onInput:()=>{}},rules:[{required:!0,message:"请输入代理目录",trigger:"blur"}]},{type:"custom",render:a=>F(f,{label:"代理端口",prop:"proxy_port"},{default:()=>[F(R,{modelValue:t.value.proxy_port,"onUpdate:modelValue":a=>t.value.proxy_port=a,"controls-position":"right",class:"!w-[10rem]"},null)]}),rules:{proxy_port:[{required:!0,message:"请输入代理端口",trigger:"blur"},{validator:(t,a,e)=>{/^\d+$/.test(a)?a<0||a>65535?e(new Error("端口号范围为0-65535")):e():e(new Error("端口号必须为数字，范围0-65535"))}}]}},B(n),...n.value?[{type:"textarea",label:"自定义头部",key:"add_headers",attrs:{placeholder:"自定义头部，1行1个,例如：\nX-Client-IP=$remote_addr",class:"!w-[26rem]",width:"26rem",rows:4,resize:"none"}},{type:"custom",render:()=>F(f,{label:"路由重写"},{default:()=>[F(A,{modelValue:t.value.rewrite.status,"onUpdate:modelValue":a=>t.value.rewrite.status=a},null)]})},...t.value.rewrite.status?[{type:"custom",render:()=>F(f,{label:" "},{default:()=>[F("div",{class:"flex items-center"},[F(f,{label:"原路由",prop:"srcPath"},{default:()=>[F(h,{modelValue:t.value.rewrite.src_path,"onUpdate:modelValue":a=>t.value.rewrite.src_path=a,class:"w-[25rem]",placeholder:"原路由,例如：".concat(t.value.proxy_dir,"/").replace(/ /g,"").replace(/\/\//g,"/")},null)]}),F(f,{label:"替换路由",prop:"targetPath",class:"!mt-[0] ml-[1rem]"},{default:()=>[F(h,{modelValue:t.value.rewrite.target_path,"onUpdate:modelValue":a=>t.value.rewrite.target_path=a,class:"w-[25rem]",placeholder:"替换路由,例如：".concat(t.value.proxy_dir,"/xxx/").replace(/ /g,"").replace(/\/\//g,"/")},null)]})])]})}]:[]]:[]])),submit:kt});m({title:"".concat(t.isEdit?"修改反向代理映射【".concat(t.proxy_id,"】"):"添加反向代理映射"),area:50,showFooter:!0,component:()=>F(a,{class:"p-2rem"},null),onConfirm:e})};return k(jt),a({init:()=>{jt(),u()}}),(t,a)=>{var s,l,o;const n=D,u=M;return T(),V("div",Tt,[C("div",Vt,[a[2]||(a[2]=q(" 外网映射 ")),F(n,{modelValue:O(ft),"onUpdate:modelValue":a[0]||(a[0]=t=>L(ft)?ft.value=t:null),class:"ml-[8px]",disabled:O(ht),onChange:O(Pt)},null,8,["modelValue","disabled","onChange"])]),"java"===O(e)?(T(),V("div",Ct,[F(O(i),{class:"my-2rem",maxHeight:450}),"springboot"===(null==(s=O(r).project_config)?void 0:s.java_type)?(T(),V("div",qt,[a[4]||(a[4]=q(" 静态文件： ")),C("span",null,N((null==(o=null==(l=O(r).project_config)?void 0:l.static_info)?void 0:o.status)?"已配置":"未配置"),1),F(u,{class:"!ml-[2rem]",type:"default",onClick:a[1]||(a[1]=t=>w())},{default:I((()=>a[3]||(a[3]=[q(" 设置静态文件 ")]))),_:1})])):J("",!0)])):J("",!0),C("ul",Ft,[a[5]||(a[5]=C("li",null,"如果您的是HTTP项目，且需要外网通过80/443访问，请开启外网映射",-1)),a[6]||(a[6]=C("li",null,"开启外网映射前，请到【域名管理】中至少添加1个域名",-1)),"java"===O(e)?(T(),V("li",Ot,"外网映射开启后可在配置文件中查看修改服务器（Nginx/Apache）的配置文件")):J("",!0)])])}}});export{Lt as _};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
